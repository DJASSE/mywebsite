<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>تتبع العائلة - الجزائر</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- خط -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo&display=swap" rel="stylesheet" />

  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(135deg, #0099ff, #005f99);
      color: white;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    h1 { margin: 20px 0 10px; }
    button {
      padding: 10px 20px;
      margin: 10px;
      border: none;
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    input, select {
      margin: 10px;
      padding: 10px;
      border-radius: 15px;
      border: none;
      width: 80%;
      max-width: 300px;
      font-size: 16px;
    }
    #map {
      height: 400px;
      margin: 15px auto;
      max-width: 500px;
      border-radius: 15px;
    }
  </style>
</head>
<body>

<h1>تتبع العائلة - الجزائر</h1>

<!-- اختيار الدور -->
<div id="roleSelect">
  <h3>اختر دورك:</h3>
  <button onclick="chooseRole('parent')">أنا ولي أمر 👨‍👧‍👦</button>
  <button onclick="chooseRole('child')">أنا طفل 🧒</button>
</div>

<!-- نموذج ولي الأمر -->
<div id="parentForm" style="display:none;">
  <h3>معلومات ولي الأمر</h3>
  <form onsubmit="submitParentForm(event)">
    <input type="text" id="parentName" placeholder="اسم ولي الأمر" required />
    <input type="tel" id="parentPhone" placeholder="رقم الهاتف" required />
    <input type="text" id="parentArea" placeholder="الحي" required />
    <button type="submit">حفظ ومتابعة</button>
  </form>
</div>

<!-- نموذج الطفل -->
<div id="childForm" style="display:none;">
  <h3>معلومات الطفل</h3>
  <form onsubmit="submitChildForm(event)">
    <input type="text" id="childName" placeholder="اسم الطفل" required />
    <input type="tel" id="childPhone" placeholder="رقم الطفل" required />
    <input type="text" id="childParentName" placeholder="اسم ولي أمرك" required />
    <input type="tel" id="childParentPhone" placeholder="رقم ولي أمرك" required />
    <button type="submit">ابدأ تتبع الموقع</button>
  </form>
</div>

<!-- خريطة ولي الأمر -->
<div id="parentMapSection" style="display:none;">
  <h3>أطفالك على الخريطة</h3>
  <select id="childList" onchange="focusOnSelectedChild()"></select>
  <div id="map"></div>
</div>

<script>
  // إعداد Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCwuWnFl3cGetmrNlWxcU5NT_mHQQzkEqo",
    authDomain: "familytracker-77ec8.firebaseapp.com",
    databaseURL: "https://familytracker-77ec8-default-rtdb.firebaseio.com",
    projectId: "familytracker-77ec8",
    storageBucket: "familytracker-77ec8.appspot.com",
    messagingSenderId: "527698679661",
    appId: "1:527698679661:web:af62a9327797646c3c2c64"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let userRole = null;
  let map = null;
  let markers = {};
  let currentParentPhone = "";

  function chooseRole(role) {
    userRole = role;
    document.getElementById("roleSelect").style.display = "none";
    if (role === 'parent') {
      document.getElementById("parentForm").style.display = "block";
    } else {
      document.getElementById("childForm").style.display = "block";
    }
  }

  function submitParentForm(e) {
    e.preventDefault();
    const name = document.getElementById("parentName").value.trim();
    const phone = document.getElementById("parentPhone").value.trim();
    const area = document.getElementById("parentArea").value.trim();

    if (!name || !phone || !area) {
      alert("يرجى ملء كل المعلومات");
      return;
    }

    currentParentPhone = phone;

    db.ref("parents/" + phone).set({
      name,
      phone,
      area
    });

    document.getElementById("parentForm").style.display = "none";
    document.getElementById("parentMapSection").style.display = "block";
    initMap();
    loadChildren(phone);
  }

  function submitChildForm(e) {
    e.preventDefault();
    const name = document.getElementById("childName").value.trim();
    const phone = document.getElementById("childPhone").value.trim();
    const parentName = document.getElementById("childParentName").value.trim();
    const parentPhone = document.getElementById("childParentPhone").value.trim();

    if (!name || !phone || !parentName || !parentPhone) {
      alert("يرجى ملء كل المعلومات");
      return;
    }

    // التحقق من وجود الولي
    db.ref("parents/" + parentPhone).once("value", (snapshot) => {
      if (snapshot.exists()) {
        const parent = snapshot.val();
        if (normalize(parent.name) === normalize(parentName)) {
          const childRef = db.ref("children/" + phone);
          childRef.set({
            name,
            phone,
            parentPhone,
            parentName
          });
          startTrackingLocation(childRef);
          document.getElementById("childForm").style.display = "none";
          alert("تم ربط الطفل بولي الأمر ويجري الآن تتبع الموقع.");
        } else {
          alert("اسم ولي الأمر لا يطابق الاسم المسجل.");
        }
      } else {
        alert("رقم ولي الأمر غير موجود في النظام.");
      }
    });
  }

  function normalize(str) {
    return str.trim().toLowerCase().replace(/\s+/g, " ");
  }

  function startTrackingLocation(ref) {
    if (!navigator.geolocation) {
      alert("متصفحك لا يدعم تحديد الموقع");
      return;
    }

    navigator.geolocation.watchPosition(
      (position) => {
        const { latitude, longitude } = position.coords;
        ref.update({
          lat: latitude,
          lng: longitude,
          lastUpdated: Date.now()
        });
      },
      (err) => {
        alert("خطأ في تحديد الموقع: " + err.message);
      },
      {
        enableHighAccuracy: true,
        maximumAge: 5000,
        timeout: 10000
      }
    );
  }

  function initMap() {
    if (map) return;
    map = L.map("map").setView([36.75, 3.06], 6);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 18,
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);
  }

  function loadChildren(parentPhone) {
    db.ref("children").on("value", (snapshot) => {
      const data = snapshot.val();
      const childList = document.getElementById("childList");
      childList.innerHTML = "";
      markers = {};

      for (const key in data) {
        const child = data[key];
        if (child.parentPhone === parentPhone && child.lat && child.lng) {
          const option = document.createElement("option");
          option.value = key;
          option.textContent = child.name;
          childList.appendChild(option);

          const marker = L.marker([child.lat, child.lng])
            .addTo(map)
            .bindPopup(`<b>${child.name}</b><br>📞 ${child.phone}`);
          markers[key] = marker;
        }
      }

      if (childList.options.length > 0) {
        focusOnSelectedChild();
      }
    });
  }

  function focusOnSelectedChild() {
    const uid = document.getElementById("childList").value;
    if (!markers[uid]) return;
    map.setView(markers[uid].getLatLng(), 15);
    markers[uid].openPopup();
  }
</script>

</body>
</html>
