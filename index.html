<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ·Ø¨ÙŠÙ‚ ØªØªØ¨Ø¹ Ø§Ù„Ø£Ø·ÙØ§Ù„</title>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBFw0Qbyq9zTFTd-tUY6dpoWcMAoHurN_4&libraries=geometry"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            direction: rtl;
        }

        .screen {
            display: none;
            min-height: 100vh;
        }

        .screen.active {
            display: block;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-top: 50px;
        }

        h1, h2 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }

        .user-type-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .btn-parent {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            flex-direction: column;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 150px;
        }

        .btn-child {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
            flex-direction: column;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 150px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            width: 100%;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            width: 100%;
            margin-top: 10px;
        }

        .btn-google {
            background: #db4437;
            color: white;
            width: 100%;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-logout {
            background: #dc3545;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .header {
            background: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .dashboard-container {
            display: flex;
            height: calc(100vh - 80px);
        }

        .sidebar {
            width: 300px;
            background: white;
            padding: 20px;
            overflow-y: auto;
            border-left: 1px solid #ddd;
        }

        .children-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .child-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .child-item:hover {
            background: #e9ecef;
            transform: translateX(-5px);
        }

        .child-item.active {
            background: #667eea;
            color: white;
            border-color: #5a6fd8;
        }

        .child-name {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 5px;
        }

        .child-status {
            font-size: 14px;
            opacity: 0.8;
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .location-status {
            text-align: center;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 15px;
            margin: 20px 0;
        }

        .location-info {
            margin-top: 20px;
            text-align: right;
        }

        .location-info p {
            margin: 10px 0;
            font-size: 16px;
        }

        .location-info span {
            font-weight: bold;
            color: #667eea;
        }

        .divider {
            text-align: center;
            margin: 20px 0;
            position: relative;
        }

        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #ddd;
        }

        .divider span {
            background: white;
            padding: 0 15px;
            color: #666;
        }

        @media (max-width: 768px) {
            .dashboard-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 200px;
            }
            
            .user-type-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .btn-parent, .btn-child {
                min-width: 200px;
            }
        }

        .btn span {
            font-size: 30px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.error {
            background: #f44336;
        }

        .google-icon {
            width: 20px;
            height: 20px;
        }
    </style>
</head>
<body>
    <!-- Ø´Ø§Ø´Ø© Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
    <div id="userTypeScreen" class="screen active">
        <div class="container">
            <h1>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ ØªØªØ¨Ø¹ Ø§Ù„Ø£Ø·ÙØ§Ù„</h1>
            <div class="user-type-buttons">
                <button class="btn btn-parent" id="parentBtn">
                    <span>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</span>
                    ÙˆÙ„ÙŠ Ø£Ù…Ø±
                </button>
                <button class="btn btn-child" id="childBtn">
                    <span>ğŸ‘¶</span>
                    Ø·ÙÙ„
                </button>
            </div>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± -->
    <div id="parentLoginScreen" class="screen">
        <div class="container">
            <h2>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</h2>
            <div id="parentError" class="error" style="display: none;"></div>
            <div id="parentSuccess" class="success" style="display: none;"></div>
            
            <!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Google -->
            <button type="button" class="btn btn-google" id="parentGoogleBtn">
                <svg class="google-icon" viewBox="0 0 24 24">
                    <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Google
            </button>
            
            <div class="divider">
                <span>Ø£Ùˆ</span>
            </div>
            
            <form id="parentForm">
                <div class="form-group">
                    <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„:</label>
                    <input type="text" id="parentName" required>
                </div>
                <div class="form-group">
                    <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</label>
                    <input type="tel" id="parentPhone" required>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</label>
                    <input type="email" id="parentEmail" required>
                </div>
                <div class="form-group">
                    <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</label>
                    <input type="password" id="parentPassword" required>
                </div>
                <button type="submit" class="btn btn-primary">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
                <button type="button" class="btn btn-secondary" id="parentBackBtn">Ø±Ø¬ÙˆØ¹</button>
            </form>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·ÙÙ„ -->
    <div id="childLoginScreen" class="screen">
        <div class="container">
            <h2>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·ÙÙ„</h2>
            <div id="childError" class="error" style="display: none;"></div>
            <div id="childSuccess" class="success" style="display: none;"></div>
            
            <!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Google Ù„Ù„Ø·ÙÙ„ -->
            <button type="button" class="btn btn-google" id="childGoogleBtn">
                <svg class="google-icon" viewBox="0 0 24 24">
                    <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Google
            </button>
            
            <div class="divider">
                <span>Ø£Ùˆ</span>
            </div>
            
            <form id="childForm">
                <div class="form-group">
                    <label>Ø§Ø³Ù…Ùƒ:</label>
                    <input type="text" id="childName" required>
                </div>
                <div class="form-group">
                    <label>Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ:</label>
                    <input type="tel" id="childPhone" required>
                </div>
                <div class="form-group">
                    <label>Ø±Ù‚Ù… Ù‡Ø§ØªÙ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±:</label>
                    <input type="tel" id="parentPhoneForChild" required>
                </div>
                <button type="submit" class="btn btn-primary">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
                <button type="button" class="btn btn-secondary" id="childBackBtn">Ø±Ø¬ÙˆØ¹</button>
            </form>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± - Ø§Ù„Ø®Ø±ÙŠØ·Ø© -->
    <div id="parentDashboard" class="screen">
        <div class="header">
            <h2 id="parentWelcome">Ù…Ø±Ø­Ø¨Ø§Ù‹</h2>
            <button class="btn btn-logout" id="parentLogoutBtn">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
        </div>
        
        <div class="dashboard-container">
            <div class="sidebar">
                <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø·ÙØ§Ù„</h3>
                <div id="childrenList" class="children-list">
                    <div class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø·ÙØ§Ù„...</div>
                </div>
            </div>
            
            <div class="map-container">
                <div id="map"></div>
            </div>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø·ÙÙ„ - Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹ -->
    <div id="childDashboard" class="screen">
        <div class="container">
            <h2 id="childWelcome">Ù…Ø±Ø­Ø¨Ø§Ù‹</h2>
            <div class="location-status">
                <p id="locationStatus" class="pulse">Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ...</p>
                <div class="location-info">
                    <p>Ø®Ø· Ø§Ù„Ø¹Ø±Ø¶: <span id="latitude">--</span></p>
                    <p>Ø®Ø· Ø§Ù„Ø·ÙˆÙ„: <span id="longitude">--</span></p>
                    <p>Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: <span id="lastUpdate">--</span></p>
                    <p>Ø¯Ù‚Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹: <span id="accuracy">--</span> Ù…ØªØ±</p>
                </div>
            </div>
            <button class="btn btn-logout" id="childLogoutBtn">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
        </div>
    </div>

    <script>
        // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
        let map;
        let markers = {};
        let currentUser = null;
        let userType = null;
        let locationWatchId = null;

        // Ø¥Ø¹Ø¯Ø§Ø¯ Firebase Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ
        const firebaseConfig = {
            apiKey: "AIzaSyCwuWnFl3cGetmrNlWxcU5NT_mHQQzkEqo",
            authDomain: "familytracker-77ec8.firebaseapp.com",
            databaseURL: "https://familytracker-77ec8-default-rtdb.firebaseio.com",
            projectId: "familytracker-77ec8",
            storageBucket: "familytracker-77ec8.firebasestorage.app",
            messagingSenderId: "527698679661",
            appId: "1:527698679661:web:af62a9327797646c3c2c64",
            measurementId: "G-B8ZYB634DN"
        };

        // ØªÙ‡ÙŠØ¦Ø© Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const database = firebase.database();

        // Ø¥Ø¹Ø¯Ø§Ø¯ Google Auth Provider
        const googleProvider = new firebase.auth.GoogleAuthProvider();
        googleProvider.addScope('profile');
        googleProvider.addScope('email');

        // Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø§Ø´Ø§Øª
        function showScreen(screenId) {
            console.log('Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø§Ø´Ø©:', screenId);
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø·Ø£ ÙˆØ§Ù„Ù†Ø¬Ø§Ø­
        function showMessage(elementId, message, isError = true) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.style.display = 'block';
                setTimeout(() => {
                    element.style.display = 'none';
                }, 5000);
            }
        }

        // Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        function showNotification(message, isError = false) {
            const notification = document.createElement('div');
            notification.className = `notification ${isError ? 'error' : ''}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹
        function updateLocationStatus(message, type = 'info') {
            const statusElement = document.getElementById('locationStatus');
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.className = 'pulse';
                
                switch(type) {
                    case 'success':
                        statusElement.style.color = '#4CAF50';
                        statusElement.classList.remove('pulse');
                        break;
                    case 'error':
                        statusElement.style.color = '#f44336';
                        statusElement.classList.remove('pulse');
                        break;
                    case 'warning':
                        statusElement.style.color = '#ff9800';
                        statusElement.classList.remove('pulse');
                        break;
                    default:
                        statusElement.style.color = '#333';
                        break;
                }
            }
        }

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©');

            // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
            const parentBtn = document.getElementById('parentBtn');
            const childBtn = document.getElementById('childBtn');
            
            if (parentBtn) {
                parentBtn.addEventListener('click', function() {
                    console.log('ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±');
                    showScreen('parentLoginScreen');
                });
            }

            if (childBtn) {
                childBtn.addEventListener('click', function() {
                    console.log('ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø·ÙÙ„');
                    showScreen('childLoginScreen');
                });
            }

            // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹
            const parentBackBtn = document.getElementById('parentBackBtn');
            const childBackBtn = document.getElementById('childBackBtn');
            
            if (parentBackBtn) {
                parentBackBtn.addEventListener('click', function() {
                    console.log('Ø±Ø¬ÙˆØ¹ Ù…Ù† Ø´Ø§Ø´Ø© ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±');
                    showScreen('userTypeScreen');
                });
            }

            if (childBackBtn) {
                childBackBtn.addEventListener('click', function() {
                    console.log('Ø±Ø¬ÙˆØ¹ Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ø·ÙÙ„');
                    showScreen('userTypeScreen');
                });
            }

            // Ø£Ø²Ø±Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
            const parentLogoutBtn = document.getElementById('parentLogoutBtn');
            const childLogoutBtn = document.getElementById('childLogoutBtn');
            
            if (parentLogoutBtn) {
                parentLogoutBtn.addEventListener('click', logout);
            }

            if (childLogoutBtn) {
                childLogoutBtn.addEventListener('click', logout);
            }

            // Ø£Ø²Ø±Ø§Ø± Google
            const parentGoogleBtn = document.getElementById('parentGoogleBtn');
            const childGoogleBtn = document.getElementById('childGoogleBtn');

            if (parentGoogleBtn) {
                parentGoogleBtn.addEventListener('click', () => signInWithGoogle('parent'));
            }

            if (childGoogleBtn) {
                childGoogleBtn.addEventListener('click', () => signInWithGoogle('child'));
            }

            // ØªØ£Ø«ÙŠØ± Ø§Ù„Ù†Ù‚Ø± Ù„Ù„Ø£Ø²Ø±Ø§Ø±
            document.querySelectorAll('.btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    const ripple = document.createElement('span');
                    const rect = this.getBoundingClientRect();
                    const size = Math.max(rect.width, rect.height);
                    const x = e.clientX - rect.left - size / 2;
                    const y = e.clientY - rect.top - size / 2;
                    
                    ripple.style.cssText = `
                        position: absolute;
                        border-radius: 50%;
                        background: rgba(255,255,255,0.6);
                        transform: scale(0);
                        animation: ripple 0.6s linear;
                        left: ${x}px;
                        top: ${y}px;
                        width: ${size}px;
                        height: ${size}px;
                        pointer-events: none;
                    `;
                    
                    this.appendChild(ripple);
                    
                    setTimeout(() => {
                        ripple.remove();
                    }, 600);
                });
            });
        });

        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Google
        async function signInWithGoogle(type) {
            try {
                console.log('Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Google Ù„Ù„Ù†ÙˆØ¹:', type);
                
                const result = await auth.signInWithPopup(googleProvider);
                const user = result.user;
                
                console.log('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Google Ø¨Ù†Ø¬Ø§Ø­:', user);
                
                currentUser = user;
                userType = type;
                
                if (type === 'parent') {
                    // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±
                    await db.collection('parents').doc(user.uid).set({
                        name: user.displayName,
                        email: user.email,
                        phone: user.phoneNumber || '',
                        photoURL: user.photoURL,
                        provider: 'google',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                    
                    showMessage('parentSuccess', 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Google Ø¨Ù†Ø¬Ø§Ø­', false);
                    document.getElementById('parentWelcome').textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${user.displayName}`;
                    
                    setTimeout(() => {
                        showScreen('parentDashboard');
                        initMap();
                        loadChildren();
                    }, 1000);
                    
                } else if (type === 'child') {
                    // Ù„Ù„Ø·ÙÙ„ØŒ Ù†Ø­ØªØ§Ø¬ Ù„Ø±Ø¨Ø·Ù‡ Ø¨ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±
                    showChildGoogleSetup(user);
                }
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Google:', error);
                const errorElementId = type === 'parent' ? 'parentError' : 'childError';
                showMessage(errorElementId, 'Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Google: ' + error.message);
            }
        }

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø·ÙÙ„ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Google
        function showChildGoogleSetup(user) {
            const parentPhone = prompt('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±:');
            if (!parentPhone) {
                showMessage('childError', 'ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±');
                return;
            }
            
            setupChildWithGoogle(user, parentPhone);
        }

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø·ÙÙ„ Ù…Ø¹ Google
        async function setupChildWithGoogle(user, parentPhone) {
            try {
                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±
                const parentQuery = await db.collection('parents')
                    .where('phone', '==', parentPhone)
                    .get();
                
                if (parentQuery.empty) {
                    showMessage('childError', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…');
                    return;
                }
                
                const parentDoc = parentQuery.docs[0];
                const parentId = parentDoc.id;
                
                // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„
                const childData = {
                    name: user.displayName,
                    email: user.email,
                    phone: user.phoneNumber || '',
                    photoURL: user.photoURL,
                    parentId: parentId,
                    provider: 'google',
                    lastUpdate: firebase.firestore.FieldValue.serverTimestamp(),
                    isOnline: true
                };
                
                await db.collection('children').doc(user.uid).set(childData, { merge: true });
                
                currentUser = { uid: user.uid, name: user.displayName };
                userType = 'child';
                
                showMessage('childSuccess', 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Google Ø¨Ù†Ø¬Ø§Ø­', false);
                document.getElementById('childWelcome').textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${user.displayName}`;
                
                setTimeout(() => {
                    showScreen('childDashboard');
                    startLocationTracking(user.uid);
                }, 1000);
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø·ÙÙ„:', error);
                showMessage('childError', 'Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø­Ø³Ø§Ø¨: ' + error.message);
            }
        }

        // Øª        // ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
        document.getElementById('parentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±');
            
            const name = document.getElementById('parentName').value;
            const phone = document.getElementById('parentPhone').value;
            const email = document.getElementById('parentEmail').value;
            const password = document.getElementById('parentPassword').value;
            
            try {
                let userCredential;
                try {
                    userCredential = await auth.signInWithEmailAndPassword(email, password);
                    showMessage('parentSuccess', 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­', false);
                } catch (signInError) {
                    userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    
                    await db.collection('parents').doc(userCredential.user.uid).set({
                        name: name,
                        phone: phone,
                        email: email,
                        provider: 'email',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    showMessage('parentSuccess', 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­', false);
                }
                
                currentUser = userCredential.user;
                userType = 'parent';
                
                document.getElementById('parentWelcome').textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${name}`;
                
                setTimeout(() => {
                    showScreen('parentDashboard');
                    initMap();
                    loadChildren();
                }, 1000);
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:', error);
                showMessage('parentError', 'Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ' + error.message);
            }
        });

        // ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·ÙÙ„ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
        document.getElementById('childForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·ÙÙ„');
            
            const childName = document.getElementById('childName').value;
            const childPhone = document.getElementById('childPhone').value;
            const parentPhone = document.getElementById('parentPhoneForChild').value;
            
            try {
                const parentQuery = await db.collection('parents')
                    .where('phone', '==', parentPhone)
                    .get();
                
                if (parentQuery.empty) {
                    showMessage('childError', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…');
                    return;
                }
                
                const parentDoc = parentQuery.docs[0];
                const parentId = parentDoc.id;
                
                const childData = {
                    name: childName,
                    phone: childPhone,
                    parentId: parentId,
                    provider: 'manual',
                    lastUpdate: firebase.firestore.FieldValue.serverTimestamp(),
                    isOnline: true
                };
                
                const childQuery = await db.collection('children')
                    .where('phone', '==', childPhone)
                    .where('parentId', '==', parentId)
                    .get();
                
                let childId;
                if (childQuery.empty) {
                    const childRef = await db.collection('children').add(childData);
                    childId = childRef.id;
                } else {
                    childId = childQuery.docs[0].id;
                    await db.collection('children').doc(childId).update(childData);
                }
                
                currentUser = { uid: childId, name: childName };
                userType = 'child';
                
                showMessage('childSuccess', 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­', false);
                document.getElementById('childWelcome').textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${childName}`;
                
                setTimeout(() => {
                    showScreen('childDashboard');
                    startLocationTracking(childId);
                }, 1000);
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·ÙÙ„:', error);
                showMessage('childError', 'Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ' + error.message);
            }
        });

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø©
        function initMap() {
            console.log('ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø©');
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 13,
                center: { lat: 24.7136, lng: 46.6753 }, // Ø§Ù„Ø±ÙŠØ§Ø¶
                mapTypeId: 'roadmap',
                styles: [
                    {
                        featureType: 'poi',
                        elementType: 'labels',
                        stylers: [{ visibility: 'off' }]
                    }
                ]
            });
        }

        // ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø·ÙØ§Ù„
        function loadChildren() {
            if (!currentUser || userType !== 'parent') return;
            
            console.log('ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø·ÙØ§Ù„');
            const childrenList = document.getElementById('childrenList');
            
            db.collection('children')
                .where('parentId', '==', currentUser.uid)
                .onSnapshot((snapshot) => {
                    childrenList.innerHTML = '';
                    markers = {};
                    
                    if (snapshot.empty) {
                        childrenList.innerHTML = '<div class="loading">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø·ÙØ§Ù„ Ù…Ø³Ø¬Ù„ÙŠÙ† Ø¨Ø¹Ø¯</div>';
                        return;
                    }
                    
                    snapshot.forEach((doc) => {
                        const child = doc.data();
                        const childId = doc.id;
                        
                        const childItem = document.createElement('div');
                        childItem.className = 'child-item';
                        
                        const lastUpdateText = child.lastUpdate ? 
                            new Date(child.lastUpdate.toDate()).toLocaleString('ar-SA') : 
                            'Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ø¹Ø¯';
                        
                        childItem.innerHTML = `
                            <div class="child-name">${child.name}</div>
                            <div class="child-status">${child.isOnline ? 'ğŸŸ¢ Ù…ØªØµÙ„' : 'ğŸ”´ ØºÙŠØ± Ù…ØªØµÙ„'}</div>
                            <div style="font-size: 12px; margin-top: 5px;">
                                Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${lastUpdateText}
                            </div>
                            ${child.provider === 'google' ? '<div style="font-size: 10px; color: #4285f4;">ğŸ“§ Google</div>' : ''}
                        `;
                        
                        childItem.addEventListener('click', () => {
                            focusOnChild(childId, child);
                            document.querySelectorAll('.child-item').forEach(item => {
                                item.classList.remove('active');
                            });
                            childItem.classList.add('active');
                        });
                        
                        childrenList.appendChild(childItem);
                        
                        if (child.location) {
                            addChildMarker(childId, child);
                        }
                    });
                });
        }

        // Ø¥Ø¶Ø§ÙØ© Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ø·ÙÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
        function addChildMarker(childId, child) {
            if (!child.location || !map) return;
            
            const position = {
                lat: child.location.latitude,
                lng: child.location.longitude
            };
            
            if (markers[childId]) {
                markers[childId].setMap(null);
            }
            
            const marker = new google.maps.Marker({
                position: position,
                map: map,
                title: child.name,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 15,
                    fillColor: child.isOnline ? '#4CAF50' : '#f44336',
                    fillOpacity: 1,
                    strokeColor: '#ffffff',
                    strokeWeight: 3
                }
            });
            
            const infoWindow = new google.maps.InfoWindow({
                content: `
                    <div style="text-align: center; direction: rtl; font-family: Arial;">
                        <h3 style="margin: 0 0 10px 0; color: #333;">${child.name}</h3>
                        <p style="margin: 5px 0;"><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${child.isOnline ? 'ğŸŸ¢ Ù…ØªØµÙ„' : 'ğŸ”´ ØºÙŠØ± Ù…ØªØµÙ„'}</p>
                        <p style="margin: 5px 0;"><strong>Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«:</strong><br>${child.lastUpdate ? new Date(child.lastUpdate.toDate()).toLocaleString('ar-SA') : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                        <p style="margin: 5px 0; font-size: 12px; color: #666;">
                            <strong>Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª:</strong><br>
                            ${position.lat.toFixed(6)}, ${position.lng.toFixed(6)}
                        </p>
                        ${child.accuracy ? `<p style="margin: 5px 0; font-size: 12px; color: #666;"><strong>Ø¯Ù‚Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹:</strong> ${Math.round(child.accuracy)} Ù…ØªØ±</p>` : ''}
                        ${child.provider === 'google' ? '<p style="margin: 5px 0; font-size: 10px; color: #4285f4;">ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Google</p>' : ''}
                    </div>
                `
            });
            
            marker.addListener('click', () => {
                Object.values(markers).forEach(m => {
                    if (m.infoWindow) {
                        m.infoWindow.close();
                    }
                });
                infoWindow.open(map, marker);
            });
            
            marker.infoWindow = infoWindow;
            markers[childId] = marker;
        }

        // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø·ÙÙ„ Ù…Ø¹ÙŠÙ†
        function focusOnChild(childId, child) {
            if (child.location && map) {
                const position = {
                    lat: child.location.latitude,
                    lng: child.location.longitude
                };
                
                map.setCenter(position);
                map.setZoom(16);
                
                if (markers[childId]) {
                    google.maps.event.trigger(markers[childId], 'click');
                }
            } else {
                showNotification('Ù…ÙˆÙ‚Ø¹ Ù‡Ø°Ø§ Ø§Ù„Ø·ÙÙ„ ØºÙŠØ± Ù…ØªÙˆÙØ± Ø­Ø§Ù„ÙŠØ§Ù‹', true);
            }
        }

        // Ø¨Ø¯Ø¡ ØªØªØ¨Ø¹ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø·ÙÙ„
        function startLocationTracking(childId) {
            console.log('Ø¨Ø¯Ø¡ ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ù„Ø·ÙÙ„:', childId);
            
            if (!navigator.geolocation) {
                updateLocationStatus('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹', 'error');
                return;
            }
            
            updateLocationStatus('Ø¬Ø§Ø±ÙŠ Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹...', 'info');
            
            const options = {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 30000
            };
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    updateLocationStatus('ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø°Ù† - Ø¨Ø¯Ø¡ Ø§Ù„ØªØªØ¨Ø¹...', 'info');
                    
                    locationWatchId = navigator.geolocation.watchPosition(
                        (position) => {
                            const lat = position.coords.latitude;
                            const lng = position.coords.longitude;
                            const accuracy = position.coords.accuracy;
                            
                            // Ø­ÙØ¸ ÙÙŠ Firestore
                            db.collection('children').doc(childId).update({
                                location: new firebase.firestore.GeoPoint(lat, lng),
                                lastUpdate: firebase.firestore.FieldValue.serverTimestamp(),
                                isOnline: true,
                                accuracy: accuracy
                            }).then(() => {
                                updateLocationStatus('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…ÙˆÙ‚Ø¹Ùƒ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                                document.getElementById('latitude').textContent = lat.toFixed(6);
                                document.getElementById('longitude').textContent = lng.toFixed(6);
                                document.getElementById('lastUpdate').textContent = new Date().toLocaleString('ar-SA');
                                document.getElementById('accuracy').textContent = Math.round(accuracy);
                                
                                showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù†Ø¬Ø§Ø­');
                            }).catch((error) => {
                                updateLocationStatus('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…ÙˆÙ‚Ø¹', 'error');
                                showNotification('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…ÙˆÙ‚Ø¹', true);
                            });

                            // Ø­ÙØ¸ ÙÙŠ Realtime Database Ø£ÙŠØ¶Ø§Ù‹ Ù„Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙˆØ±ÙŠ
                            database.ref('locations/' + childId).set({
                                latitude: lat,
                                longitude: lng,
                                accuracy: accuracy,
                                timestamp: firebase.database.ServerValue.TIMESTAMP,
                                isOnline: true
                            });
                        },
                        (error) => {
                            let errorMessage = 'Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹: ';
                            switch(error.code) {
                                case error.PERMISSION_DENIED:
                                    errorMessage += 'ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø¥Ø°Ù† Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹';
                                    break;
                                case error.POSITION_UNAVAILABLE:
                                    errorMessage += 'Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©';
                                    break;
                                case error.TIMEOUT:
                                    errorMessage += 'Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø·Ù„Ø¨ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹';
                                    break;
                                default:
                                    errorMessage += 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                                    break;
                            }
                            updateLocationStatus(errorMessage, 'error');
                            showNotification(errorMessage, true);
                        },
                        options
                    );
                },
                (error) => {
                    updateLocationStatus('ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹ Ù„ØªØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©', 'warning');
                    showNotification('ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹', true);
                }
            );
        }

        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        async function logout() {
            try {
                // Ø¥ÙŠÙ‚Ø§Ù ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹
                if (locationWatchId) {
                    navigator.geolocation.clearWatch(locationWatchId);
                    locationWatchId = null;
                }
                
                // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
                if (userType === 'child' && currentUser) {
                    await db.collection('children').doc(currentUser.uid).update({
                        isOnline: false,
                        lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // ØªØ­Ø¯ÙŠØ« Realtime Database
                    await database.ref('locations/' + currentUser.uid).update({
                        isOnline: false,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    });
                }
                
                // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Firebase Auth
                await auth.signOut();
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
                currentUser = null;
                userType = null;
                markers = {};
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…Ø§Ø°Ø¬
                document.getElementById('parentForm').reset();
                document.getElementById('childForm').reset();
                
                // Ø¥Ø®ÙØ§Ø¡ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø·Ø£ ÙˆØ§Ù„Ù†Ø¬Ø§Ø­
                document.querySelectorAll('.error, .success').forEach(el => {
                    el.style.display = 'none';
                });
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¹Ù†Ø§ØµØ± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø·ÙÙ„
                if (document.getElementById('locationStatus')) {
                    document.getElementById('locationStatus').textContent = 'Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ...';
                    document.getElementById('locationStatus').classList.add('pulse');
                    document.getElementById('latitude').textContent = '--';
                    document.getElementById('longitude').textContent = '--';
                    document.getElementById('lastUpdate').textContent = '--';
                    document.getElementById('accuracy').textContent = '--';
                }
                
                showScreen('userTypeScreen');
                showNotification('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­');
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬:', error);
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬', true);
            }
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        auth.onAuthStateChanged((user) => {
            if (user && userType === 'parent') {
                currentUser = user;
                console.log('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„:', user);
            }
        });

        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©
        window.addEventListener('beforeunload', async () => {
            if (userType === 'child' && currentUser) {
                try {
                    await db.collection('children').doc(currentUser.uid).update({
                        isOnline: false,
                        lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    await database.ref('locations/' + currentUser.uid).update({
                        isOnline: false,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    });
                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„:', error);
                }
            }
        });

        // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ø§ØªØµØ§Ù„
        window.addEventListener('online', () => {
            if (userType === 'child' && currentUser) {
                db.collection('children').doc(currentUser.uid).update({
                    isOnline: true,
                    lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => {
                    updateLocationStatus('ğŸ”„ ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ - Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹...', 'info');
                    // Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ø¯Ø¡ ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹
                    if (!locationWatchId) {
                        startLocationTracking(currentUser.uid);
                    }
                });
            }
        });

        window.addEventListener('offline', () => {
            if (userType === 'child' && currentUser) {
                updateLocationStatus('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª - Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù†Ø¯ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„', 'warning');
            }
        });

        // ØªØ­Ø¯ÙŠØ« Ø¯ÙˆØ±ÙŠ Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ (ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©)
        setInterval(() => {
            if (userType === 'child' && currentUser && navigator.onLine) {
                db.collection('children').doc(currentUser.uid).update({
                    lastUpdate: firebase.firestore.FieldValue.serverTimestamp(),
                    isOnline: true
                }).catch(error => {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯ÙˆØ±ÙŠ:', error);
                });
                
                database.ref('locations/' + currentUser.uid).update({
                    isOnline: true,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                }).catch(error => {
                    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Realtime Database:', error);
                });
            }
        }, 30000);

        // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„ÙÙˆØ±ÙŠØ© Ù„Ù„Ù…ÙˆØ§Ù‚Ø¹ (Ù„Ù„ÙˆØ§Ù„Ø¯ÙŠÙ†)
        function watchRealtimeLocations() {
            if (userType !== 'parent' || !currentUser) return;
            
            database.ref('locations').on('child_changed', (snapshot) => {
                const childId = snapshot.key;
                const locationData = snapshot.val();
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ù‡Ø°Ø§ Ø§Ù„Ø·ÙÙ„ ÙŠÙ†ØªÙ…ÙŠ Ù„ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
                db.collection('children').doc(childId).get().then((doc) => {
                    if (doc.exists && doc.data().parentId === currentUser.uid) {
                        const child = doc.data();
                        child.location = {
                            latitude: locationData.latitude,
                            longitude: locationData.longitude
                        };
                        child.accuracy = locationData.accuracy;
                        child.isOnline = locationData.isOnline;
                        
                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
                        addChildMarker(childId, child);
                    }
                });
            });
        }

        // Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„ÙÙˆØ±ÙŠØ© Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙˆØ§Ù„Ø¯
        auth.onAuthStateChanged((user) => {
            if (user && userType === 'parent') {
                watchRealtimeLocations();
            }
        });

        // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬ Ù„Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù…Ø©
        window.addEventListener('error', (e) => {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:', e.error);
            showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹', true);
        });

        // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬ Ù„Ù„ÙˆØ¹ÙˆØ¯ Ø§Ù„Ù…Ø±ÙÙˆØ¶Ø©
        window.addEventListener('unhandledrejection', (e) => {
            console.error('ÙˆØ¹Ø¯ Ù…Ø±ÙÙˆØ¶:', e.reason);
            showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', true);
        });

        // Ø¥Ø¶Ø§ÙØ© Ù…ÙŠØ²Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        console.log('ØªÙ… Ù…Ù†Ø­ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª');
                    }
                });
            }
        }

        // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±
        function sendNotification(title, body, icon = null) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, {
                    body: body,
                    icon: icon || '/favicon.ico',
                    dir: 'rtl',
                    lang: 'ar'
                });
            }
        }

        // Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('DOMContentLoaded', () => {
            requestNotificationPermission();
        });

        // Ø¥Ø¶Ø§ÙØ© Ù…ÙŠØ²Ø© Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹
        function saveToLocalStorage(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹:', error);
            }
        }

        function getFromLocalStorage(key) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©:', error);
                return null;
            }
        }

        // Ø­ÙØ¸ Ø¢Ø®Ø± Ù…ÙˆÙ‚Ø¹ Ù…Ø­Ù„ÙŠØ§Ù‹
        function saveLastLocation(childId, location) {
            saveToLocalStorage(`lastLocation_${childId}`, {
                ...location,
                timestamp: Date.now()
            });
        }

        // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¢Ø®Ø± Ù…ÙˆÙ‚Ø¹ Ù…Ø­ÙÙˆØ¸
        function getLastLocation(childId) {
            return getFromLocalStorage(`lastLocation_${childId}`);
        }

        console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­ Ù…Ø¹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Google');
    </script>
</body>
</html>

</html>


