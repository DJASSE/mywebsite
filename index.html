<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ØªØªØ¨Ø¹ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© - Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Ø®Ø· -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo&display=swap" rel="stylesheet" />

  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(135deg, #0099ff, #005f99);
      color: white;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    h1 { margin: 20px 0 10px; }
    button {
      padding: 10px 20px;
      margin: 10px;
      border: none;
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    input, select {
      margin: 10px;
      padding: 10px;
      border-radius: 15px;
      border: none;
      width: 80%;
      max-width: 300px;
      font-size: 16px;
    }
    #map {
      height: 400px;
      margin: 15px auto;
      max-width: 500px;
      border-radius: 15px;
    }
  </style>
</head>
<body>

<h1>ØªØªØ¨Ø¹ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© - Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±</h1>

<!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¯ÙˆØ± -->
<div id="roleSelect">
  <h3>Ø§Ø®ØªØ± Ø¯ÙˆØ±Ùƒ:</h3>
  <button onclick="chooseRole('parent')">Ø£Ù†Ø§ ÙˆÙ„ÙŠ Ø£Ù…Ø± ğŸ‘¨â€ğŸ‘§â€ğŸ‘¦</button>
  <button onclick="chooseRole('child')">Ø£Ù†Ø§ Ø·ÙÙ„ ğŸ§’</button>
</div>

<!-- Ù†Ù…ÙˆØ°Ø¬ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± -->
<div id="parentForm" style="display:none;">
  <h3>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</h3>
  <form onsubmit="submitParentForm(event)">
    <input type="text" id="parentName" placeholder="Ø§Ø³Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±" required />
    <input type="tel" id="parentPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" required />
    <input type="text" id="parentArea" placeholder="Ø§Ù„Ø­ÙŠ" required />
    <button type="submit">Ø­ÙØ¸ ÙˆÙ…ØªØ§Ø¨Ø¹Ø©</button>
  </form>
</div>

<!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø·ÙÙ„ -->
<div id="childForm" style="display:none;">
  <h3>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·ÙÙ„</h3>
  <form onsubmit="submitChildForm(event)">
    <input type="text" id="childName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·ÙÙ„" required />
    <input type="tel" id="childPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø·ÙÙ„" required />
    <input type="text" id="childParentName" placeholder="Ø§Ø³Ù… ÙˆÙ„ÙŠ Ø£Ù…Ø±Ùƒ" required />
    <input type="tel" id="childParentPhone" placeholder="Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø£Ù…Ø±Ùƒ" required />
    <button type="submit">Ø§Ø¨Ø¯Ø£ ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹</button>
  </form>
</div>

<!-- Ø®Ø±ÙŠØ·Ø© ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± -->
<div id="parentMapSection" style="display:none;">
  <h3>Ø£Ø·ÙØ§Ù„Ùƒ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</h3>
  <select id="childList" onchange="focusOnSelectedChild()"></select>
  <div id="map"></div>
</div>

<script>
  // Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCwuWnFl3cGetmrNlWxcU5NT_mHQQzkEqo",
    authDomain: "familytracker-77ec8.firebaseapp.com",
    databaseURL: "https://familytracker-77ec8-default-rtdb.firebaseio.com",
    projectId: "familytracker-77ec8",
    storageBucket: "familytracker-77ec8.appspot.com",
    messagingSenderId: "527698679661",
    appId: "1:527698679661:web:af62a9327797646c3c2c64"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let userRole = null;
  let map = null;
  let markers = {};
  let currentParentPhone = "";

  function chooseRole(role) {
    userRole = role;
    document.getElementById("roleSelect").style.display = "none";
    if (role === 'parent') {
      document.getElementById("parentForm").style.display = "block";
    } else {
      document.getElementById("childForm").style.display = "block";
    }
  }

  function submitParentForm(e) {
    e.preventDefault();
    const name = document.getElementById("parentName").value.trim();
    const phone = document.getElementById("parentPhone").value.trim();
    const area = document.getElementById("parentArea").value.trim();

    if (!name || !phone || !area) {
      alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ ÙƒÙ„ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª");
      return;
    }

    currentParentPhone = phone;

    db.ref("parents/" + phone).set({
      name,
      phone,
      area
    });

    document.getElementById("parentForm").style.display = "none";
    document.getElementById("parentMapSection").style.display = "block";
    initMap();
    loadChildren(phone);
  }

  function submitChildForm(e) {
    e.preventDefault();
    const name = document.getElementById("childName").value.trim();
    const phone = document.getElementById("childPhone").value.trim();
    const parentName = document.getElementById("childParentName").value.trim();
    const parentPhone = document.getElementById("childParentPhone").value.trim();

    if (!name || !phone || !parentName || !parentPhone) {
      alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ ÙƒÙ„ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª");
      return;
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„ÙˆÙ„ÙŠ
    db.ref("parents/" + parentPhone).once("value", (snapshot) => {
      if (snapshot.exists()) {
        const parent = snapshot.val();
        if (normalize(parent.name) === normalize(parentName)) {
          const childRef = db.ref("children/" + phone);
          childRef.set({
            name,
            phone,
            parentPhone,
            parentName
          });
          startTrackingLocation(childRef);
          document.getElementById("childForm").style.display = "none";
          alert("ØªÙ… Ø±Ø¨Ø· Ø§Ù„Ø·ÙÙ„ Ø¨ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± ÙˆÙŠØ¬Ø±ÙŠ Ø§Ù„Ø¢Ù† ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹.");
        } else {
          alert("Ø§Ø³Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± Ù„Ø§ ÙŠØ·Ø§Ø¨Ù‚ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø¬Ù„.");
        }
      } else {
        alert("Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù….");
      }
    });
  }

  function normalize(str) {
    return str.trim().toLowerCase().replace(/\s+/g, " ");
  }

  function startTrackingLocation(ref) {
    if (!navigator.geolocation) {
      alert("Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹");
      return;
    }

    navigator.geolocation.watchPosition(
      (position) => {
        const { latitude, longitude } = position.coords;
        ref.update({
          lat: latitude,
          lng: longitude,
          lastUpdated: Date.now()
        });
      },
      (err) => {
        alert("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹: " + err.message);
      },
      {
        enableHighAccuracy: true,
        maximumAge: 5000,
        timeout: 10000
      }
    );
  }

  function initMap() {
    if (map) return;
    map = L.map("map").setView([36.75, 3.06], 6);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 18,
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);
  }

  function loadChildren(parentPhone) {
    db.ref("children").on("value", (snapshot) => {
      const data = snapshot.val();
      const childList = document.getElementById("childList");
      childList.innerHTML = "";
      markers = {};

      for (const key in data) {
        const child = data[key];
        if (child.parentPhone === parentPhone && child.lat && child.lng) {
          const option = document.createElement("option");
          option.value = key;
          option.textContent = child.name;
          childList.appendChild(option);

          const marker = L.marker([child.lat, child.lng])
            .addTo(map)
            .bindPopup(`<b>${child.name}</b><br>ğŸ“ ${child.phone}`);
          markers[key] = marker;
        }
      }

      if (childList.options.length > 0) {
        focusOnSelectedChild();
      }
    });
  }

  function focusOnSelectedChild() {
    const uid = document.getElementById("childList").value;
    if (!markers[uid]) return;
    map.setView(markers[uid].getLatLng(), 15);
    markers[uid].openPopup();
  }
</script>

</body>
</html>
