<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÿ™ÿ∑ÿ®ŸäŸÇ ÿ™ÿ™ÿ®ÿπ ÿßŸÑÿ£ÿ∑ŸÅÿßŸÑ</title>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBFw0Qbyq9zTFTd-tUY6dpoWcMAoHurN_4&libraries=geometry"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            direction: rtl;
        }

        .screen {
            display: none;
            min-height: 100vh;
        }

        .screen.active {
            display: block;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-top: 50px;
        }

        h1, h2 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }

        .user-type-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .btn-parent {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            flex-direction: column;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 150px;
        }

        .btn-child {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
            flex-direction: column;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 150px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            width: 100%;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            width: 100%;
            margin-top: 10px;
        }

        .btn-google {
            background: #db4437;
            color: white;
            width: 100%;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-logout {
            background: #dc3545;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .header {
            background: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .dashboard-container {
            display: flex;
            height: calc(100vh - 80px);
        }

        .sidebar {
            width: 300px;
            background: white;
            padding: 20px;
            overflow-y: auto;
            border-left: 1px solid #ddd;
        }

        .children-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .child-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .child-item:hover {
            background: #e9ecef;
            transform: translateX(-5px);
        }

        .child-item.active {
            background: #667eea;
            color: white;
            border-color: #5a6fd8;
        }

        .child-name {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 5px;
        }

        .child-status {
            font-size: 14px;
            opacity: 0.8;
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .location-status {
            text-align: center;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 15px;
            margin: 20px 0;
        }

        .location-info {
            margin-top: 20px;
            text-align: right;
        }

        .location-info p {
            margin: 10px 0;
            font-size: 16px;
        }

        .location-info span {
            font-weight: bold;
            color: #667eea;
        }

        .divider {
            text-align: center;
            margin: 20px 0;
            position: relative;
        }

        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #ddd;
        }

        .divider span {
            background: white;
            padding: 0 15px;
            color: #666;
        }

        @media (max-width: 768px) {
            .dashboard-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 200px;
            }
            
            .user-type-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .btn-parent, .btn-child {
                min-width: 200px;
            }
        }

        .btn span {
            font-size: 30px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.error {
            background: #f44336;
        }

        .google-icon {
            width: 20px;
            height: 20px;
        }
    </style>
</head>
<body>
    <!-- ÿ¥ÿßÿ¥ÿ© ÿßÿÆÿ™Ÿäÿßÿ± ŸÜŸàÿπ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ -->
    <div id="userTypeScreen" class="screen active">
        <div class="container">
            <h1>ŸÖÿ±ÿ≠ÿ®ÿßŸã ÿ®ŸÉ ŸÅŸä ÿ™ÿ∑ÿ®ŸäŸÇ ÿ™ÿ™ÿ®ÿπ ÿßŸÑÿ£ÿ∑ŸÅÿßŸÑ</h1>
            <div class="user-type-buttons">
                <button class="btn btn-parent" id="parentBtn">
                    <span>üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span>
                    ŸàŸÑŸä ÿ£ŸÖÿ±
                </button>
                <button class="btn btn-child" id="childBtn">
                    <span>üë∂</span>
                    ÿ∑ŸÅŸÑ
                </button>
            </div>
        </div>
    </div>

    <!-- ÿ¥ÿßÿ¥ÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ ŸàŸÑŸä ÿßŸÑÿ£ŸÖÿ± -->
    <div id="parentLoginScreen" class="screen">
        <div class="container">
            <h2>ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ ŸàŸÑŸä ÿßŸÑÿ£ŸÖÿ±</h2>
            <div id="parentError" class="error" style="display: none;"></div>
            <div id="parentSuccess" class="success" style="display: none;"></div>
            
            <!-- ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ŸÄ Google -->
            <button type="button" class="btn btn-google" id="parentGoogleBtn">
                <svg class="google-icon" viewBox="0 0 24 24">
                    <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ŸÄ Google
            </button>
            
            <div class="divider">
                <span>ÿ£Ÿà</span>
            </div>
            
            <form id="parentForm">
                <div class="form-group">
                    <label>ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ:</label>
                    <input type="text" id="parentName" required>
                </div>
                <div class="form-group">
                    <label>ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ:</label>
                    <input type="tel" id="parentPhone" required>
                </div>
                <div class="form-group">
                    <label>ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä:</label>
                    <input type="email" id="parentEmail" required>
                </div>
                <div class="form-group">
                    <label>ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±:</label>
                    <input type="password" id="parentPassword" required>
                </div>
                <button type="submit" class="btn btn-primary">ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ</button>
                <button type="button" class="btn btn-secondary" id="parentBackBtn">ÿ±ÿ¨Ÿàÿπ</button>
            </form>
        </div>
    </div>

    <!-- ÿ¥ÿßÿ¥ÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ ÿßŸÑÿ∑ŸÅŸÑ -->
    <div id="childLoginScreen" class="screen">
        <div class="container">
            <h2>ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ ÿßŸÑÿ∑ŸÅŸÑ</h2>
            <div id="childError" class="error" style="display: none;"></div>
            <div id="childSuccess" class="success" style="display: none;"></div>
            
            <!-- ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ŸÄ Google ŸÑŸÑÿ∑ŸÅŸÑ -->
            <button type="button" class="btn btn-google" id="childGoogleBtn">
                <svg class="google-icon" viewBox="0 0 24 24">
                    <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ŸÄ Google
            </button>
            
            <div class="divider">
                <span>ÿ£Ÿà</span>
            </div>
            
            <form id="childForm">
                <div class="form-group">
                    <label>ÿßÿ≥ŸÖŸÉ:</label>
                    <input type="text" id="childName" required>
                </div>
                <div class="form-group">
                    <label>ÿ±ŸÇŸÖ Ÿáÿßÿ™ŸÅŸÉ:</label>
                    <input type="tel" id="childPhone" required>
                </div>
                <div class="form-group">
                    <label>ÿ±ŸÇŸÖ Ÿáÿßÿ™ŸÅ ŸàŸÑŸä ÿßŸÑÿ£ŸÖÿ±:</label>
                    <input type="tel" id="parentPhoneForChild" required>
                </div>
                <button type="submit" class="btn btn-primary">ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ</button>
                <button type="button" class="btn btn-secondary" id="childBackBtn">ÿ±ÿ¨Ÿàÿπ</button>
            </form>
        </div>
    </div>

    <!-- ÿ¥ÿßÿ¥ÿ© ŸàŸÑŸä ÿßŸÑÿ£ŸÖÿ± - ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ© -->
    <div id="parentDashboard" class="screen">
        <div class="header">
            <h2 id="parentWelcome">ŸÖÿ±ÿ≠ÿ®ÿßŸã</h2>
            <button class="btn btn-logout" id="parentLogoutBtn">ÿ™ÿ≥ÿ¨ŸäŸÑ ÿÆÿ±Ÿàÿ¨</button>
        </div>
        
        <div class="dashboard-container">
            <div class="sidebar">
                <h3>ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ£ÿ∑ŸÅÿßŸÑ</h3>
                <div id="childrenList" class="children-list">
                    <div class="loading">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ£ÿ∑ŸÅÿßŸÑ...</div>
                </div>
            </div>
            
            <div class="map-container">
                <div id="map"></div>
            </div>
        </div>
    </div>

    <!-- ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ∑ŸÅŸÑ - ŸÖÿ¥ÿßÿ±ŸÉÿ© ÿßŸÑŸÖŸàŸÇÿπ -->
    <div id="childDashboard" class="screen">
        <div class="container">
            <h2 id="childWelcome">ŸÖÿ±ÿ≠ÿ®ÿßŸã</h2>
            <div class="location-status">
                <p id="locationStatus" class="pulse">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ÿØŸäÿØ ŸÖŸàŸÇÿπŸÉ...</p>
                <div class="location-info">
                    <p>ÿÆÿ∑ ÿßŸÑÿπÿ±ÿ∂: <span id="latitude">--</span></p>
                    <p>ÿÆÿ∑ ÿßŸÑÿ∑ŸàŸÑ: <span id="longitude">--</span></p>
                    <p>ÿ¢ÿÆÿ± ÿ™ÿ≠ÿØŸäÿ´: <span id="lastUpdate">--</span></p>
                    <p>ÿØŸÇÿ© ÿßŸÑŸÖŸàŸÇÿπ: <span id="accuracy">--</span> ŸÖÿ™ÿ±</p>
                </div>
            </div>
            <button class="btn btn-logout" id="childLogoutBtn">ÿ™ÿ≥ÿ¨ŸäŸÑ ÿÆÿ±Ÿàÿ¨</button>
        </div>
    </div>

    <script>
        // ÿßŸÑŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿßŸÑÿπÿßŸÖÿ©
        let map;
        let markers = {};
        let currentUser = null;
        let userType = null;
        let locationWatchId = null;

        // ÿ•ÿπÿØÿßÿØ Firebase ŸÖÿπ ŸÖÿπŸÑŸàŸÖÿßÿ™ŸÉ
        const firebaseConfig = {
            apiKey: "AIzaSyCwuWnFl3cGetmrNlWxcU5NT_mHQQzkEqo",
            authDomain: "familytracker-77ec8.firebaseapp.com",
            databaseURL: "https://familytracker-77ec8-default-rtdb.firebaseio.com",
            projectId: "familytracker-77ec8",
            storageBucket: "familytracker-77ec8.firebasestorage.app",
            messagingSenderId: "527698679661",
            appId: "1:527698679661:web:af62a9327797646c3c2c64",
            measurementId: "G-B8ZYB634DN"
        };

        // ÿ™ŸáŸäÿ¶ÿ© Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const database = firebase.database();

        // ÿ•ÿπÿØÿßÿØ Google Auth Provider
        const googleProvider = new firebase.auth.GoogleAuthProvider();
        googleProvider.addScope('profile');
        googleProvider.addScope('email');

        // ÿπÿ±ÿ∂ ÿßŸÑÿ¥ÿßÿ¥ÿßÿ™
        function showScreen(screenId) {
            console.log('ÿπÿ±ÿ∂ ÿßŸÑÿ¥ÿßÿ¥ÿ©:', screenId);
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        // ÿπÿ±ÿ∂ ÿ±ÿ≥ÿßÿ¶ŸÑ ÿßŸÑÿÆÿ∑ÿ£ ŸàÿßŸÑŸÜÿ¨ÿßÿ≠
        function showMessage(elementId, message, isError = true) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.style.display = 'block';
                setTimeout(() => {
                    element.style.display = 'none';
                }, 5000);
            }
        }

        // ÿØÿßŸÑÿ© ŸÑÿπÿ±ÿ∂ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™
        function showNotification(message, isError = false) {
            const notification = document.createElement('div');
            notification.className = `notification ${isError ? 'error' : ''}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        // ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖŸàŸÇÿπ
        function updateLocationStatus(message, type = 'info') {
            const statusElement = document.getElementById('locationStatus');
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.className = 'pulse';
                
                switch(type) {
                    case 'success':
                        statusElement.style.color = '#4CAF50';
                        statusElement.classList.remove('pulse');
                        break;
                    case 'error':
                        statusElement.style.color = '#f44336';
                        statusElement.classList.remove('pulse');
                        break;
                    case 'warning':
                        statusElement.style.color = '#ff9800';
                        statusElement.classList.remove('pulse');
                        break;
                    default:
                        statusElement.style.color = '#333';
                        break;
                }
            }
        }

        // ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑÿ£ÿ≠ÿØÿßÿ´ ÿπŸÜÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©');

            // ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©
            const parentBtn = document.getElementById('parentBtn');
            const childBtn = document.getElementById('childBtn');
            
            if (parentBtn) {
                parentBtn.addEventListener('click', function() {
                    console.log('ÿ™ŸÖ ÿßŸÑŸÜŸÇÿ± ÿπŸÑŸâ ÿ≤ÿ± ŸàŸÑŸä ÿßŸÑÿ£ŸÖÿ±');
                    showScreen('parentLoginScreen');
                });
            }

            if (childBtn) {
                childBtn.addEventListener('click', function() {
                    console.log('ÿ™ŸÖ ÿßŸÑŸÜŸÇÿ± ÿπŸÑŸâ ÿ≤ÿ± ÿßŸÑÿ∑ŸÅŸÑ');
                    showScreen('childLoginScreen');
                });
            }

            // ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ±ÿ¨Ÿàÿπ
            const parentBackBtn = document.getElementById('parentBackBtn');
            const childBackBtn = document.getElementById('childBackBtn');
            
            if (parentBackBtn) {
                parentBackBtn.addEventListener('click', function() {
                    console.log('ÿ±ÿ¨Ÿàÿπ ŸÖŸÜ ÿ¥ÿßÿ¥ÿ© ŸàŸÑŸä ÿßŸÑÿ£ŸÖÿ±');
                    showScreen('userTypeScreen');
                });
            }

            if (childBackBtn) {
                childBackBtn.addEventListener('click', function() {
                    console.log('ÿ±ÿ¨Ÿàÿπ ŸÖŸÜ ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ∑ŸÅŸÑ');
                    showScreen('userTypeScreen');
                });
            }

            // ÿ£ÿ≤ÿ±ÿßÿ± ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨
            const parentLogoutBtn = document.getElementById('parentLogoutBtn');
            const childLogoutBtn = document.getElementById('childLogoutBtn');
            
            if (parentLogoutBtn) {
                parentLogoutBtn.addEventListener('click', logout);
            }

            if (childLogoutBtn) {
                childLogoutBtn.addEventListener('click', logout);
            }

            // ÿ£ÿ≤ÿ±ÿßÿ± Google
            const parentGoogleBtn = document.getElementById('parentGoogleBtn');
            const childGoogleBtn = document.getElementById('childGoogleBtn');

            if (parentGoogleBtn) {
                parentGoogleBtn.addEventListener('click', () => signInWithGoogle('parent'));
            }

            if (childGoogleBtn) {
                childGoogleBtn.addEventListener('click', () => signInWithGoogle('child'));
            }

            // ÿ™ÿ£ÿ´Ÿäÿ± ÿßŸÑŸÜŸÇÿ± ŸÑŸÑÿ£ÿ≤ÿ±ÿßÿ±
            document.querySelectorAll('.btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    const ripple = document.createElement('span');
                    const rect = this.getBoundingClientRect();
                    const size = Math.max(rect.width, rect.height);
                    const x = e.clientX - rect.left - size / 2;
                    const y = e.clientY - rect.top - size / 2;
                    
                    ripple.style.cssText = `
                        position: absolute;
                        border-radius: 50%;
                        background: rgba(255,255,255,0.6);
                        transform: scale(0);
                        animation: ripple 0.6s linear;
                        left: ${x}px;
                        top: ${y}px;
                        width: ${size}px;
                        height: ${size}px;
                        pointer-events: none;
                    `;
                    
                    this.appendChild(ripple);
                    
                    setTimeout(() => {
                        ripple.remove();
                    }, 600);
                });
            });
        });

        // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ŸÄ Google
        async function signInWithGoogle(type) {
            try {
                console.log('ŸÖÿ≠ÿßŸàŸÑÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ŸÄ Google ŸÑŸÑŸÜŸàÿπ:', type);
                
                const result = await auth.signInWithPopup(googleProvider);
                const user = result.user;
                
                console.log('ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ŸÄ Google ÿ®ŸÜÿ¨ÿßÿ≠:', user);
                
                currentUser = user;
                userType = type;
                
                if (type === 'parent') {
                    // ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ŸàŸÑŸä ÿßŸÑÿ£ŸÖÿ±
                    await db.collection('parents').doc(user.uid).set({
                        name: user.displayName,
                        email: user.email,
                        phone: user.phoneNumber || '',
                        photoURL: user.photoURL,
                        provider: 'google',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                    
                    showMessage('parentSuccess', 'ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ŸÄ Google ÿ®ŸÜÿ¨ÿßÿ≠', false);
                    document.getElementById('parentWelcome').textContent = `ŸÖÿ±ÿ≠ÿ®ÿßŸã ${user.displayName}`;
                    
                    setTimeout(() => {
                        showScreen('parentDashboard');
                        initMap();
                        loadChildren();
                    }, 1000);
                    
                } else if (type === 'child') {
                    // ŸÑŸÑÿ∑ŸÅŸÑÿå ŸÜÿ≠ÿ™ÿßÿ¨ ŸÑÿ±ÿ®ÿ∑Ÿá ÿ®ŸàŸÑŸä ÿßŸÑÿ£ŸÖÿ±
                    showChildGoogleSetup(user);
                }
                
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ŸÄ Google:', error);
                const errorElementId = type === 'parent' ? 'parentError' : 'childError';
                showMessage(errorElementId, 'ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ŸÄ Google: ' + error.message);
            }
        }

        // ÿ•ÿπÿØÿßÿØ ÿßŸÑÿ∑ŸÅŸÑ ÿ®ÿπÿØ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ŸÄ Google
        function showChildGoogleSetup(user) {
            const parentPhone = prompt('Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿ±ŸÇŸÖ Ÿáÿßÿ™ŸÅ ŸàŸÑŸä ÿßŸÑÿ£ŸÖÿ±:');
            if (!parentPhone) {
                showMessage('childError', 'Ÿäÿ¨ÿ® ÿ•ÿØÿÆÿßŸÑ ÿ±ŸÇŸÖ Ÿáÿßÿ™ŸÅ ŸàŸÑŸä ÿßŸÑÿ£ŸÖÿ±');
                return;
            }
            
            setupChildWithGoogle(user, parentPhone);
        }

        // ÿ•ÿπÿØÿßÿØ ÿßŸÑÿ∑ŸÅŸÑ ŸÖÿπ Google
        async function setupChildWithGoogle(user, parentPhone) {
            try {
                // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ŸàŸÑŸä ÿßŸÑÿ£ŸÖÿ±
                const parentQuery = await db.collection('parents')
                    .where('phone', '==', parentPhone)
                    .get();
                
                if (parentQuery.empty) {
                    showMessage('childError', 'ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ŸàŸÑŸä ÿßŸÑÿ£ŸÖÿ± ÿ®Ÿáÿ∞ÿß ÿßŸÑÿ±ŸÇŸÖ');
                    return;
                }
                
                const parentDoc = parentQuery.docs[0];
                const parentId = parentDoc.id;
                
                // ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ∑ŸÅŸÑ
                const childData = {
                    name: user.displayName,
                    email: user.email,
                    phone: user.phoneNumber || '',
                    photoURL: user.photoURL,
                    parentId: parentId,
                    provider: 'google',
                    lastUpdate: firebase.firestore.FieldValue.serverTimestamp(),
                    isOnline: true
                };
                
                await db.collection('children').doc(user.uid).set(childData, { merge: true });
                
                currentUser = { uid: user.uid, name: user.displayName };
                userType = 'child';
                
                showMessage('childSuccess', 'ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ŸÄ Google ÿ®ŸÜÿ¨ÿßÿ≠', false);
                document.getElementById('childWelcome').textContent = `ŸÖÿ±ÿ≠ÿ®ÿßŸã ${user.displayName}`;
                
                setTimeout(() => {
                    showScreen('childDashboard');
                    startLocationTracking(user.uid);
                }, 1000);
                
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿπÿØÿßÿØ ÿßŸÑÿ∑ŸÅŸÑ:', error);
                showMessage('childError', 'ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿπÿØÿßÿØ ÿßŸÑÿ≠ÿ≥ÿßÿ®: ' + error.message);
            }
        }

        // ÿ™        // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ ŸàŸÑŸä ÿßŸÑÿ£ŸÖÿ± ÿ®ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä
        document.getElementById('parentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('ŸÖÿ≠ÿßŸàŸÑÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ ŸàŸÑŸä ÿßŸÑÿ£ŸÖÿ±');
            
            const name = document.getElementById('parentName').value;
            const phone = document.getElementById('parentPhone').value;
            const email = document.getElementById('parentEmail').value;
            const password = document.getElementById('parentPassword').value;
            
            try {
                let userCredential;
                try {
                    userCredential = await auth.signInWithEmailAndPassword(email, password);
                    showMessage('parentSuccess', 'ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ŸÜÿ¨ÿßÿ≠', false);
                } catch (signInError) {
                    userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    
                    await db.collection('parents').doc(userCredential.user.uid).set({
                        name: name,
                        phone: phone,
                        email: email,
                        provider: 'email',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    showMessage('parentSuccess', 'ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ≠ÿ≥ÿßÿ® Ÿàÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ŸÜÿ¨ÿßÿ≠', false);
                }
                
                currentUser = userCredential.user;
                userType = 'parent';
                
                document.getElementById('parentWelcome').textContent = `ŸÖÿ±ÿ≠ÿ®ÿßŸã ${name}`;
                
                setTimeout(() => {
                    showScreen('parentDashboard');
                    initMap();
                    loadChildren();
                }, 1000);
                
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ:', error);
                showMessage('parentError', 'ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ: ' + error.message);
            }
        });

        // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ ÿßŸÑÿ∑ŸÅŸÑ ÿ®ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿπÿßÿØŸäÿ©
        document.getElementById('childForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('ŸÖÿ≠ÿßŸàŸÑÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ ÿßŸÑÿ∑ŸÅŸÑ');
            
            const childName = document.getElementById('childName').value;
            const childPhone = document.getElementById('childPhone').value;
            const parentPhone = document.getElementById('parentPhoneForChild').value;
            
            try {
                const parentQuery = await db.collection('parents')
                    .where('phone', '==', parentPhone)
                    .get();
                
                if (parentQuery.empty) {
                    showMessage('childError', 'ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ŸàŸÑŸä ÿßŸÑÿ£ŸÖÿ± ÿ®Ÿáÿ∞ÿß ÿßŸÑÿ±ŸÇŸÖ');
                    return;
                }
                
                const parentDoc = parentQuery.docs[0];
                const parentId = parentDoc.id;
                
                const childData = {
                    name: childName,
                    phone: childPhone,
                    parentId: parentId,
                    provider: 'manual',
                    lastUpdate: firebase.firestore.FieldValue.serverTimestamp(),
                    isOnline: true
                };
                
                const childQuery = await db.collection('children')
                    .where('phone', '==', childPhone)
                    .where('parentId', '==', parentId)
                    .get();
                
                let childId;
                if (childQuery.empty) {
                    const childRef = await db.collection('children').add(childData);
                    childId = childRef.id;
                } else {
                    childId = childQuery.docs[0].id;
                    await db.collection('children').doc(childId).update(childData);
                }
                
                currentUser = { uid: childId, name: childName };
                userType = 'child';
                
                showMessage('childSuccess', 'ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ŸÜÿ¨ÿßÿ≠', false);
                document.getElementById('childWelcome').textContent = `ŸÖÿ±ÿ≠ÿ®ÿßŸã ${childName}`;
                
                setTimeout(() => {
                    showScreen('childDashboard');
                    startLocationTracking(childId);
                }, 1000);
                
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ ÿßŸÑÿ∑ŸÅŸÑ:', error);
                showMessage('childError', 'ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ: ' + error.message);
            }
        });

        // ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©
        function initMap() {
            console.log('ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©');
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 13,
                center: { lat: 24.7136, lng: 46.6753 }, // ÿßŸÑÿ±Ÿäÿßÿ∂
                mapTypeId: 'roadmap',
                styles: [
                    {
                        featureType: 'poi',
                        elementType: 'labels',
                        stylers: [{ visibility: 'off' }]
                    }
                ]
            });
        }

        // ÿ™ÿ≠ŸÖŸäŸÑ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ£ÿ∑ŸÅÿßŸÑ
        function loadChildren() {
            if (!currentUser || userType !== 'parent') return;
            
            console.log('ÿ™ÿ≠ŸÖŸäŸÑ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ£ÿ∑ŸÅÿßŸÑ');
            const childrenList = document.getElementById('childrenList');
            
            db.collection('children')
                .where('parentId', '==', currentUser.uid)
                .onSnapshot((snapshot) => {
                    childrenList.innerHTML = '';
                    markers = {};
                    
                    if (snapshot.empty) {
                        childrenList.innerHTML = '<div class="loading">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ£ÿ∑ŸÅÿßŸÑ ŸÖÿ≥ÿ¨ŸÑŸäŸÜ ÿ®ÿπÿØ</div>';
                        return;
                    }
                    
                    snapshot.forEach((doc) => {
                        const child = doc.data();
                        const childId = doc.id;
                        
                        const childItem = document.createElement('div');
                        childItem.className = 'child-item';
                        
                        const lastUpdateText = child.lastUpdate ? 
                            new Date(child.lastUpdate.toDate()).toLocaleString('ar-SA') : 
                            'ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ÿ®ÿπÿØ';
                        
                        childItem.innerHTML = `
                            <div class="child-name">${child.name}</div>
                            <div class="child-status">${child.isOnline ? 'üü¢ ŸÖÿ™ÿµŸÑ' : 'üî¥ ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ'}</div>
                            <div style="font-size: 12px; margin-top: 5px;">
                                ÿ¢ÿÆÿ± ÿ™ÿ≠ÿØŸäÿ´: ${lastUpdateText}
                            </div>
                            ${child.provider === 'google' ? '<div style="font-size: 10px; color: #4285f4;">üìß Google</div>' : ''}
                        `;
                        
                        childItem.addEventListener('click', () => {
                            focusOnChild(childId, child);
                            document.querySelectorAll('.child-item').forEach(item => {
                                item.classList.remove('active');
                            });
                            childItem.classList.add('active');
                        });
                        
                        childrenList.appendChild(childItem);
                        
                        if (child.location) {
                            addChildMarker(childId, child);
                        }
                    });
                });
        }

        // ÿ•ÿ∂ÿßŸÅÿ© ÿπŸÑÿßŸÖÿ© ÿßŸÑÿ∑ŸÅŸÑ ÿπŸÑŸâ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©
        function addChildMarker(childId, child) {
            if (!child.location || !map) return;
            
            const position = {
                lat: child.location.latitude,
                lng: child.location.longitude
            };
            
            if (markers[childId]) {
                markers[childId].setMap(null);
            }
            
            const marker = new google.maps.Marker({
                position: position,
                map: map,
                title: child.name,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 15,
                    fillColor: child.isOnline ? '#4CAF50' : '#f44336',
                    fillOpacity: 1,
                    strokeColor: '#ffffff',
                    strokeWeight: 3
                }
            });
            
            const infoWindow = new google.maps.InfoWindow({
                content: `
                    <div style="text-align: center; direction: rtl; font-family: Arial;">
                        <h3 style="margin: 0 0 10px 0; color: #333;">${child.name}</h3>
                        <p style="margin: 5px 0;"><strong>ÿßŸÑÿ≠ÿßŸÑÿ©:</strong> ${child.isOnline ? 'üü¢ ŸÖÿ™ÿµŸÑ' : 'üî¥ ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ'}</p>
                        <p style="margin: 5px 0;"><strong>ÿ¢ÿÆÿ± ÿ™ÿ≠ÿØŸäÿ´:</strong><br>${child.lastUpdate ? new Date(child.lastUpdate.toDate()).toLocaleString('ar-SA') : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</p>
                        <p style="margin: 5px 0; font-size: 12px; color: #666;">
                            <strong>ÿßŸÑÿ•ÿ≠ÿØÿßÿ´Ÿäÿßÿ™:</strong><br>
                            ${position.lat.toFixed(6)}, ${position.lng.toFixed(6)}
                        </p>
                        ${child.accuracy ? `<p style="margin: 5px 0; font-size: 12px; color: #666;"><strong>ÿØŸÇÿ© ÿßŸÑŸÖŸàŸÇÿπ:</strong> ${Math.round(child.accuracy)} ŸÖÿ™ÿ±</p>` : ''}
                        ${child.provider === 'google' ? '<p style="margin: 5px 0; font-size: 10px; color: #4285f4;">ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ŸÄ Google</p>' : ''}
                    </div>
                `
            });
            
            marker.addListener('click', () => {
                Object.values(markers).forEach(m => {
                    if (m.infoWindow) {
                        m.infoWindow.close();
                    }
                });
                infoWindow.open(map, marker);
            });
            
            marker.infoWindow = infoWindow;
            markers[childId] = marker;
        }

        // ÿßŸÑÿ™ÿ±ŸÉŸäÿ≤ ÿπŸÑŸâ ÿ∑ŸÅŸÑ ŸÖÿπŸäŸÜ
        function focusOnChild(childId, child) {
            if (child.location && map) {
                const position = {
                    lat: child.location.latitude,
                    lng: child.location.longitude
                };
                
                map.setCenter(position);
                map.setZoom(16);
                
                if (markers[childId]) {
                    google.maps.event.trigger(markers[childId], 'click');
                }
            } else {
                showNotification('ŸÖŸàŸÇÿπ Ÿáÿ∞ÿß ÿßŸÑÿ∑ŸÅŸÑ ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ± ÿ≠ÿßŸÑŸäÿßŸã', true);
            }
        }

        // ÿ®ÿØÿ° ÿ™ÿ™ÿ®ÿπ ŸÖŸàŸÇÿπ ÿßŸÑÿ∑ŸÅŸÑ
        function startLocationTracking(childId) {
            console.log('ÿ®ÿØÿ° ÿ™ÿ™ÿ®ÿπ ÿßŸÑŸÖŸàŸÇÿπ ŸÑŸÑÿ∑ŸÅŸÑ:', childId);
            
            if (!navigator.geolocation) {
                updateLocationStatus('ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ ŸÑÿß ŸäÿØÿπŸÖ ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ', 'error');
                return;
            }
            
            updateLocationStatus('ÿ¨ÿßÿ±Ÿä ÿ∑ŸÑÿ® ÿ•ÿ∞ŸÜ ÿßŸÑŸàÿµŸàŸÑ ŸÑŸÑŸÖŸàŸÇÿπ...', 'info');
            
            const options = {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 30000
            };
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    updateLocationStatus('ÿ™ŸÖ ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑÿ•ÿ∞ŸÜ - ÿ®ÿØÿ° ÿßŸÑÿ™ÿ™ÿ®ÿπ...', 'info');
                    
                    locationWatchId = navigator.geolocation.watchPosition(
                        (position) => {
                            const lat = position.coords.latitude;
                            const lng = position.coords.longitude;
                            const accuracy = position.coords.accuracy;
                            
                            // ÿ≠ŸÅÿ∏ ŸÅŸä Firestore
                            db.collection('children').doc(childId).update({
                                location: new firebase.firestore.GeoPoint(lat, lng),
                                lastUpdate: firebase.firestore.FieldValue.serverTimestamp(),
                                isOnline: true,
                                accuracy: accuracy
                            }).then(() => {
                                updateLocationStatus('‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ŸÖŸàŸÇÿπŸÉ ÿ®ŸÜÿ¨ÿßÿ≠', 'success');
                                document.getElementById('latitude').textContent = lat.toFixed(6);
                                document.getElementById('longitude').textContent = lng.toFixed(6);
                                document.getElementById('lastUpdate').textContent = new Date().toLocaleString('ar-SA');
                                document.getElementById('accuracy').textContent = Math.round(accuracy);
                                
                                showNotification('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸàŸÇÿπ ÿ®ŸÜÿ¨ÿßÿ≠');
                            }).catch((error) => {
                                updateLocationStatus('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸàŸÇÿπ', 'error');
                                showNotification('ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸàŸÇÿπ', true);
                            });

                            // ÿ≠ŸÅÿ∏ ŸÅŸä Realtime Database ÿ£Ÿäÿ∂ÿßŸã ŸÑŸÑÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÅŸàÿ±Ÿä
                            database.ref('locations/' + childId).set({
                                latitude: lat,
                                longitude: lng,
                                accuracy: accuracy,
                                timestamp: firebase.database.ServerValue.TIMESTAMP,
                                isOnline: true
                            });
                        },
                        (error) => {
                            let errorMessage = 'ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ: ';
                            switch(error.code) {
                                case error.PERMISSION_DENIED:
                                    errorMessage += 'ÿ™ŸÖ ÿ±ŸÅÿ∂ ÿßŸÑÿ•ÿ∞ŸÜ ŸÑÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ';
                                    break;
                                case error.POSITION_UNAVAILABLE:
                                    errorMessage += 'ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖŸàŸÇÿπ ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±ÿ©';
                                    break;
                                case error.TIMEOUT:
                                    errorMessage += 'ÿßŸÜÿ™Ÿáÿ™ ŸÖŸáŸÑÿ© ÿ∑ŸÑÿ® ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ';
                                    break;
                                default:
                                    errorMessage += 'ÿÆÿ∑ÿ£ ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ';
                                    break;
                            }
                            updateLocationStatus(errorMessage, 'error');
                            showNotification(errorMessage, true);
                        },
                        options
                    );
                },
                (error) => {
                    updateLocationStatus('Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ≥ŸÖÿßÿ≠ ÿ®ÿßŸÑŸàÿµŸàŸÑ ŸÑŸÑŸÖŸàŸÇÿπ ŸÑÿ™ÿ™ŸÖŸÉŸÜ ŸÖŸÜ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©', 'warning');
                    showNotification('Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ≥ŸÖÿßÿ≠ ÿ®ÿßŸÑŸàÿµŸàŸÑ ŸÑŸÑŸÖŸàŸÇÿπ', true);
                }
            );
        }

        // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨
        async function logout() {
            try {
                // ÿ•ŸäŸÇÿßŸÅ ÿ™ÿ™ÿ®ÿπ ÿßŸÑŸÖŸàŸÇÿπ
                if (locationWatchId) {
                    navigator.geolocation.clearWatch(locationWatchId);
                    locationWatchId = null;
                }
                
                // ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ
                if (userType === 'child' && currentUser) {
                    await db.collection('children').doc(currentUser.uid).update({
                        isOnline: false,
                        lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // ÿ™ÿ≠ÿØŸäÿ´ Realtime Database
                    await database.ref('locations/' + currentUser.uid).update({
                        isOnline: false,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    });
                }
                
                // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ ŸÖŸÜ Firebase Auth
                await auth.signOut();
                
                // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™
                currentUser = null;
                userType = null;
                markers = {};
                
                // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÜŸÖÿßÿ∞ÿ¨
                document.getElementById('parentForm').reset();
                document.getElementById('childForm').reset();
                
                // ÿ•ÿÆŸÅÿßÿ° ÿ±ÿ≥ÿßÿ¶ŸÑ ÿßŸÑÿÆÿ∑ÿ£ ŸàÿßŸÑŸÜÿ¨ÿßÿ≠
                document.querySelectorAll('.error, .success').forEach(el => {
                    el.style.display = 'none';
                });
                
                // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿπŸÜÿßÿµÿ± Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑÿ∑ŸÅŸÑ
                if (document.getElementById('locationStatus')) {
                    document.getElementById('locationStatus').textContent = 'ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ÿØŸäÿØ ŸÖŸàŸÇÿπŸÉ...';
                    document.getElementById('locationStatus').classList.add('pulse');
                    document.getElementById('latitude').textContent = '--';
                    document.getElementById('longitude').textContent = '--';
                    document.getElementById('lastUpdate').textContent = '--';
                    document.getElementById('accuracy').textContent = '--';
                }
                
                showScreen('userTypeScreen');
                showNotification('ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ ÿ®ŸÜÿ¨ÿßÿ≠');
                
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨:', error);
                showNotification('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨', true);
            }
        }

        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿµÿßÿØŸÇÿ© ÿπŸÜÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©
        auth.onAuthStateChanged((user) => {
            if (user && userType === 'parent') {
                currentUser = user;
                console.log('ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖÿ≥ÿ¨ŸÑ ÿØÿÆŸàŸÑ:', user);
            }
        });

        // ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿπŸÜÿØ ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑÿµŸÅÿ≠ÿ©
        window.addEventListener('beforeunload', async () => {
            if (userType === 'child' && currentUser) {
                try {
                    await db.collection('children').doc(currentUser.uid).update({
                        isOnline: false,
                        lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    await database.ref('locations/' + currentUser.uid).update({
                        isOnline: false,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    });
                } catch (error) {
                    console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ:', error);
                }
            }
        });

        // ÿßŸÑÿ™ÿπÿßŸÖŸÑ ŸÖÿπ ŸÅŸÇÿØÿßŸÜ ÿßŸÑÿßÿ™ÿµÿßŸÑ
        window.addEventListener('online', () => {
            if (userType === 'child' && currentUser) {
                db.collection('children').doc(currentUser.uid).update({
                    isOnline: true,
                    lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => {
                    updateLocationStatus('üîÑ ÿ™ŸÖ ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ - ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸàŸÇÿπ...', 'info');
                    // ÿ•ÿπÿßÿØÿ© ÿ®ÿØÿ° ÿ™ÿ™ÿ®ÿπ ÿßŸÑŸÖŸàŸÇÿπ
                    if (!locationWatchId) {
                        startLocationTracking(currentUser.uid);
                    }
                });
            }
        });

        window.addEventListener('offline', () => {
            if (userType === 'child' && currentUser) {
                updateLocationStatus('‚ö†Ô∏è ŸÑÿß ŸäŸàÿ¨ÿØ ÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™ - ÿ≥Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸàŸÇÿπ ÿπŸÜÿØ ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ', 'warning');
            }
        });

        // ÿ™ÿ≠ÿØŸäÿ´ ÿØŸàÿ±Ÿä ŸÑÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ (ŸÉŸÑ 30 ÿ´ÿßŸÜŸäÿ©)
        setInterval(() => {
            if (userType === 'child' && currentUser && navigator.onLine) {
                db.collection('children').doc(currentUser.uid).update({
                    lastUpdate: firebase.firestore.FieldValue.serverTimestamp(),
                    isOnline: true
                }).catch(error => {
                    console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿØŸàÿ±Ÿä:', error);
                });
                
                database.ref('locations/' + currentUser.uid).update({
                    isOnline: true,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                }).catch(error => {
                    console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ Realtime Database:', error);
                });
            }
        }, 30000);

        // ŸÖÿ±ÿßŸÇÿ®ÿ© ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ÿßÿ™ ÿßŸÑŸÅŸàÿ±Ÿäÿ© ŸÑŸÑŸÖŸàÿßŸÇÿπ (ŸÑŸÑŸàÿßŸÑÿØŸäŸÜ)
        function watchRealtimeLocations() {
            if (userType !== 'parent' || !currentUser) return;
            
            database.ref('locations').on('child_changed', (snapshot) => {
                const childId = snapshot.key;
                const locationData = snapshot.val();
                
                // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ£ŸÜ Ÿáÿ∞ÿß ÿßŸÑÿ∑ŸÅŸÑ ŸäŸÜÿ™ŸÖŸä ŸÑŸàŸÑŸä ÿßŸÑÿ£ŸÖÿ± ÿßŸÑÿ≠ÿßŸÑŸä
                db.collection('children').doc(childId).get().then((doc) => {
                    if (doc.exists && doc.data().parentId === currentUser.uid) {
                        const child = doc.data();
                        child.location = {
                            latitude: locationData.latitude,
                            longitude: locationData.longitude
                        };
                        child.accuracy = locationData.accuracy;
                        child.isOnline = locationData.isOnline;
                        
                        // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿπŸÑÿßŸÖÿ© ÿπŸÑŸâ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©
                        addChildMarker(childId, child);
                    }
                });
            });
        }

        // ÿ®ÿØÿ° ŸÖÿ±ÿßŸÇÿ®ÿ© ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ÿßÿ™ ÿßŸÑŸÅŸàÿ±Ÿäÿ© ÿπŸÜÿØ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ ÿßŸÑŸàÿßŸÑÿØ
        auth.onAuthStateChanged((user) => {
            if (user && userType === 'parent') {
                watchRealtimeLocations();
            }
        });

        // ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿπÿßŸÑÿ¨ ŸÑŸÑÿ£ÿÆÿ∑ÿßÿ° ÿßŸÑÿπÿßŸÖÿ©
        window.addEventListener('error', (e) => {
            console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ:', e.error);
            showNotification('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÇÿπ', true);
        });

        // ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿπÿßŸÑÿ¨ ŸÑŸÑŸàÿπŸàÿØ ÿßŸÑŸÖÿ±ŸÅŸàÿ∂ÿ©
        window.addEventListener('unhandledrejection', (e) => {
            console.error('ŸàÿπÿØ ŸÖÿ±ŸÅŸàÿ∂:', e.reason);
            showNotification('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ', true);
        });

        // ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸäÿ≤ÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑŸÖÿ™ŸÇÿØŸÖÿ©
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        console.log('ÿ™ŸÖ ŸÖŸÜÿ≠ ÿ•ÿ∞ŸÜ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™');
                    }
                });
            }
        }

        // ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ±
        function sendNotification(title, body, icon = null) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, {
                    body: body,
                    icon: icon || '/favicon.ico',
                    dir: 'rtl',
                    lang: 'ar'
                });
            }
        }

        // ÿ∑ŸÑÿ® ÿ•ÿ∞ŸÜ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿπŸÜÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©
        document.addEventListener('DOMContentLoaded', () => {
            requestNotificationPermission();
        });

        // ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸäÿ≤ÿ© ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ≠ŸÑŸäÿßŸã
        function saveToLocalStorage(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ≠ŸÑŸäÿßŸã:', error);
            }
        }

        function getFromLocalStorage(key) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ©:', error);
                return null;
            }
        }

        // ÿ≠ŸÅÿ∏ ÿ¢ÿÆÿ± ŸÖŸàŸÇÿπ ŸÖÿ≠ŸÑŸäÿßŸã
        function saveLastLocation(childId, location) {
            saveToLocalStorage(`lastLocation_${childId}`, {
                ...location,
                timestamp: Date.now()
            });
        }

        // ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ÿ¢ÿÆÿ± ŸÖŸàŸÇÿπ ŸÖÿ≠ŸÅŸàÿ∏
        function getLastLocation(childId) {
            return getFromLocalStorage(`lastLocation_${childId}`);
        }

        console.log('ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ÿ®ŸÜÿ¨ÿßÿ≠ ŸÖÿπ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ŸÄ Google');
    </script>
</body>
</html>

</html>


