<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ·Ø¨ÙŠÙ‚ ØªØªØ¨Ø¹ Ø§Ù„Ø£Ø·ÙØ§Ù„</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBFw0Qbyq9zTFTd-tUY6dpoWcMAoHurN_4&libraries=geometry"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            direction: rtl;
        }

        .screen {
            display: none;
            min-height: 100vh;
        }

        .screen.active {
            display: block;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-top: 50px;
        }

        h1, h2 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }

        .user-type-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .btn-parent {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            flex-direction: column;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 150px;
        }

        .btn-child {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
            flex-direction: column;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 150px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            width: 100%;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            width: 100%;
            margin-top: 10px;
        }

        .btn-google {
            background: #db4437;
            color: white;
            width: 100%;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-logout {
            background: #dc3545;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .header {
            background: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .dashboard-container {
            display: flex;
            height: calc(100vh - 80px);
        }

        .sidebar {
            width: 300px;
            background: white;
            padding: 20px;
            overflow-y: auto;
            border-left: 1px solid #ddd;
        }

        .children-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .child-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .child-item:hover {
            background: #e9ecef;
            transform: translateX(-5px);
        }

        .child-item.active {
            background: #667eea;
            color: white;
            border-color: #5a6fd8;
        }

        .child-name {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 5px;
        }

        .child-status {
            font-size: 14px;
            opacity: 0.8;
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .location-status {
            text-align: center;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 15px;
            margin: 20px 0;
        }

        .location-info {
            margin-top: 20px;
            text-align: right;
        }

        .location-info p {
            margin: 10px 0;
            font-size: 16px;
        }

        .location-info span {
            font-weight: bold;
            color: #667eea;
        }

        .divider {
            text-align: center;
            margin: 20px 0;
            position: relative;
        }

        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #ddd;
        }

        .divider span {
            background: white;
            padding: 0 15px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.error {
            background: #f44336;
        }

        .google-icon {
            width: 20px;
            height: 20px;
        }

        .auth-mode-toggle {
            text-align: center;
            margin: 20px 0;
        }

        .auth-mode-toggle button {
            background: none;
            border: none;
            color: #667eea;
            text-decoration: underline;
            cursor: pointer;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .dashboard-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 200px;
            }
            
            .user-type-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .btn-parent, .btn-child {
                min-width: 200px;
            }
        }
    </style>
</head>
<body>
    <!-- Ø´Ø§Ø´Ø© Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
    <div id="userTypeScreen" class="screen active">
        <div class="container">
            <h1>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ ØªØªØ¨Ø¹ Ø§Ù„Ø£Ø·ÙØ§Ù„</h1>
            <div class="user-type-buttons">
                <button class="btn btn-parent" id="parentBtn">
                    <span style="font-size: 30px;">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</span>
                    ÙˆÙ„ÙŠ Ø£Ù…Ø±
                </button>
                <button class="btn btn-child" id="childBtn">
                    <span style="font-size: 30px;">ğŸ‘¶</span>
                    Ø·ÙÙ„
                </button>
            </div>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± -->
    <div id="parentLoginScreen" class="screen">
        <div class="container">
            <h2 id="parentFormTitle">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</h2>
            <div id="parentError" class="error" style="display: none;"></div>
            <div id="parentSuccess" class="success" style="display: none;"></div>
            
            <!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Google -->
            <button type="button" class="btn btn-google" id="parentGoogleBtn">
                <svg class="google-icon" viewBox="0 0 24 24">
                    <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Google
            </button>
            
            <div class="divider">
                <span>Ø£Ùˆ</span>
            </div>
            
            <form id="parentForm">
                <div class="form-group">
                    <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„:</label>
                    <input type="text" id="parentName" required>
                </div>
                <div class="form-group">
                    <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</label>
                    <input type="tel" id="parentPhone" required>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</label>
                    <input type="email" id="parentEmail" required>
                </div>
                <div class="form-group">
                    <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</label>
                    <input type="password" id="parentPassword" required>
                </div>
                <button type="submit" class="btn btn-primary" id="parentSubmitBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
                <div class="auth-mode-toggle">
                    <button type="button" id="parentToggleMode">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
                </div>
                <button type="button" class="btn btn-secondary" id="parentBackBtn">Ø±Ø¬ÙˆØ¹</button>
            </form>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·ÙÙ„ -->
    <div id="childLoginScreen" class="screen">
        <div class="container">
            <h2>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·ÙÙ„</h2>
            <div id="childError" class="error" style="display: none;"></div>
            <div id="childSuccess" class="success" style="display: none;"></div>
            
            <!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Google Ù„Ù„Ø·ÙÙ„ -->
            <button type="button" class="btn btn-google" id="childGoogleBtn">
                <svg class="google-icon" viewBox="0 0 24 24">
                    <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Google
            </button>
            
            <div class="divider">
                <span>Ø£Ùˆ</span>
            </div>
            
            <form id="childForm">
                <div class="form-group">
                    <label>Ø§Ø³Ù…Ùƒ:</label>
                    <input type="text" id="childName" required>
                </div>
                <div class="form-group">
                    <label>Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ:</label>
                    <input type="tel" id="childPhone" required>
                </div>
                <div class="form-group">
                    <label>Ø±Ù‚Ù… Ù‡Ø§ØªÙ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±:</label>
                    <input type="tel" id="parentPhoneForChild" required>
                </div>
                <button type="submit" class="btn btn-primary">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
                <button type="button" class="btn btn-secondary" id="childBackBtn">Ø±Ø¬ÙˆØ¹</button>
            </form>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± - Ø§Ù„Ø®Ø±ÙŠØ·Ø© -->
    <div id="parentDashboard" class="screen">
        <div class="header">
            <h2 id="parentWelcome">Ù…Ø±Ø­Ø¨Ø§Ù‹</h2>
            <button class="btn btn-logout" id="parentLogoutBtn">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
        </div>
        
        <div class="dashboard-container">
            <div class="sidebar">
                <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø·ÙØ§Ù„</h3>
                <div id="childrenList" class="children-list">
                    <div class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø·ÙØ§Ù„...</div>
                </div>
            </div>
            
            <div class="map-container">
                <div id="map"></div>
            </div>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø·ÙÙ„ - Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹ -->
    <div id="childDashboard" class="screen">
        <div class="container">
            <h2 id="childWelcome">Ù…Ø±Ø­Ø¨Ø§Ù‹</h2>
            <div class="location-status">
                <p id="locationStatus" class="pulse">Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ...</p>
                <div class="location-info">
                    <p>Ø®Ø· Ø§Ù„Ø¹Ø±Ø¶: <span id="latitude">--</span></p>
                    <p>Ø®Ø· Ø§Ù„Ø·ÙˆÙ„: <span id="longitude">--</span></p>
                    <p>Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: <span id="lastUpdate">--</span></p>
                    <p>Ø¯Ù‚Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹: <span id="accuracy">--</span> Ù…ØªØ±</p>
                </div>
            </div>
            <button class="btn btn-logout" id="childLogoutBtn">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
        </div>
    </div>

    <script>
        // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
        let map;
        let markers = {};
        let currentUser = null;
        let userType = null;
        let locationWatchId = null;
        let isSignUpMode = false; // Ù„Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨

        // Ø¥Ø¹Ø¯Ø§Ø¯ Firebase Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ
        const firebaseConfig = {
            apiKey: "AIzaSyCwuWnFl3cGetmrNlWxcU5NT_mHQQzkEqo",
            authDomain: "familytracker-77ec8.firebaseapp.com",
            databaseURL: "https://familytracker-77ec8-default-rtdb.firebaseio.com",
            projectId: "familytracker-77ec8",
            storageBucket: "familytracker-77ec8.firebasestorage.app",
            messagingSenderId: "527698679661",
            appId: "1:527698679661:web:af62a9327797646c3c2c64",
            measurementId: "G-B8ZYB634DN"
        };

        // ØªÙ‡ÙŠØ¦Ø© Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const database = firebase.database();

        // Ø¥Ø¹Ø¯Ø§Ø¯ Google Auth Provider
        const googleProvider = new firebase.auth.GoogleAuthProvider();
        googleProvider.addScope('profile');
        googleProvider.addScope('email');

        // Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø§Ø´Ø§Øª
        function showScreen(screenId) {
            console.log('Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø§Ø´Ø©:', screenId);
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø·Ø£ ÙˆØ§Ù„Ù†Ø¬Ø§Ø­
        function showMessage(elementId, message, isError = true) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.style.display = 'block';
                setTimeout(() => {
                    element.style.display = 'none';
                }, 5000);
            }
        }

        // Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        function showNotification(message, isError = false) {
            const notification = document.createElement('div');
            notification.className = `notification ${isError ? 'error' : ''}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨
        function updateAuthMode() {
            const title = document.getElementById('parentFormTitle');
            const submitBtn = document.getElementById('parentSubmitBtn');
            const toggleBtn = document.getElementById('parentToggleMode');
            
            if (isSignUpMode) {
                title.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ ÙˆÙ„ÙŠ Ø£Ù…Ø± Ø¬Ø¯ÙŠØ¯';
                submitBtn.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨';
                toggleBtn.textContent = 'Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
            } else {
                title.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±';
                submitBtn.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
                toggleBtn.textContent = 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯';
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹
        function updateLocationStatus(message, type = 'info') {
            const statusElement = document.getElementById('locationStatus');
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.className = 'pulse';
                
                switch(type) {
                    case 'success':
                        statusElement.style.color = '#4CAF50';
                        statusElement.classList.remove('pulse');
                        break;
                    case 'error':
                        statusElement.style.color = '#f44336';
                        statusElement.classList.remove('pulse');
                        break;
                    case 'warning':
                        statusElement.style.color = '#ff9800';
                        statusElement.classList.remove('pulse');
                        break;
                    default:
                        statusElement.style.color = '#333';
                        break;
                }
            }
        }

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©');

            // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
            document.getElementById('parentBtn')?.addEventListener('click', () => {
                showScreen('parentLoginScreen');
            });

            document.getElementById('childBtn')?.addEventListener('click', () => {
                showScreen('childLoginScreen');
            });

            // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹
            document.getElementById('parentBackBtn')?.addEventListener('click', () => {
                showScreen('userTypeScreen');
            });

            document.getElementById('childBackBtn')?.addEventListener('click', () => {
                showScreen('userTypeScreen');
            });

            // Ø£Ø²Ø±Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
            document.getElementById('parentLogoutBtn')?.addEventListener('click', logout);
            document.getElementById('childLogoutBtn')?.addEventListener('click', logout);

            // Ø£Ø²Ø±Ø§Ø± Google
            document.getElementById('parentGoogleBtn')?.addEventListener('click', () => signInWithGoogle('parent'));
            document.getElementById('childGoogleBtn')?.addEventListener('click', () => signInWithGoogle('child'));

            // Ø²Ø± Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨
            document.getElementById('parentToggleMode')?.addEventListener('click', () => {
                isSignUpMode = !isSignUpMode;
                updateAuthMode();
                // Ø¥Ø®ÙØ§Ø¡ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø·Ø£
                document.getElementById('parentError').style.display = 'none';
                document.getElementById('parentSuccess').style.display = 'none';
            });
        });

        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Google
        async function signInWithGoogle(type) {
            try {
                console.log('Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Google Ù„Ù„Ù†ÙˆØ¹:', type);
                
                const result = await auth.signInWithPopup(googleProvider);
                const user = result.user;
                
                console.log('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Google Ø¨Ù†Ø¬Ø§Ø­:', user);
                
                currentUser = user;
                userType = type;
                
                if (type === 'parent') {
                    // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±
                    await db.collection('parents').doc(user.uid).set({
                        name: user.displayName,
                        email: user.email,
                        phone: user.phoneNumber || '',
                        photoURL: user.photoURL,
                        provider: 'google',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                    
                    showMessage('parentSuccess', 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Google Ø¨Ù†Ø¬Ø§Ø­', false);
                    document.getElementById('parentWelcome').textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${user.displayName}`;
                    
                    setTimeout(() => {
                        showScreen('parentDashboard');
                        initMap();
                        loadChildren();
                    }, 1000);
                    
                } else if (type === 'child') {
                    // Ù„Ù„Ø·ÙÙ„ØŒ Ù†Ø­ØªØ§Ø¬ Ù„Ø±Ø¨Ø·Ù‡ Ø¨ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±
                    showChildGoogleSetup(user);
                }
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Google:', error);
                const errorElementId = type === 'parent' ? 'parentError' : 'childError';
                
                let errorMessage = 'Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Google: ';
                if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = 'ØªÙ… Ø¥Ù„ØºØ§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
                } else if (error.code === 'auth/popup-blocked') {
                    errorMessage = 'ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©';
                } else {
                    errorMessage += error.message;
                }
                
                showMessage(errorElementId, errorMessage);
            }
        }

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø·ÙÙ„ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Google
        function showChildGoogleSetup(user) {
            const parentPhone = prompt('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±:');
            if (!parentPhone) {
                showMessage('childError', 'ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±');
                return;
            }
            
            setupChildWithGoogle(user, parentPhone);
        }

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø·ÙÙ„ Ù…Ø¹ Google
        async function setupChildWithGoogle(user, parentPhone) {
            try {
                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±
                const parentQuery = await db.collection('parents')
                    .where('phone', '==', parentPhone)
                    .get();
                
                if (parentQuery.empty) {
                    showMessage('childError', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…');
                    return;
                }
                
                const parentDoc = parentQuery.docs[0];
                const parentId = parentDoc.id;
                
                // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„
                const childData = {
                    name: user.displayName,
                    email: user.email,
                    phone: user.phoneNumber || '',
                    photoURL: user.photoURL,
                    parentId: parentId,
                    provider: 'google',
                    lastUpdate: firebase.firestore.FieldValue.serverTimestamp(),
                    isOnline: true
                };
                
                await db.collection('children').doc(user.uid).set(childData, { merge: true });
                
                currentUser = { uid: user.uid, name: user.displayName };
                showMessage('childSuccess', 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Google Ø¨Ù†Ø¬Ø§Ø­', false);
                document.getElementById('childWelcome').textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${user.displayName}`;
                
                setTimeout(() => {
                    showScreen('childDashboard');
                    startLocationTracking(user.uid);
                }, 1000);
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø·ÙÙ„:', error);
                showMessage('childError', 'Ø®Ø·Ø£ ÙÙŠ Ø±Ø¨Ø· Ø§Ù„Ø­Ø³Ø§Ø¨: ' + error.message);
            }
        }

        // ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
        document.getElementById('parentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±');
            
            const name = document.getElementById('parentName').value;
            const phone = document.getElementById('parentPhone').value;
            const email = document.getElementById('parentEmail').value;
            const password = document.getElementById('parentPassword').value;
            
            try {
                let userCredential;
                
                if (isSignUpMode) {
                    // Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯
                    try {
                        userCredential = await auth.createUserWithEmailAndPassword(email, password);
                        
                        // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±
                        await db.collection('parents').doc(userCredential.user.uid).set({
                            name: name,
                            phone: phone,
                            email: email,
                            provider: 'email',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        showMessage('parentSuccess', 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­', false);
                        
                    } catch (signUpError) {
                        if (signUpError.code === 'auth/email-already-in-use') {
                            showMessage('parentError', 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„. ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯.');
                            return;
                        } else if (signUpError.code === 'auth/weak-password') {
                            showMessage('parentError', 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ©. ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.');
                            return;
                        } else if (signUpError.code === 'auth/invalid-email') {
                            showMessage('parentError', 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­.');
                            return;
                        } else {
                            throw signUpError;
                        }
                    }
                } else {
                    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                    try {
                        userCredential = await auth.signInWithEmailAndPassword(email, password);
                        
                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
                        await db.collection('parents').doc(userCredential.user.uid).set({
                            name: name,
                            phone: phone,
                            email: email,
                            provider: 'email',
                            lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                        }, { merge: true });
                        
                        showMessage('parentSuccess', 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­', false);
                        
                    } catch (signInError) {
                        if (signInError.code === 'auth/user-not-found') {
                            showMessage('parentError', 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ. ÙŠØ±Ø¬Ù‰ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯.');
                            return;
                        } else if (signInError.code === 'auth/wrong-password') {
                            showMessage('parentError', 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.');
                            return;
                        } else if (signInError.code === 'auth/invalid-email') {
                            showMessage('parentError', 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­.');
                            return;
                        } else if (signInError.code === 'auth/too-many-requests') {
                            showMessage('parentError', 'ØªÙ… ØªØ¬Ø§ÙˆØ² Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹.');
                            return;
                        } else {
                            throw signInError;
                        }
                    }
                }
                
                currentUser = userCredential.user;
                userType = 'parent';
                
                document.getElementById('parentWelcome').textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${name}`;
                
                setTimeout(() => {
                    showScreen('parentDashboard');
                    initMap();
                    loadChildren();
                }, 1000);
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:', error);
                let errorMessage = 'Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ';
                
                if (error.code === 'auth/network-request-failed') {
                    errorMessage = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';
                } else if (error.code === 'auth/invalid-credential') {
                    errorMessage = 'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©.';
                } else {
                    errorMessage += error.message;
                }
                
                showMessage('parentError', errorMessage);
            }
        });

        // ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·ÙÙ„ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
        document.getElementById('childForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·ÙÙ„');
            
            const childName = document.getElementById('childName').value;
            const childPhone = document.getElementById('childPhone').value;
            const parentPhone = document.getElementById('parentPhoneForChild').value;
            
            try {
                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±
                const parentQuery = await db.collection('parents')
                    .where('phone', '==', parentPhone)
                    .get();
                
                if (parentQuery.empty) {
                    showMessage('childError', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…');
                    return;
                }
                
                const parentDoc = parentQuery.docs[0];
                const parentId = parentDoc.id;
                
                const childData = {
                    name: childName,
                    phone: childPhone,
                    parentId: parentId,
                    provider: 'manual',
                    lastUpdate: firebase.firestore.FieldValue.serverTimestamp(),
                    isOnline: true
                };
                
                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø·ÙÙ„ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙŠØ¯
                const childQuery = await db.collection('children')
                    .where('phone', '==', childPhone)
                    .where('parentId', '==', parentId)
                    .get();
                
                let childId;
                if (childQuery.empty) {
                    const childRef = await db.collection('children').add(childData);
                    childId = childRef.id;
                } else {
                    childId = childQuery.docs[0].id;
                    await db.collection('children').doc(childId).update(childData);
                }
                
                currentUser = { uid: childId, name: childName };
                userType = 'child';
                
                showMessage('childSuccess', 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­', false);
                document.getElementById('childWelcome').textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${childName}`;
                
                setTimeout(() => {
                    showScreen('childDashboard');
                    startLocationTracking(childId);
                }, 1000);
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·ÙÙ„:', error);
                let errorMessage = 'Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ';
                
                if (error.code === 'permission-denied') {
                    errorMessage = 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„ÙˆØµÙˆÙ„. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.';
                } else if (error.code === 'unavailable') {
                    errorMessage = 'Ø§Ù„Ø®Ø¯Ù…Ø© ØºÙŠØ± Ù…ØªÙˆÙØ±Ø© Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹.';
                } else {
                    errorMessage += error.message;
                }
                
                showMessage('childError', errorMessage);
            }
        });

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø©
        function initMap() {
            console.log('ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø©');
            
            if (typeof google === 'undefined' || !google.maps) {
                console.error('Google Maps API ØºÙŠØ± Ù…Ø­Ù…Ù„Ø©');
                showNotification('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø©', true);
                return;
            }
            
            try {
                map = new google.maps.Map(document.getElementById('map'), {
                    zoom: 13,
                    center: { lat: 24.7136, lng: 46.6753 }, // Ø§Ù„Ø±ÙŠØ§Ø¶
                    mapTypeId: 'roadmap',
                    styles: [
                        {
                            featureType: 'poi',
                            elementType: 'labels',
                            stylers: [{ visibility: 'off' }]
                        }
                    ]
                });
                
                console.log('ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¨Ù†Ø¬Ø§Ø­');
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø©:', error);
                showNotification('Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø©', true);
            }
        }

        // ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø·ÙØ§Ù„
        function loadChildren() {
            if (!currentUser || userType !== 'parent') return;
            
            console.log('ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø·ÙØ§Ù„');
            const childrenList = document.getElementById('childrenList');
            
            // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„ÙÙˆØ±ÙŠØ©
            const unsubscribe = db.collection('children')
                .where('parentId', '==', currentUser.uid)
                .onSnapshot((snapshot) => {
                    childrenList.innerHTML = '';
                    markers = {};
                    
                    if (snapshot.empty) {
                        childrenList.innerHTML = '<div class="loading">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø·ÙØ§Ù„ Ù…Ø³Ø¬Ù„ÙŠÙ† Ø¨Ø¹Ø¯</div>';
                        return;
                    }
                    
                    snapshot.forEach((doc) => {
                        const child = doc.data();
                        const childId = doc.id;
                        
                        const childItem = document.createElement('div');
                        childItem.className = 'child-item';
                        
                        const lastUpdateText = child.lastUpdate ? 
                            new Date(child.lastUpdate.toDate()).toLocaleString('ar-SA') : 
                            'Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ø¹Ø¯';
                        
                        const providerIcon = child.provider === 'google' ? 'ğŸ“§' : 'ğŸ“±';
                        const providerText = child.provider === 'google' ? 'Google' : 'ÙŠØ¯ÙˆÙŠ';
                        
                        childItem.innerHTML = `
                            <div class="child-name">${child.name}</div>
                            <div class="child-status">${child.isOnline ? 'ğŸŸ¢ Ù…ØªØµÙ„' : 'ğŸ”´ ØºÙŠØ± Ù…ØªØµÙ„'}</div>
                            <div style="font-size: 12px; margin-top: 5px;">
                                Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${lastUpdateText}
                            </div>
                            <div style="font-size: 10px; color: #666; margin-top: 3px;">
                                ${providerIcon} ${providerText}
                            </div>
                        `;
                        
                        childItem.addEventListener('click', () => {
                            focusOnChild(childId, child);
                            document.querySelectorAll('.child-item').forEach(item => {
                                item.classList.remove('active');
                            });
                            childItem.classList.add('active');
                        });
                        
                        childrenList.appendChild(childItem);
                        
                        if (child.location) {
                            addChildMarker(childId, child);
                        }
                    });
                }, (error) => {
                    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø·ÙØ§Ù„:', error);
                    childrenList.innerHTML = '<div class="loading" style="color: red;">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>';
                });
        }

        // Ø¥Ø¶Ø§ÙØ© Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ø·ÙÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
        function addChildMarker(childId, child) {
            if (!child.location || !map) return;
            
            try {
                const position = {
                    lat: child.location.latitude,
                    lng: child.location.longitude
                };
                
                // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¥Ù† ÙˆØ¬Ø¯Øª
                if (markers[childId]) {
                    markers[childId].setMap(null);
                }
                
                const marker = new google.maps.Marker({
                    position: position,
                    map: map,
                    title: child.name,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 15,
                        fillColor: child.isOnline ? '#4CAF50' : '#f44336',
                        fillOpacity: 1,
                        strokeColor: '#ffffff',
                        strokeWeight: 3
                    }
                });
                
                const providerText = child.provider === 'google' ? 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Google' : 'ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ÙŠØ¯ÙˆÙŠ';
                
                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="text-align: center; direction: rtl; font-family: Arial;">
                            <h3 style="margin: 0 0 10px 0; color: #333;">${child.name}</h3>
                            <p style="margin: 5px 0;"><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${child.isOnline ? 'ğŸŸ¢ Ù…ØªØµÙ„' : 'ğŸ”´ ØºÙŠØ± Ù…ØªØµÙ„'}</p>
                            <p style="margin: 5px 0;"><strong>Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«:</strong><br>${child.lastUpdate ? new Date(child.lastUpdate.toDate()).toLocaleString('ar-SA') : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                            <p style="margin: 5px 0; font-size: 12px; color: #666;">
                                <strong>Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª:</strong><br>
                                ${position.lat.toFixed(6)}, ${position.lng.toFixed(6)}
                            </p>
                            ${child.accuracy ? `<p style="margin: 5px 0; font-size: 12px; color: #666;"><strong>Ø¯Ù‚Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹:</strong> ${Math.round(child.accuracy)} Ù…ØªØ±</p>` : ''}
                            <p style="margin: 5px 0; font-size: 10px; color: #4285f4;">${providerText}</p>
                        </div>
                    `
                });
                
                marker.addListener('click', () => {
                    // Ø¥ØºÙ„Ø§Ù‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…ÙØªÙˆØ­Ø©
                    Object.values(markers).forEach(m => {
                        if (m.infoWindow) {
                            m.infoWindow.close();
                        }
                    });
                    infoWindow.open(map, marker);
                });
                
                marker.infoWindow = infoWindow;
                markers[childId] = marker;
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ø·ÙÙ„:', error);
            }
        }

        // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø·ÙÙ„ Ù…Ø¹ÙŠÙ†
        function focusOnChild(childId, child) {
            if (child.location && map) {
                const position = {
                    lat: child.location.latitude,
                    lng: child.location.longitude
                };
                
                map.setCenter(position);
                map.setZoom(16);
                
                if (markers[childId]) {
                    google.maps.event.trigger(markers[childId], 'click');
                }
            } else {
                showNotification('Ù…ÙˆÙ‚Ø¹ Ù‡Ø°Ø§ Ø§Ù„Ø·ÙÙ„ ØºÙŠØ± Ù…ØªÙˆÙØ± Ø­Ø§Ù„ÙŠØ§Ù‹', true);
            }
        }

        // Ø¨Ø¯Ø¡ ØªØªØ¨Ø¹ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø·ÙÙ„
        function startLocationTracking(childId) {
            console.log('Ø¨Ø¯Ø¡ ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ù„Ø·ÙÙ„:', childId);
            
            if (!navigator.geolocation) {
                updateLocationStatus('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹', 'error');
                return;
            }
            
            updateLocationStatus('Ø¬Ø§Ø±ÙŠ Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹...', 'info');
            
            const options = {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 30000
            };
            
            // Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù† Ø£ÙˆÙ„Ø§Ù‹
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    updateLocationStatus('ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø°Ù† - Ø¨Ø¯Ø¡ Ø§Ù„ØªØªØ¨Ø¹...', 'info');
                    
                    // Ø¨Ø¯Ø¡ Ø§Ù„ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø³ØªÙ…Ø±
                    locationWatchId = navigator.geolocation.watchPosition(
                        (position) => {
                            const lat = position.coords.latitude;
                            const lng = position.coords.longitude;
                            const accuracy = position.coords.accuracy;
                            
                            console.log('ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹:', lat, lng);
                            
                            // Ø­ÙØ¸ ÙÙŠ Firestore
                            db.collection('children').doc(childId).update({
                                location: new firebase.firestore.GeoPoint(lat, lng),
                                lastUpdate: firebase.firestore.FieldValue.serverTimestamp(),
                                isOnline: true,
                                accuracy: accuracy
                            }).then(() => {
                                updateLocationStatus('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…ÙˆÙ‚Ø¹Ùƒ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                                
                                // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                                document.getElementById('latitude').textContent = lat.toFixed(6);
                                document.getElementById('longitude').textContent = lng.toFixed(6);
                                document.getElementById('lastUpdate').textContent = new Date().toLocaleString('ar-SA');
                                document.getElementById('accuracy').textContent = Math.round(accuracy);
                                
                                showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù†Ø¬Ø§Ø­');
                                
                            }).catch((error) => {
                                console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…ÙˆÙ‚Ø¹:', error);
                                updateLocationStatus('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…ÙˆÙ‚Ø¹', 'error');
                                showNotification('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…ÙˆÙ‚Ø¹', true);
                            });

                            // Ø­ÙØ¸ ÙÙŠ Realtime Database Ù„Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„ÙÙˆØ±ÙŠØ©
                            database.ref('locations/' + childId).set({
                                latitude: lat,
                                longitude: lng,
                                accuracy: accuracy,
                                timestamp: firebase.database.ServerValue.TIMESTAMP,
                                isOnline: true
                            }).catch((error) => {
                                console.error('Ø®Ø·Ø£ ÙÙŠ Realtime Database:', error);
                            });
                        },
                        (error) => {
                            console.error('Ø®Ø·Ø£ ÙÙŠ ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹:', error);
                            let errorMessage = 'Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹: ';
                            
                            switch(error.code) {
                                case error.PERMISSION_DENIED:
                                    errorMessage += 'ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø¥Ø°Ù† Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹';
                                    break;
                                case error.POSITION_UNAVAILABLE:
                                    errorMessage += 'Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©';
                                    break;
                                case error.TIMEOUT:
                                    errorMessage += 'Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø·Ù„Ø¨ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹';
                                    break;
                                default:
                                    errorMessage += 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                                    break;
                            }
                            
                            updateLocationStatus(errorMessage, 'error');
                            showNotification(errorMessage, true);
                        },
                        options
                    );
                },
                (error) => {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù†:', error);
                    updateLocationStatus('ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹ Ù„ØªØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©', 'warning');
                    showNotification('ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹', true);
                },
                options
            );
        }

        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        async function logout() {
            try {
                console.log('Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬');
                
                // Ø¥ÙŠÙ‚Ø§Ù ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹
                if (locationWatchId) {
                    navigator.geolocation.clearWatch(locationWatchId);
                    locationWatchId = null;
                    console.log('ØªÙ… Ø¥ÙŠÙ‚Ø§Ù ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹');
                }
                
                // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ù„Ù„Ø·ÙÙ„
                if (userType === 'child' && currentUser) {
                    try {
                        await db.collection('children').doc(currentUser.uid).update({
                            isOnline: false,
                            lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        // ØªØ­Ø¯ÙŠØ« Realtime Database
                        await database.ref('locations/' + currentUser.uid).update({
                            isOnline: false,
                            timestamp: firebase.database.ServerValue.TIMESTAMP
                        });
                        
                        console.log('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„');
                    } catch (error) {
                        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„:', error);
                    }
                }
                
                // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Firebase Auth (Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø³Ø¬Ù„Ø§Ù‹)
                if (auth.currentUser) {
                    await auth.signOut();
                    console.log('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Firebase Auth');
                }
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
                currentUser = null;
                userType = null;
                markers = {};
                isSignUpMode = false;
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…Ø§Ø°Ø¬
                document.getElementById('parentForm').reset();
                document.getElementById('childForm').reset();
                
                // Ø¥Ø®ÙØ§Ø¡ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø·Ø£ ÙˆØ§Ù„Ù†Ø¬Ø§Ø­
                document.querySelectorAll('.error, .success').forEach(el => {
                    el.style.display = 'none';
                });
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙˆØ§Ø¬Ù‡Ø© ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±
                updateAuthMode();
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¹Ù†Ø§ØµØ± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø·ÙÙ„
                if (document.getElementById('locationStatus')) {
                    document.getElementById('locationStatus').textContent = 'Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ...';
                    document.getElementById('locationStatus').classList.add('pulse');
                    document.getElementById('locationStatus').style.color = '#333';
                    document.getElementById('latitude').textContent = '--';
                    document.getElementById('longitude').textContent = '--';
                    document.getElementById('lastUpdate').textContent = '--';
                    document.getElementById('accuracy').textContent = '--';
                }
                
                // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                showScreen('userTypeScreen');
                showNotification('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­');
                
                console.log('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­');
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬:', error);
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬', true);
            }
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        auth.onAuthStateChanged((user) => {
            if (user && userType === 'parent') {
                currentUser = user;
                console.log('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„:', user.email);
            }
        });

        // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„ÙÙˆØ±ÙŠØ© Ù„Ù„Ù…ÙˆØ§Ù‚Ø¹ (Ù„Ù„ÙˆØ§Ù„Ø¯ÙŠÙ†)
        function watchRealtimeLocations() {
            if (userType !== 'parent' || !currentUser) return;
            
            console.log('Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„ÙÙˆØ±ÙŠØ©');
            
            database.ref('locations').on('child_changed', (snapshot) => {
                const childId = snapshot.key;
                const locationData = snapshot.val();
                
                console.log('ØªØ­Ø¯ÙŠØ« Ù…ÙˆÙ‚Ø¹ ÙÙˆØ±ÙŠ Ù„Ù„Ø·ÙÙ„:', childId);
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ù‡Ø°Ø§ Ø§Ù„Ø·ÙÙ„ ÙŠÙ†ØªÙ…ÙŠ Ù„ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
                db.collection('children').doc(childId).get().then((doc) => {
                    if (doc.exists && doc.data().parentId === currentUser.uid) {
                        const child = doc.data();
                        child.location = {
                            latitude: locationData.latitude,
                            longitude: locationData.longitude
                        };
                        child.accuracy = locationData.accuracy;
                        child.isOnline = locationData.isOnline;
                        
                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
                        addChildMarker(childId, child);
                    }
                }).catch((error) => {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„:', error);
                });
            });
        }

        // Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„ÙÙˆØ±ÙŠØ© Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙˆØ§Ù„Ø¯
        auth.onAuthStateChanged((user) => {
            if (user && userType === 'parent') {
                setTimeout(() => {
                    watchRealtimeLocations();
                }, 1000);
            }
        });

        // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
        window.addEventListener('online', () => {
            console.log('ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª');
            if (userType === 'child' && currentUser) {
                db.collection('children').doc(currentUser.uid).update({
                    isOnline: true,
                    lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => {
                    updateLocationStatus('ğŸ”„ ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ - Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹...', 'info');
                    // Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ø¯Ø¡ ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† ÙŠØ¹Ù…Ù„
                    if (!locationWatchId) {
                        startLocationTracking(currentUser.uid);
                    }
                }).catch((error) => {
                    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„:', error);
                });
            }
            showNotification('ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª');
        });

        window.addEventListener('offline', () => {
            console.log('ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª');
            if (userType === 'child' && currentUser) {
                updateLocationStatus('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª - Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù†Ø¯ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„', 'warning');
            }
            showNotification('ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª', true);
        });

        // ØªØ­Ø¯ÙŠØ« Ø¯ÙˆØ±ÙŠ Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ (ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©)
        setInterval(() => {
            if (userType === 'child' && currentUser && navigator.onLine) {
                db.collection('children').doc(currentUser.uid).update({
                    lastUpdate: firebase.firestore.FieldValue.serverTimestamp(),
                    isOnline: true
                }).catch(error => {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯ÙˆØ±ÙŠ:', error);
                });
                
                database.ref('locations/' + currentUser.uid).update({
                    isOnline: true,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                }).catch(error => {
                    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Realtime Database:', error);
                });
            }
        }, 30000);

        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©
        window.addEventListener('beforeunload', async () => {
            if (userType === 'child' && currentUser) {
                try {
                    await db.collection('children').doc(currentUser.uid).update({
                        isOnline: false,
                        lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    await database.ref('locations/' + currentUser.uid).update({
                        isOnline: false,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    });
                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚:', error);
                }
            }
        });

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù…Ø©
        window.addEventListener('error', (e) => {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:', e.error);
            showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹', true);
        });

        window.addEventListener('unhandledrejection', (e) => {
            console.error('ÙˆØ¹Ø¯ Ù…Ø±ÙÙˆØ¶:', e.reason);
            showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', true);
        });

        // Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        console.log('ØªÙ… Ù…Ù†Ø­ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª');
                        showNotification('ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª');
                    } else {
                        console.log('ØªÙ… Ø±ÙØ¶ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª');
                    }
                });
            }
        }

        // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±
        function sendNotification(title, body, icon = null) {
            if ('Notification' in window && Notification.permission === 'granted') {
                const notification = new Notification(title, {
                    body: body,
                    icon: icon || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJDMTMuMSAyIDE0IDIuOSAxNCA0VjVDMTcuMyA1LjcgMjAgOC4xIDIwIDExVjE3TDIyIDE5VjIwSDJWMTlMNDEyIDJaIiBmaWxsPSIjNDI4NUY0Ii8+CjxwYXRoIGQ9Ik0xMCAyMkMxMCAyMy4xIDEwLjkgMjQgMTIgMjRTMTQgMjMuMSAxNCAyMiIgZmlsbD0iIzQyODVGNCIvPgo8L3N2Zz4K',
                    badge: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJDMTMuMSAyIDE0IDIuOSAxNCA0VjVDMTcuMyA1LjcgMjAgOC4xIDIwIDExVjE3TDIyIDE5VjIwSDJWMTlMNDEyIDJaIiBmaWxsPSIjNDI4NUY0Ii8+CjxwYXRoIGQ9Ik0xMCAyMkMxMCAyMy4xIDEwLjkgMjQgMTIgMjRTMTQgMjMuMSAxNCAyMiIgZmlsbD0iIzQyODVGNCIvPgo8L3N2Zz4K',
                    dir: 'rtl',
                    lang: 'ar'
                });

                notification.onclick = function() {
                    window.focus();
                    notification.close();
                };

                // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†
                setTimeout(() => {
                    notification.close();
                }, 5000);
            }
        }

        // Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØºÙŠÙŠØ±Ø§Øª Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø·ÙØ§Ù„ Ù„Ù„ÙˆØ§Ù„Ø¯ÙŠÙ†
        function watchChildrenStatus() {
            if (userType !== 'parent' || !currentUser) return;

            console.log('Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø·ÙØ§Ù„');

            db.collection('children')
                .where('parentId', '==', currentUser.uid)
                .onSnapshot((snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'modified') {
                            const child = change.doc.data();
                            const childName = child.name;

                            // Ø¥Ø´Ø¹Ø§Ø± Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
                            if (change.doc.metadata.hasPendingWrites === false) {
                                if (child.isOnline) {
                                    sendNotification(
                                        'Ø·ÙÙ„ Ù…ØªØµÙ„',
                                        `${childName} Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù† ÙˆÙŠØªÙ… ØªØªØ¨Ø¹ Ù…ÙˆÙ‚Ø¹Ù‡`
                                    );
                                } else {
                                    sendNotification(
                                        'Ø·ÙÙ„ ØºÙŠØ± Ù…ØªØµÙ„',
                                        `${childName} ØºÙŠØ± Ù…ØªØµÙ„ Ø­Ø§Ù„ÙŠØ§Ù‹`
                                    );
                                }
                            }
                        }
                    });
                }, (error) => {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø·ÙØ§Ù„:', error);
                });
        }

        // ØªØ­Ø³ÙŠÙ† Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
        function optimizeMapPerformance() {
            if (!map) return;

            // ØªÙ‚Ù„ÙŠÙ„ Ø¹Ø¯Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
            let updateTimeout;
            const originalAddChildMarker = addChildMarker;
            
            addChildMarker = function(childId, child) {
                clearTimeout(updateTimeout);
                updateTimeout = setTimeout(() => {
                    originalAddChildMarker(childId, child);
                }, 500);
            };
        }

        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ Ù„Ù„Ø¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª
        function saveDataLocally(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹:', error);
            }
        }

        function getDataLocally(key) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©:', error);
                return null;
            }
        }

        // ØªØ­Ø³ÙŠÙ† ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù„Ù‰ Ø§Ù„Ù‡ÙˆØ§ØªÙ
        function optimizeForMobile() {
            // Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ¨ÙŠØ± Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø­Ù‚ÙˆÙ„
            document.addEventListener('touchstart', function() {}, true);

            // ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ù‡ÙˆØ§ØªÙ
            if (window.DeviceMotionEvent) {
                // ØªÙ‚Ù„ÙŠÙ„ Ø¯Ù‚Ø© ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ù‡ÙˆØ§ØªÙ Ù„ØªÙˆÙÙŠØ± Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©
                const mobileOptions = {
                    enableHighAccuracy: false,
                    timeout: 30000,
                    maximumAge: 60000
                };

                // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø®ÙŠØ§Ø±Ø§Øª ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ù„Ù‡ÙˆØ§ØªÙ
                if (navigator.userAgent.match(/Android|iPhone|iPad|iPod|BlackBerry|IEMobile/i)) {
                    console.log('ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø¬Ù‡Ø§Ø² Ù…Ø­Ù…ÙˆÙ„ - ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª');
                    
                    const originalStartLocationTracking = startLocationTracking;
                    startLocationTracking = function(childId) {
                        console.log('Ø¨Ø¯Ø¡ ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø­Ø³Ù† Ù„Ù„Ù‡ÙˆØ§ØªÙ');
                        
                        if (!navigator.geolocation) {
                            updateLocationStatus('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹', 'error');
                            return;
                        }
                        
                        updateLocationStatus('Ø¬Ø§Ø±ÙŠ Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹...', 'info');
                        
                        navigator.geolocation.getCurrentPosition(
                            (position) => {
                                updateLocationStatus('ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø°Ù† - Ø¨Ø¯Ø¡ Ø§Ù„ØªØªØ¨Ø¹...', 'info');
                                
                                locationWatchId = navigator.geolocation.watchPosition(
                                    (position) => {
                                        const lat = position.coords.latitude;
                                        const lng = position.coords.longitude;
                                        const accuracy = position.coords.accuracy;
                                        
                                        console.log('ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Ù…Ø­Ù…ÙˆÙ„):', lat, lng);
                                        
                                        // Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ Ø£ÙˆÙ„Ø§Ù‹
                                        saveDataLocally('lastLocation', {
                                            lat, lng, accuracy,
                                            timestamp: Date.now()
                                        });
                                        
                                        // Ø«Ù… Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©
                                        const updatePromises = [
                                            db.collection('children').doc(childId).update({
                                                location: new firebase.firestore.GeoPoint(lat, lng),
                                                lastUpdate: firebase.firestore.FieldValue.serverTimestamp(),
                                                isOnline: true,
                                                accuracy: accuracy
                                            }),
                                            database.ref('locations/' + childId).set({
                                                latitude: lat,
                                                longitude: lng,
                                                accuracy: accuracy,
                                                timestamp: firebase.database.ServerValue.TIMESTAMP,
                                                isOnline: true
                                            })
                                        ];
                                        
                                        Promise.all(updatePromises).then(() => {
                                            updateLocationStatus('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…ÙˆÙ‚Ø¹Ùƒ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                                            
                                            document.getElementById('latitude').textContent = lat.toFixed(6);
                                            document.getElementById('longitude').textContent = lng.toFixed(6);
                                            document.getElementById('lastUpdate').textContent = new Date().toLocaleString('ar-SA');
                                            document.getElementById('accuracy').textContent = Math.round(accuracy);
                                            
                                        }).catch((error) => {
                                            console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…ÙˆÙ‚Ø¹:', error);
                                            updateLocationStatus('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…ÙˆÙ‚Ø¹ - Ø³ÙŠØªÙ… Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰', 'warning');
                                            
                                            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø¹Ø¯ 10 Ø«ÙˆØ§Ù†
                                            setTimeout(() => {
                                                Promise.all(updatePromises).catch(err => {
                                                    console.error('ÙØ´Ù„ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©:', err);
                                                });
                                            }, 10000);
                                        });
                                    },
                                    (error) => {
                                        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹:', error);
                                        let errorMessage = 'Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹: ';
                                        
                                        switch(error.code) {
                                            case error.PERMISSION_DENIED:
                                                errorMessage += 'ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø¥Ø°Ù† Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹';
                                                break;
                                            case error.POSITION_UNAVAILABLE:
                                                errorMessage += 'Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©';
                                                break;
                                            case error.TIMEOUT:
                                                errorMessage += 'Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø·Ù„Ø¨ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹';
                                                break;
                                            default:
                                                errorMessage += 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                                                break;
                                        }
                                        
                                        updateLocationStatus(errorMessage, 'error');
                                        
                                        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¨Ø¹Ø¯ 30 Ø«Ø§Ù†ÙŠØ©
                                        setTimeout(() => {
                                            updateLocationStatus('ğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹...', 'info');
                                            startLocationTracking(childId);
                                        }, 30000);
                                    },
                                    mobileOptions
                                );
                            },
                            (error) => {
                                console.error('Ø®Ø·Ø£ ÙÙŠ Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù†:', error);
                                updateLocationStatus('ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹ Ù„ØªØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©', 'warning');
                            },
                            mobileOptions
                        );
                    };
                }
            }
        }

        // ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ù…Ø§Ù†
        function enhanceSecurity() {
            // Ù…Ù†Ø¹ Ø§Ù„Ù†Ù‚Ø± Ø¨Ø§Ù„Ø²Ø± Ø§Ù„Ø£ÙŠÙ…Ù† ÙÙŠ Ø¨ÙŠØ¦Ø© Ø§Ù„Ø¥Ù†ØªØ§Ø¬
            if (location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                document.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                });

                // Ù…Ù†Ø¹ ÙØªØ­ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø·ÙˆØ±
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'F12' || 
                        (e.ctrlKey && e.shiftKey && e.key === 'I') ||
                        (e.ctrlKey && e.shiftKey && e.key === 'C') ||
                        (e.ctrlKey && e.key === 'U')) {
                        e.preventDefault();
                    }
                });
            }

            // ØªØ´ÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
            function encryptData(data) {
                try {
                    return btoa(JSON.stringify(data));
                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ´ÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
                    return null;
                }
            }

            function decryptData(encryptedData) {
                try {
                    return JSON.parse(atob(encryptedData));
                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ ÙÙƒ ØªØ´ÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
                    return null;
                }
            }

            // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¯ÙˆØ§Ù„ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø³Ø® Ù…Ø´ÙØ±Ø©
            const originalSaveDataLocally = saveDataLocally;
            const originalGetDataLocally = getDataLocally;

            saveDataLocally = function(key, data) {
                const encryptedData = encryptData(data);
                if (encryptedData) {
                    originalSaveDataLocally(key, encryptedData);
                }
            };

            getDataLocally = function(key) {
                const encryptedData = originalGetDataLocally(key);
                if (encryptedData && typeof encryptedData === 'string') {
                    return decryptData(encryptedData);
                }
                return encryptedData;
            };
        }

        // Ø¥Ø¶Ø§ÙØ© Ù…ÙŠØ²Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
        function addExtraFeatures() {
            // Ø¥Ø¶Ø§ÙØ© Ø²Ø± ØªØ­Ø¯ÙŠØ« ÙŠØ¯ÙˆÙŠ Ù„Ù„Ù…ÙˆÙ‚Ø¹
            if (userType === 'child') {
                const refreshButton = document.createElement('button');
                refreshButton.className = 'btn btn-primary';
                refreshButton.textContent = 'ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙŠØ¯ÙˆÙŠØ§Ù‹';
                refreshButton.style.marginTop = '10px';
                
                refreshButton.addEventListener('click', () => {
                    if (currentUser && navigator.geolocation) {
                        updateLocationStatus('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹...', 'info');
                        
                        navigator.geolocation.getCurrentPosition(
                            (position) => {
                                const lat = position.coords.latitude;
                                const lng = position.coords.longitude;
                                const accuracy = position.coords.accuracy;
                                
                                Promise.all([
                                    db.collection('children').doc(currentUser.uid).update({
                                        location: new firebase.firestore.GeoPoint(lat, lng),
                                        lastUpdate: firebase.firestore.FieldValue.serverTimestamp(),
                                        isOnline: true,
                                        accuracy: accuracy
                                    }),
                                    database.ref('locations/' + currentUser.uid).set({
                                        latitude: lat,
                                        longitude: lng,
                                        accuracy: accuracy,
                                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                                        isOnline: true
                                    })
                                ]).then(() => {
                                    updateLocationStatus('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                                    showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù†Ø¬Ø§Ø­');
                                    
                                    document.getElementById('latitude').textContent = lat.toFixed(6);
                                    document.getElementById('longitude').textContent = lng.toFixed(6);
                                    document.getElementById('lastUpdate').textContent = new Date().toLocaleString('ar-SA');
                                    document.getElementById('accuracy').textContent = Math.round(accuracy);
                                    
                                }).catch((error) => {
                                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙŠØ¯ÙˆÙŠ:', error);
                                    updateLocationStatus('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙŠØ¯ÙˆÙŠ', 'error');
                                    showNotification('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹', true);
                                });
                            },
                            (error) => {
                                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹:', error);
                                updateLocationStatus('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹', 'error');
                                showNotification('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹', true);
                            },
                            {
                                enableHighAccuracy: true,
                                timeout: 10000,
                                maximumAge: 0
                            }
                        );
                    }
                });
                
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø²Ø± Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø·ÙÙ„
                const childDashboard = document.getElementById('childDashboard');
                if (childDashboard) {
                    const container = childDashboard.querySelector('.container');
                    const locationStatus = container.querySelector('.location-status');
                    locationStatus.appendChild(refreshButton);
                }
            }
        }

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        function initializeApp() {
            console.log('ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...');
            
            // Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
            requestNotificationPermission();
            
            // ØªØ­Ø³ÙŠÙ† Ù„Ù„Ù‡ÙˆØ§ØªÙ Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©
            optimizeForMobile();
            
            // ØªØ¹Ø²ÙŠØ² Ø§Ù„Ø£Ù…Ø§Ù†
            enhanceSecurity();
            
            // Ø¥Ø¶Ø§ÙØ© Ù…ÙŠØ²Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
            setTimeout(() => {
                addExtraFeatures();
            }, 1000);
            
            // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø·ÙØ§Ù„ Ù„Ù„ÙˆØ§Ù„Ø¯ÙŠÙ†
            auth.onAuthStateChanged((user) => {
                if (user && userType === 'parent') {
                    setTimeout(() => {
                        watchChildrenStatus();
                        optimizeMapPerformance();
                    }, 2000);
                }
            });
            
            console.log('ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­');
        }

        // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                initializeApp();
            }, 500);
        });

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø®Ø·Ø§Ø¡ Firebase
        firebase.firestore().enableNetwork().catch((error) => {
            console.error('Ø®Ø·Ø£ ÙÙŠ ØªÙØ¹ÙŠÙ„ Ø´Ø¨ÙƒØ© Firestore:', error);
            showNotification('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', true);
        });

        // Ø¥Ø¹Ø¯Ø§Ø¯ Firestore Ù„Ù„Ø¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„
        firebase.firestore().enablePersistence({
            synchronizeTabs: true
        }).catch((error) => {
            if (error.code === 'failed-precondition') {
                console.warn('Ø¹Ø¯Ø© Ø¹Ù„Ø§Ù…Ø§Øª ØªØ¨ÙˆÙŠØ¨ Ù…ÙØªÙˆØ­Ø©ØŒ ØªÙ… ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø±ÙŠØ©');
            } else if (error.code === 'unimplemented') {
                console.warn('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø±ÙŠØ©');
            }
        });

        console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­');
    </script>
</body>
</html>
