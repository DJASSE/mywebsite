<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÿ™ÿ∑ÿ®ŸäŸÇ ÿ™ÿ™ÿ®ÿπ ÿßŸÑÿ£ÿ∑ŸÅÿßŸÑ</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBFw0Qbyq9zTFTd-tUY6dpoWcMAoHurN_4&libraries=geometry"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            direction: rtl;
        }

        .screen {
            display: none;
            min-height: 100vh;
        }

        .screen.active {
            display: block;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-top: 50px;
        }

        h1, h2 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }

        .user-type-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .btn-parent {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            flex-direction: column;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 150px;
        }

        .btn-child {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
            flex-direction: column;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 150px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            width: 100%;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            width: 100%;
            margin-top: 10px;
        }

        .btn-google {
            background: #db4437;
            color: white;
            width: 100%;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-logout {
            background: #dc3545;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .header {
            background: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .dashboard-container {
            display: flex;
            height: calc(100vh - 80px);
        }

        .sidebar {
            width: 300px;
            background: white;
            padding: 20px;
            overflow-y: auto;
            border-left: 1px solid #ddd;
        }

        .children-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .child-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .child-item:hover {
            background: #e9ecef;
            transform: translateX(-5px);
        }

        .child-item.active {
            background: #667eea;
            color: white;
            border-color: #5a6fd8;
        }

        .child-name {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 5px;
        }

        .child-status {
            font-size: 14px;
            opacity: 0.8;
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .location-status {
            text-align: center;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 15px;
            margin: 20px 0;
        }

        .location-info {
            margin-top: 20px;
            text-align: right;
        }

        .location-info p {
            margin: 10px 0;
            font-size: 16px;
        }

        .location-info span {
            font-weight: bold;
            color: #667eea;
        }

        .divider {
            text-align: center;
            margin: 20px 0;
            position: relative;
        }

        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #ddd;
        }

        .divider span {
            background: white;
            padding: 0 15px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.error {
            background: #f44336;
        }

        .google-icon {
            width: 20px;
            height: 20px;
        }

        .auth-mode-toggle {
            text-align: center;
            margin: 20px 0;
        }

        .auth-mode-toggle button {
            background: none;
            border: none;
            color: #667eea;
            text-decoration: underline;
            cursor: pointer;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .dashboard-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 200px;
            }
            
            .user-type-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .btn-parent, .btn-child {
                min-width: 200px;
            }
        }
    </style>
</head>
<body>
    <!-- ÿ¥ÿßÿ¥ÿ© ÿßÿÆÿ™Ÿäÿßÿ± ŸÜŸàÿπ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ -->
    <div id="userTypeScreen" class="screen active">
        <div class="container">
            <h1>ŸÖÿ±ÿ≠ÿ®ÿßŸã ÿ®ŸÉ ŸÅŸä ÿ™ÿ∑ÿ®ŸäŸÇ ÿ™ÿ™ÿ®ÿπ ÿßŸÑÿ£ÿ∑ŸÅÿßŸÑ</h1>
            <div class="user-type-buttons">
                <button class="btn btn-parent" id="parentBtn">
                    <span style="font-size: 30px;">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span>
                    ŸàŸÑŸä ÿ£ŸÖÿ±
                </button>
                <button class="btn btn-child" id="childBtn">
                    <span style="font-size: 30px;">üë∂</span>
                    ÿ∑ŸÅŸÑ
                </button>
            </div>
        </div>
    </div>

    <!-- ÿ¥ÿßÿ¥ÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ ŸàŸÑŸä ÿßŸÑÿ£ŸÖÿ± -->
    <div id="parentLoginScreen" class="screen">
        <div class="container">
            <h2 id="parentFormTitle">ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ ŸàŸÑŸä ÿßŸÑÿ£ŸÖÿ±</h2>
            <div id="parentError" class="error" style="display: none;"></div>
            <div id="parentSuccess" class="success" style="display: none;"></div>
            
            <!-- ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ŸÄ Google -->
            <button type="button" class="btn btn-google" id="parentGoogleBtn">
                <svg class="google-icon" viewBox="0 0 24 24">
                    <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ŸÄ Google
            </button>
            
            <div class="divider">
                <span>ÿ£Ÿà</span>
            </div>
            
            <form id="parentForm">
                <div class="form-group">
                    <label>ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ:</label>
                    <input type="text" id="parentName" required>
                </div>
                <div class="form-group">
                    <label>ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ:</label>
                    <input type="tel" id="parentPhone" required>
                </div>
                <div class="form-group">
                    <label>ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä:</label>
                    <input type="email" id="parentEmail" required>
                </div>
                <div class="form-group">
                    <label>ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±:</label>
                    <input type="password" id="parentPassword" required>
                </div>
                <button type="submit" class="btn btn-primary" id="parentSubmitBtn">ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ</button>
                <div class="auth-mode-toggle">
                    <button type="button" id="parentToggleMode">ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿ≠ÿ≥ÿßÿ®ÿü ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ® ÿ¨ÿØŸäÿØ</button>
                </div>
                <button type="button" class="btn btn-secondary" id="parentBackBtn">ÿ±ÿ¨Ÿàÿπ</button>
            </form>
        </div>
    </div>

    <!-- ÿ¥ÿßÿ¥ÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ ÿßŸÑÿ∑ŸÅŸÑ -->
    <div id="childLoginScreen" class="screen">
        <div class="container">
            <h2>ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ ÿßŸÑÿ∑ŸÅŸÑ</h2>
            <div id="childError" class="error" style="display: none;"></div>
            <div id="childSuccess" class="success" style="display: none;"></div>
            
            <!-- ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ŸÄ Google ŸÑŸÑÿ∑ŸÅŸÑ -->
            <button type="button" class="btn btn-google" id="childGoogleBtn">
                <svg class="google-icon" viewBox="0 0 24 24">
                    <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ŸÄ Google
            </button>
            
            <div class="divider">
                <span>ÿ£Ÿà</span>
            </div>
            
            <form id="childForm">
                <div class="form-group">
                    <label>ÿßÿ≥ŸÖŸÉ:</label>
                    <input type="text" id="childName" required>
                </div>
                <div class="form-group">
                    <label>ÿ±ŸÇŸÖ Ÿáÿßÿ™ŸÅŸÉ:</label>
                    <input type="tel" id="childPhone" required>
                </div>
                <div class="form-group">
                    <label>ÿ±ŸÇŸÖ Ÿáÿßÿ™ŸÅ ŸàŸÑŸä ÿßŸÑÿ£ŸÖÿ±:</label>
                    <input type="tel" id="parentPhoneForChild" required>
                </div>
                <button type="submit" class="btn btn-primary">ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ</button>
                <button type="button" class="btn btn-secondary" id="childBackBtn">ÿ±ÿ¨Ÿàÿπ</button>
            </form>
        </div>
    </div>

    <!-- ÿ¥ÿßÿ¥ÿ© ŸàŸÑŸä ÿßŸÑÿ£ŸÖÿ± - ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ© -->
    <div id="parentDashboard" class="screen">
        <div class="header">
            <h2 id="parentWelcome">ŸÖÿ±ÿ≠ÿ®ÿßŸã</h2>
            <button class="btn btn-logout" id="parentLogoutBtn">ÿ™ÿ≥ÿ¨ŸäŸÑ ÿÆÿ±Ÿàÿ¨</button>
        </div>
        
        <div class="dashboard-container">
            <div class="sidebar">
                <h3>ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ£ÿ∑ŸÅÿßŸÑ</h3>
                <div id="childrenList" class="children-list">
                    <div class="loading">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ£ÿ∑ŸÅÿßŸÑ...</div>
                </div>
            </div>
            
            <div class="map-container">
                <div id="map"></div>
            </div>
        </div>
    </div>

    <!-- ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ∑ŸÅŸÑ - ŸÖÿ¥ÿßÿ±ŸÉÿ© ÿßŸÑŸÖŸàŸÇÿπ -->
    <div id="childDashboard" class="screen">
        <div class="container">
            <h2 id="childWelcome">ŸÖÿ±ÿ≠ÿ®ÿßŸã</h2>
            <div class="location-status">
                <p id="locationStatus" class="pulse">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ÿØŸäÿØ ŸÖŸàŸÇÿπŸÉ...</p>
                <div class="location-info">
                    <p>ÿÆÿ∑ ÿßŸÑÿπÿ±ÿ∂: <span id="latitude">--</span></p>
                    <p>ÿÆÿ∑ ÿßŸÑÿ∑ŸàŸÑ: <span id="longitude">--</span></p>
                    <p>ÿ¢ÿÆÿ± ÿ™ÿ≠ÿØŸäÿ´: <span id="lastUpdate">--</span></p>
                    <p>ÿØŸÇÿ© ÿßŸÑŸÖŸàŸÇÿπ: <span id="accuracy">--</span> ŸÖÿ™ÿ±</p>
                </div>
            </div>
            <button class="btn btn-logout" id="childLogoutBtn">ÿ™ÿ≥ÿ¨ŸäŸÑ ÿÆÿ±Ÿàÿ¨</button>
        </div>
    </div>

    <script>
        // ÿßŸÑŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿßŸÑÿπÿßŸÖÿ©
        let map;
        let markers = {};
        let currentUser = null;
        let userType = null;
        let locationWatchId = null;
        let isSignUpMode = false; // ŸÑŸÑÿ™ÿ®ÿØŸäŸÑ ÿ®ŸäŸÜ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ Ÿàÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ®

        // ÿ•ÿπÿØÿßÿØ Firebase ŸÖÿπ ŸÖÿπŸÑŸàŸÖÿßÿ™ŸÉ
        const firebaseConfig = {
            apiKey: "AIzaSyCwuWnFl3cGetmrNlWxcU5NT_mHQQzkEqo",
            authDomain: "familytracker-77ec8.firebaseapp.com",
            databaseURL: "https://familytracker-77ec8-default-rtdb.firebaseio.com",
            projectId: "familytracker-77ec8",
            storageBucket: "familytracker-77ec8.firebasestorage.app",
            messagingSenderId: "527698679661",
            appId: "1:527698679661:web:af62a9327797646c3c2c64",
            measurementId: "G-B8ZYB634DN"
        };

        // ÿ™ŸáŸäÿ¶ÿ© Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const database = firebase.database();

        // ÿ•ÿπÿØÿßÿØ Google Auth Provider
        const googleProvider = new firebase.auth.GoogleAuthProvider();
        googleProvider.addScope('profile');
        googleProvider.addScope('email');

        // ÿπÿ±ÿ∂ ÿßŸÑÿ¥ÿßÿ¥ÿßÿ™
        function showScreen(screenId) {
            console.log('ÿπÿ±ÿ∂ ÿßŸÑÿ¥ÿßÿ¥ÿ©:', screenId);
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        // ÿπÿ±ÿ∂ ÿ±ÿ≥ÿßÿ¶ŸÑ ÿßŸÑÿÆÿ∑ÿ£ ŸàÿßŸÑŸÜÿ¨ÿßÿ≠
        function showMessage(elementId, message, isError = true) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.style.display = 'block';
                setTimeout(() => {
                    element.style.display = 'none';
                }, 5000);
            }
        }

        // ÿØÿßŸÑÿ© ŸÑÿπÿ±ÿ∂ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™
        function showNotification(message, isError = false) {
            const notification = document.createElement('div');
            notification.className = `notification ${isError ? 'error' : ''}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        // ÿ™ÿ≠ÿØŸäÿ´ Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑÿ™ÿ®ÿØŸäŸÑ ÿ®ŸäŸÜ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ Ÿàÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ≠ÿ≥ÿßÿ®
        function updateAuthMode() {
            const title = document.getElementById('parentFormTitle');
            const submitBtn = document.getElementById('parentSubmitBtn');
            const toggleBtn = document.getElementById('parentToggleMode');
            
            if (isSignUpMode) {
                title.textContent = 'ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ® ŸàŸÑŸä ÿ£ŸÖÿ± ÿ¨ÿØŸäÿØ';
                submitBtn.textContent = 'ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ®';
                toggleBtn.textContent = 'ŸÑÿØŸäŸÉ ÿ≠ÿ≥ÿßÿ® ÿ®ÿßŸÑŸÅÿπŸÑÿü ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ';
            } else {
                title.textContent = 'ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ ŸàŸÑŸä ÿßŸÑÿ£ŸÖÿ±';
                submitBtn.textContent = 'ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ';
                toggleBtn.textContent = 'ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿ≠ÿ≥ÿßÿ®ÿü ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ® ÿ¨ÿØŸäÿØ';
            }
        }

        // ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖŸàŸÇÿπ
        function updateLocationStatus(message, type = 'info') {
            const statusElement = document.getElementById('locationStatus');
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.className = 'pulse';
                
                switch(type) {
                    case 'success':
                        statusElement.style.color = '#4CAF50';
                        statusElement.classList.remove('pulse');
                        break;
                    case 'error':
                        statusElement.style.color = '#f44336';
                        statusElement.classList.remove('pulse');
                        break;
                    case 'warning':
                        statusElement.style.color = '#ff9800';
                        statusElement.classList.remove('pulse');
                        break;
                    default:
                        statusElement.style.color = '#333';
                        break;
                }
            }
        }

        // ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑÿ£ÿ≠ÿØÿßÿ´ ÿπŸÜÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©');

            // ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©
            document.getElementById('parentBtn')?.addEventListener('click', () => {
                showScreen('parentLoginScreen');
            });

            document.getElementById('childBtn')?.addEventListener('click', () => {
                showScreen('childLoginScreen');
            });

            // ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ±ÿ¨Ÿàÿπ
            document.getElementById('parentBackBtn')?.addEventListener('click', () => {
                showScreen('userTypeScreen');
            });

            document.getElementById('childBackBtn')?.addEventListener('click', () => {
                showScreen('userTypeScreen');
            });

            // ÿ£ÿ≤ÿ±ÿßÿ± ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨
            document.getElementById('parentLogoutBtn')?.addEventListener('click', logout);
            document.getElementById('childLogoutBtn')?.addEventListener('click', logout);

            // ÿ£ÿ≤ÿ±ÿßÿ± Google
            document.getElementById('parentGoogleBtn')?.addEventListener('click', () => signInWithGoogle('parent'));
            document.getElementById('childGoogleBtn')?.addEventListener('click', () => signInWithGoogle('child'));

            // ÿ≤ÿ± ÿßŸÑÿ™ÿ®ÿØŸäŸÑ ÿ®ŸäŸÜ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ Ÿàÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ≠ÿ≥ÿßÿ®
            document.getElementById('parentToggleMode')?.addEventListener('click', () => {
                isSignUpMode = !isSignUpMode;
                updateAuthMode();
                // ÿ•ÿÆŸÅÿßÿ° ÿ±ÿ≥ÿßÿ¶ŸÑ ÿßŸÑÿÆÿ∑ÿ£
                document.getElementById('parentError').style.display = 'none';
                document.getElementById('parentSuccess').style.display = 'none';
            });
        });

        // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ŸÄ Google
        async function signInWithGoogle(type) {
            try {
                console.log('ŸÖÿ≠ÿßŸàŸÑÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ŸÄ Google ŸÑŸÑŸÜŸàÿπ:', type);
                
                const result = await auth.signInWithPopup(googleProvider);
                const user = result.user;
                
                console.log('ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ŸÄ Google ÿ®ŸÜÿ¨ÿßÿ≠:', user);
                
                currentUser = user;
                userType = type;
                
                if (type === 'parent') {
                    // ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ŸàŸÑŸä ÿßŸÑÿ£ŸÖÿ±
                    await db.collection('parents').doc(user.uid).set({
                        name: user.displayName,
                        email: user.email,
                        phone: user.phoneNumber || '',
                        photoURL: user.photoURL,
                        provider: 'google',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                    
                    showMessage('parentSuccess', 'ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ŸÄ Google ÿ®ŸÜÿ¨ÿßÿ≠', false);
                    document.getElementById('parentWelcome').textContent = `ŸÖÿ±ÿ≠ÿ®ÿßŸã ${user.displayName}`;
                    
                    setTimeout(() => {
                        showScreen('parentDashboard');
                        initMap();
                        loadChildren();
                    }, 1000);
                    
                } else if (type === 'child') {
                    // ŸÑŸÑÿ∑ŸÅŸÑÿå ŸÜÿ≠ÿ™ÿßÿ¨ ŸÑÿ±ÿ®ÿ∑Ÿá ÿ®ŸàŸÑŸä ÿßŸÑÿ£ŸÖÿ±
                    showChildGoogleSetup(user);
                }
                
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ŸÄ Google:', error);
                const errorElementId = type === 'parent' ? 'parentError' : 'childError';
                
                let errorMessage = 'ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ŸÄ Google: ';
                if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = 'ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ';
                } else if (error.code === 'auth/popup-blocked') {
                    errorMessage = 'ÿ™ŸÖ ÿ≠ÿ∏ÿ± ÿßŸÑŸÜÿßŸÅÿ∞ÿ© ÿßŸÑŸÖŸÜÿ®ÿ´ŸÇÿ©. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ≥ŸÖÿßÿ≠ ÿ®ÿßŸÑŸÜŸàÿßŸÅÿ∞ ÿßŸÑŸÖŸÜÿ®ÿ´ŸÇÿ©';
                } else {
                    errorMessage += error.message;
                }
                
                showMessage(errorElementId, errorMessage);
            }
        }

        // ÿ•ÿπÿØÿßÿØ ÿßŸÑÿ∑ŸÅŸÑ ÿ®ÿπÿØ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ŸÄ Google
        function showChildGoogleSetup(user) {
            const parentPhone = prompt('Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿ±ŸÇŸÖ Ÿáÿßÿ™ŸÅ ŸàŸÑŸä ÿßŸÑÿ£ŸÖÿ±:');
            if (!parentPhone) {
                showMessage('childError', 'Ÿäÿ¨ÿ® ÿ•ÿØÿÆÿßŸÑ ÿ±ŸÇŸÖ Ÿáÿßÿ™ŸÅ ŸàŸÑŸä ÿßŸÑÿ£ŸÖÿ±');
                return;
            }
            
            setupChildWithGoogle(user, parentPhone);
        }

        // ÿ•ÿπÿØÿßÿØ ÿßŸÑÿ∑ŸÅŸÑ ŸÖÿπ Google
        async function setupChildWithGoogle(user, parentPhone) {
            try {
                // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ŸàŸÑŸä ÿßŸÑÿ£ŸÖÿ±
                const parentQuery = await db.collection('parents')
                    .where('phone', '==', parentPhone)
                    .get();
                
                if (parentQuery.empty) {
                    showMessage('childError', 'ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ŸàŸÑŸä ÿßŸÑÿ£ŸÖÿ± ÿ®Ÿáÿ∞ÿß ÿßŸÑÿ±ŸÇŸÖ');
                    return;
                }
                
                const parentDoc = parentQuery.docs[0];
                const parentId = parentDoc.id;
                
                // ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ∑ŸÅŸÑ
                const childData = {
                    name: user.displayName,
                    email: user.email,
                    phone: user.phoneNumber || '',
                    photoURL: user.photoURL,
                    parentId: parentId,
                    provider: 'google',
                    lastUpdate: firebase.firestore.FieldValue.serverTimestamp(),
                    isOnline: true
                };
                
                await db.collection('children').doc(user.uid).set(childData, { merge: true });
                
                currentUser = { uid: user.uid, name: user.displayName };
                showMessage('childSuccess', 'ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ŸÄ Google ÿ®ŸÜÿ¨ÿßÿ≠', false);
                document.getElementById('childWelcome').textContent = `ŸÖÿ±ÿ≠ÿ®ÿßŸã ${user.displayName}`;
                
                setTimeout(() => {
                    showScreen('childDashboard');
                    startLocationTracking(user.uid);
                }, 1000);
                
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿπÿØÿßÿØ ÿßŸÑÿ∑ŸÅŸÑ:', error);
                showMessage('childError', 'ÿÆÿ∑ÿ£ ŸÅŸä ÿ±ÿ®ÿ∑ ÿßŸÑÿ≠ÿ≥ÿßÿ®: ' + error.message);
            }
        }

        // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ ŸàŸÑŸä ÿßŸÑÿ£ŸÖÿ± ÿ®ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä
        document.getElementById('parentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('ŸÖÿ≠ÿßŸàŸÑÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ ŸàŸÑŸä ÿßŸÑÿ£ŸÖÿ±');
            
            const name = document.getElementById('parentName').value;
            const phone = document.getElementById('parentPhone').value;
            const email = document.getElementById('parentEmail').value;
            const password = document.getElementById('parentPassword').value;
            
            try {
                let userCredential;
                
                if (isSignUpMode) {
                    // ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ® ÿ¨ÿØŸäÿØ
                    try {
                        userCredential = await auth.createUserWithEmailAndPassword(email, password);
                        
                        // ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ŸàŸÑŸä ÿßŸÑÿ£ŸÖÿ±
                        await db.collection('parents').doc(userCredential.user.uid).set({
                            name: name,
                            phone: phone,
                            email: email,
                            provider: 'email',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        showMessage('parentSuccess', 'ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿ®ŸÜÿ¨ÿßÿ≠', false);
                        
                    } catch (signUpError) {
                        if (signUpError.code === 'auth/email-already-in-use') {
                            showMessage('parentError', 'ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ®ÿßŸÑŸÅÿπŸÑ. Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ÿØŸÑÿßŸã ŸÖŸÜ ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ® ÿ¨ÿØŸäÿØ.');
                            return;
                        } else if (signUpError.code === 'auth/weak-password') {
                            showMessage('parentError', 'ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∂ÿπŸäŸÅÿ©. Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ŸÉŸàŸÜ 6 ÿ£ÿ≠ÿ±ŸÅ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ.');
                            return;
                        } else if (signUpError.code === 'auth/invalid-email') {
                            showMessage('parentError', 'ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠.');
                            return;
                        } else {
                            throw signUpError;
                        }
                    }
                } else {
                    // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
                    try {
                        userCredential = await auth.signInWithEmailAndPassword(email, password);
                        
                        // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ•ÿ∞ÿß ŸÑÿ≤ŸÖ ÿßŸÑÿ£ŸÖÿ±
                        await db.collection('parents').doc(userCredential.user.uid).set({
                            name: name,
                            phone: phone,
                            email: email,
                            provider: 'email',
                            lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                        }, { merge: true });
                        
                        showMessage('parentSuccess', 'ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ŸÜÿ¨ÿßÿ≠', false);
                        
                    } catch (signInError) {
                        if (signInError.code === 'auth/user-not-found') {
                            showMessage('parentError', 'ŸÑÿß ŸäŸàÿ¨ÿØ ÿ≠ÿ≥ÿßÿ® ÿ®Ÿáÿ∞ÿß ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä. Ÿäÿ±ÿ¨Ÿâ ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ® ÿ¨ÿØŸäÿØ.');
                            return;
                        } else if (signInError.code === 'auth/wrong-password') {
                            showMessage('parentError', 'ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©.');
                            return;
                        } else if (signInError.code === 'auth/invalid-email') {
                            showMessage('parentError', 'ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠.');
                            return;
                        } else if (signInError.code === 'auth/too-many-requests') {
                            showMessage('parentError', 'ÿ™ŸÖ ÿ™ÿ¨ÿßŸàÿ≤ ÿπÿØÿØ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿßÿ™ ÿßŸÑŸÖÿ≥ŸÖŸàÿ≠. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÑÿßÿ≠ŸÇÿßŸã.');
                            return;
                        } else {
                            throw signInError;
                        }
                    }
                }
                
                currentUser = userCredential.user;
                userType = 'parent';
                
                document.getElementById('parentWelcome').textContent = `ŸÖÿ±ÿ≠ÿ®ÿßŸã ${name}`;
                
                setTimeout(() => {
                    showScreen('parentDashboard');
                    initMap();
                    loadChildren();
                }, 1000);
                
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ:', error);
                let errorMessage = 'ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ: ';
                
                if (error.code === 'auth/network-request-failed') {
                    errorMessage = 'ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿßÿ™ÿµÿßŸÑ ŸàÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.';
                } else if (error.code === 'auth/invalid-credential') {
                    errorMessage = 'ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿØÿÆŸàŸÑ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©.';
                } else {
                    errorMessage += error.message;
                }
                
                showMessage('parentError', errorMessage);
            }
        });

        // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ ÿßŸÑÿ∑ŸÅŸÑ ÿ®ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿπÿßÿØŸäÿ©
        document.getElementById('childForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('ŸÖÿ≠ÿßŸàŸÑÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ ÿßŸÑÿ∑ŸÅŸÑ');
            
            const childName = document.getElementById('childName').value;
            const childPhone = document.getElementById('childPhone').value;
            const parentPhone = document.getElementById('parentPhoneForChild').value;
            
            try {
                // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ŸàŸÑŸä ÿßŸÑÿ£ŸÖÿ±
                const parentQuery = await db.collection('parents')
                    .where('phone', '==', parentPhone)
                    .get();
                
                if (parentQuery.empty) {
                    showMessage('childError', 'ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ŸàŸÑŸä ÿßŸÑÿ£ŸÖÿ± ÿ®Ÿáÿ∞ÿß ÿßŸÑÿ±ŸÇŸÖ');
                    return;
                }
                
                const parentDoc = parentQuery.docs[0];
                const parentId = parentDoc.id;
                
                const childData = {
                    name: childName,
                    phone: childPhone,
                    parentId: parentId,
                    provider: 'manual',
                    lastUpdate: firebase.firestore.FieldValue.serverTimestamp(),
                    isOnline: true
                };
                
                // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑÿ∑ŸÅŸÑ ÿßŸÑŸÖŸàÿ¨ŸàÿØ ÿ£Ÿà ÿ•ŸÜÿ¥ÿßÿ° ÿ¨ÿØŸäÿØ
                const childQuery = await db.collection('children')
                    .where('phone', '==', childPhone)
                    .where('parentId', '==', parentId)
                    .get();
                
                let childId;
                if (childQuery.empty) {
                    const childRef = await db.collection('children').add(childData);
                    childId = childRef.id;
                } else {
                    childId = childQuery.docs[0].id;
                    await db.collection('children').doc(childId).update(childData);
                }
                
                currentUser = { uid: childId, name: childName };
                userType = 'child';
                
                showMessage('childSuccess', 'ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ŸÜÿ¨ÿßÿ≠', false);
                document.getElementById('childWelcome').textContent = `ŸÖÿ±ÿ≠ÿ®ÿßŸã ${childName}`;
                
                setTimeout(() => {
                    showScreen('childDashboard');
                    startLocationTracking(childId);
                }, 1000);
                
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ ÿßŸÑÿ∑ŸÅŸÑ:', error);
                let errorMessage = 'ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ: ';
                
                if (error.code === 'permission-denied') {
                    errorMessage = 'ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ŸÑŸÑŸàÿµŸàŸÑ. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™.';
                } else if (error.code === 'unavailable') {
                    errorMessage = 'ÿßŸÑÿÆÿØŸÖÿ© ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±ÿ© ÿ≠ÿßŸÑŸäÿßŸã. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÑÿßÿ≠ŸÇÿßŸã.';
                } else {
                    errorMessage += error.message;
                }
                
                showMessage('childError', errorMessage);
            }
        });

        // ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©
        function initMap() {
            console.log('ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©');
            
            if (typeof google === 'undefined' || !google.maps) {
                console.error('Google Maps API ÿ∫Ÿäÿ± ŸÖÿ≠ŸÖŸÑÿ©');
                showNotification('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©', true);
                return;
            }
            
            try {
                map = new google.maps.Map(document.getElementById('map'), {
                    zoom: 13,
                    center: { lat: 24.7136, lng: 46.6753 }, // ÿßŸÑÿ±Ÿäÿßÿ∂
                    mapTypeId: 'roadmap',
                    styles: [
                        {
                            featureType: 'poi',
                            elementType: 'labels',
                            stylers: [{ visibility: 'off' }]
                        }
                    ]
                });
                
                console.log('ÿ™ŸÖ ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©:', error);
                showNotification('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©', true);
            }
        }

        // ÿ™ÿ≠ŸÖŸäŸÑ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ£ÿ∑ŸÅÿßŸÑ
        function loadChildren() {
            if (!currentUser || userType !== 'parent') return;
            
            console.log('ÿ™ÿ≠ŸÖŸäŸÑ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ£ÿ∑ŸÅÿßŸÑ');
            const childrenList = document.getElementById('childrenList');
            
            // ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ŸÖÿπ ŸÑŸÑÿ™ÿ≠ÿØŸäÿ´ÿßÿ™ ÿßŸÑŸÅŸàÿ±Ÿäÿ©
            const unsubscribe = db.collection('children')
                .where('parentId', '==', currentUser.uid)
                .onSnapshot((snapshot) => {
                    childrenList.innerHTML = '';
                    markers = {};
                    
                    if (snapshot.empty) {
                        childrenList.innerHTML = '<div class="loading">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ£ÿ∑ŸÅÿßŸÑ ŸÖÿ≥ÿ¨ŸÑŸäŸÜ ÿ®ÿπÿØ</div>';
                        return;
                    }
                    
                    snapshot.forEach((doc) => {
                        const child = doc.data();
                        const childId = doc.id;
                        
                        const childItem = document.createElement('div');
                        childItem.className = 'child-item';
                        
                        const lastUpdateText = child.lastUpdate ? 
                            new Date(child.lastUpdate.toDate()).toLocaleString('ar-SA') : 
                            'ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ÿ®ÿπÿØ';
                        
                        const providerIcon = child.provider === 'google' ? 'üìß' : 'üì±';
                        const providerText = child.provider === 'google' ? 'Google' : 'ŸäÿØŸàŸä';
                        
                        childItem.innerHTML = `
                            <div class="child-name">${child.name}</div>
                            <div class="child-status">${child.isOnline ? 'üü¢ ŸÖÿ™ÿµŸÑ' : 'üî¥ ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ'}</div>
                            <div style="font-size: 12px; margin-top: 5px;">
                                ÿ¢ÿÆÿ± ÿ™ÿ≠ÿØŸäÿ´: ${lastUpdateText}
                            </div>
                            <div style="font-size: 10px; color: #666; margin-top: 3px;">
                                ${providerIcon} ${providerText}
                            </div>
                        `;
                        
                        childItem.addEventListener('click', () => {
                            focusOnChild(childId, child);
                            document.querySelectorAll('.child-item').forEach(item => {
                                item.classList.remove('active');
                            });
                            childItem.classList.add('active');
                        });
                        
                        childrenList.appendChild(childItem);
                        
                        if (child.location) {
                            addChildMarker(childId, child);
                        }
                    });
                }, (error) => {
                    console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ£ÿ∑ŸÅÿßŸÑ:', error);
                    childrenList.innerHTML = '<div class="loading" style="color: red;">ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</div>';
                });
        }

        // ÿ•ÿ∂ÿßŸÅÿ© ÿπŸÑÿßŸÖÿ© ÿßŸÑÿ∑ŸÅŸÑ ÿπŸÑŸâ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©
        function addChildMarker(childId, child) {
            if (!child.location || !map) return;
            
            try {
                const position = {
                    lat: child.location.latitude,
                    lng: child.location.longitude
                };
                
                // ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿπŸÑÿßŸÖÿ© ÿßŸÑŸÇÿØŸäŸÖÿ© ÿ•ŸÜ Ÿàÿ¨ÿØÿ™
                if (markers[childId]) {
                    markers[childId].setMap(null);
                }
                
                const marker = new google.maps.Marker({
                    position: position,
                    map: map,
                    title: child.name,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 15,
                        fillColor: child.isOnline ? '#4CAF50' : '#f44336',
                        fillOpacity: 1,
                        strokeColor: '#ffffff',
                        strokeWeight: 3
                    }
                });
                
                const providerText = child.provider === 'google' ? 'ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ŸÄ Google' : 'ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ ŸäÿØŸàŸä';
                
                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="text-align: center; direction: rtl; font-family: Arial;">
                            <h3 style="margin: 0 0 10px 0; color: #333;">${child.name}</h3>
                            <p style="margin: 5px 0;"><strong>ÿßŸÑÿ≠ÿßŸÑÿ©:</strong> ${child.isOnline ? 'üü¢ ŸÖÿ™ÿµŸÑ' : 'üî¥ ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ'}</p>
                            <p style="margin: 5px 0;"><strong>ÿ¢ÿÆÿ± ÿ™ÿ≠ÿØŸäÿ´:</strong><br>${child.lastUpdate ? new Date(child.lastUpdate.toDate()).toLocaleString('ar-SA') : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</p>
                            <p style="margin: 5px 0; font-size: 12px; color: #666;">
                                <strong>ÿßŸÑÿ•ÿ≠ÿØÿßÿ´Ÿäÿßÿ™:</strong><br>
                                ${position.lat.toFixed(6)}, ${position.lng.toFixed(6)}
                            </p>
                            ${child.accuracy ? `<p style="margin: 5px 0; font-size: 12px; color: #666;"><strong>ÿØŸÇÿ© ÿßŸÑŸÖŸàŸÇÿπ:</strong> ${Math.round(child.accuracy)} ŸÖÿ™ÿ±</p>` : ''}
                            <p style="margin: 5px 0; font-size: 10px; color: #4285f4;">${providerText}</p>
                        </div>
                    `
                });
                
                marker.addListener('click', () => {
                    // ÿ•ÿ∫ŸÑÿßŸÇ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÜŸàÿßŸÅÿ∞ ÿßŸÑŸÖŸÅÿ™Ÿàÿ≠ÿ©
                    Object.values(markers).forEach(m => {
                        if (m.infoWindow) {
                            m.infoWindow.close();
                        }
                    });
                    infoWindow.open(map, marker);
                });
                
                marker.infoWindow = infoWindow;
                markers[childId] = marker;
                
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ∂ÿßŸÅÿ© ÿπŸÑÿßŸÖÿ© ÿßŸÑÿ∑ŸÅŸÑ:', error);
            }
        }

        // ÿßŸÑÿ™ÿ±ŸÉŸäÿ≤ ÿπŸÑŸâ ÿ∑ŸÅŸÑ ŸÖÿπŸäŸÜ
        function focusOnChild(childId, child) {
            if (child.location && map) {
                const position = {
                    lat: child.location.latitude,
                    lng: child.location.longitude
                };
                
                map.setCenter(position);
                map.setZoom(16);
                
                if (markers[childId]) {
                    google.maps.event.trigger(markers[childId], 'click');
                }
            } else {
                showNotification('ŸÖŸàŸÇÿπ Ÿáÿ∞ÿß ÿßŸÑÿ∑ŸÅŸÑ ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ± ÿ≠ÿßŸÑŸäÿßŸã', true);
            }
        }

        // ÿ®ÿØÿ° ÿ™ÿ™ÿ®ÿπ ŸÖŸàŸÇÿπ ÿßŸÑÿ∑ŸÅŸÑ
        function startLocationTracking(childId) {
            console.log('ÿ®ÿØÿ° ÿ™ÿ™ÿ®ÿπ ÿßŸÑŸÖŸàŸÇÿπ ŸÑŸÑÿ∑ŸÅŸÑ:', childId);
            
            if (!navigator.geolocation) {
                updateLocationStatus('ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ ŸÑÿß ŸäÿØÿπŸÖ ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ', 'error');
                return;
            }
            
            updateLocationStatus('ÿ¨ÿßÿ±Ÿä ÿ∑ŸÑÿ® ÿ•ÿ∞ŸÜ ÿßŸÑŸàÿµŸàŸÑ ŸÑŸÑŸÖŸàŸÇÿπ...', 'info');
            
            const options = {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 30000
            };
            
            // ÿ∑ŸÑÿ® ÿßŸÑÿ•ÿ∞ŸÜ ÿ£ŸàŸÑÿßŸã
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    updateLocationStatus('ÿ™ŸÖ ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑÿ•ÿ∞ŸÜ - ÿ®ÿØÿ° ÿßŸÑÿ™ÿ™ÿ®ÿπ...', 'info');
                    
                    // ÿ®ÿØÿ° ÿßŸÑÿ™ÿ™ÿ®ÿπ ÿßŸÑŸÖÿ≥ÿ™ŸÖÿ±
                    locationWatchId = navigator.geolocation.watchPosition(
                        (position) => {
                            const lat = position.coords.latitude;
                            const lng = position.coords.longitude;
                            const accuracy = position.coords.accuracy;
                            
                            console.log('ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸàŸÇÿπ:', lat, lng);
                            
                            // ÿ≠ŸÅÿ∏ ŸÅŸä Firestore
                            db.collection('children').doc(childId).update({
                                location: new firebase.firestore.GeoPoint(lat, lng),
                                lastUpdate: firebase.firestore.FieldValue.serverTimestamp(),
                                isOnline: true,
                                accuracy: accuracy
                            }).then(() => {
                                updateLocationStatus('‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ŸÖŸàŸÇÿπŸÉ ÿ®ŸÜÿ¨ÿßÿ≠', 'success');
                                
                                // ÿ™ÿ≠ÿØŸäÿ´ Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
                                document.getElementById('latitude').textContent = lat.toFixed(6);
                                document.getElementById('longitude').textContent = lng.toFixed(6);
                                document.getElementById('lastUpdate').textContent = new Date().toLocaleString('ar-SA');
                                document.getElementById('accuracy').textContent = Math.round(accuracy);
                                
                                showNotification('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸàŸÇÿπ ÿ®ŸÜÿ¨ÿßÿ≠');
                                
                            }).catch((error) => {
                                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸàŸÇÿπ:', error);
                                updateLocationStatus('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸàŸÇÿπ', 'error');
                                showNotification('ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸàŸÇÿπ', true);
                            });

                            // ÿ≠ŸÅÿ∏ ŸÅŸä Realtime Database ŸÑŸÑÿ™ÿ≠ÿØŸäÿ´ÿßÿ™ ÿßŸÑŸÅŸàÿ±Ÿäÿ©
                            database.ref('locations/' + childId).set({
                                latitude: lat,
                                longitude: lng,
                                accuracy: accuracy,
                                timestamp: firebase.database.ServerValue.TIMESTAMP,
                                isOnline: true
                            }).catch((error) => {
                                console.error('ÿÆÿ∑ÿ£ ŸÅŸä Realtime Database:', error);
                            });
                        },
                        (error) => {
                            console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ™ÿ®ÿπ ÿßŸÑŸÖŸàŸÇÿπ:', error);
                            let errorMessage = 'ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ: ';
                            
                            switch(error.code) {
                                case error.PERMISSION_DENIED:
                                    errorMessage += 'ÿ™ŸÖ ÿ±ŸÅÿ∂ ÿßŸÑÿ•ÿ∞ŸÜ ŸÑÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ';
                                    break;
                                case error.POSITION_UNAVAILABLE:
                                    errorMessage += 'ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖŸàŸÇÿπ ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±ÿ©';
                                    break;
                                case error.TIMEOUT:
                                    errorMessage += 'ÿßŸÜÿ™Ÿáÿ™ ŸÖŸáŸÑÿ© ÿ∑ŸÑÿ® ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ';
                                    break;
                                default:
                                    errorMessage += 'ÿÆÿ∑ÿ£ ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ';
                                    break;
                            }
                            
                            updateLocationStatus(errorMessage, 'error');
                            showNotification(errorMessage, true);
                        },
                        options
                    );
                },
                (error) => {
                    console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ∑ŸÑÿ® ÿßŸÑÿ•ÿ∞ŸÜ:', error);
                    updateLocationStatus('Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ≥ŸÖÿßÿ≠ ÿ®ÿßŸÑŸàÿµŸàŸÑ ŸÑŸÑŸÖŸàŸÇÿπ ŸÑÿ™ÿ™ŸÖŸÉŸÜ ŸÖŸÜ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©', 'warning');
                    showNotification('Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ≥ŸÖÿßÿ≠ ÿ®ÿßŸÑŸàÿµŸàŸÑ ŸÑŸÑŸÖŸàŸÇÿπ', true);
                },
                options
            );
        }

        // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨
        async function logout() {
            try {
                console.log('ÿ®ÿØÿ° ÿπŸÖŸÑŸäÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨');
                
                // ÿ•ŸäŸÇÿßŸÅ ÿ™ÿ™ÿ®ÿπ ÿßŸÑŸÖŸàŸÇÿπ
                if (locationWatchId) {
                    navigator.geolocation.clearWatch(locationWatchId);
                    locationWatchId = null;
                    console.log('ÿ™ŸÖ ÿ•ŸäŸÇÿßŸÅ ÿ™ÿ™ÿ®ÿπ ÿßŸÑŸÖŸàŸÇÿπ');
                }
                
                // ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ ŸÑŸÑÿ∑ŸÅŸÑ
                if (userType === 'child' && currentUser) {
                    try {
                        await db.collection('children').doc(currentUser.uid).update({
                            isOnline: false,
                            lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        // ÿ™ÿ≠ÿØŸäÿ´ Realtime Database
                        await database.ref('locations/' + currentUser.uid).update({
                            isOnline: false,
                            timestamp: firebase.database.ServerValue.TIMESTAMP
                        });
                        
                        console.log('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ');
                    } catch (error) {
                        console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ:', error);
                    }
                }
                
                // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ ŸÖŸÜ Firebase Auth (ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÖÿ≥ÿ¨ŸÑÿßŸã)
                if (auth.currentUser) {
                    await auth.signOut();
                    console.log('ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ ŸÖŸÜ Firebase Auth');
                }
                
                // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™
                currentUser = null;
                userType = null;
                markers = {};
                isSignUpMode = false;
                
                // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÜŸÖÿßÿ∞ÿ¨
                document.getElementById('parentForm').reset();
                document.getElementById('childForm').reset();
                
                // ÿ•ÿÆŸÅÿßÿ° ÿ±ÿ≥ÿßÿ¶ŸÑ ÿßŸÑÿÆÿ∑ÿ£ ŸàÿßŸÑŸÜÿ¨ÿßÿ≠
                document.querySelectorAll('.error, .success').forEach(el => {
                    el.style.display = 'none';
                });
                
                // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ Ÿàÿßÿ¨Ÿáÿ© ŸàŸÑŸä ÿßŸÑÿ£ŸÖÿ±
                updateAuthMode();
                
                // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿπŸÜÿßÿµÿ± Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑÿ∑ŸÅŸÑ
                if (document.getElementById('locationStatus')) {
                    document.getElementById('locationStatus').textContent = 'ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ÿØŸäÿØ ŸÖŸàŸÇÿπŸÉ...';
                    document.getElementById('locationStatus').classList.add('pulse');
                    document.getElementById('locationStatus').style.color = '#333';
                    document.getElementById('latitude').textContent = '--';
                    document.getElementById('longitude').textContent = '--';
                    document.getElementById('lastUpdate').textContent = '--';
                    document.getElementById('accuracy').textContent = '--';
                }
                
                // ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©
                showScreen('userTypeScreen');
                showNotification('ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ ÿ®ŸÜÿ¨ÿßÿ≠');
                
                console.log('ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ ÿ®ŸÜÿ¨ÿßÿ≠');
                
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨:', error);
                showNotification('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨', true);
            }
        }

        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿµÿßÿØŸÇÿ© ÿπŸÜÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©
        auth.onAuthStateChanged((user) => {
            if (user && userType === 'parent') {
                currentUser = user;
                console.log('ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖÿ≥ÿ¨ŸÑ ÿØÿÆŸàŸÑ:', user.email);
            }
        });

        // ŸÖÿ±ÿßŸÇÿ®ÿ© ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ÿßÿ™ ÿßŸÑŸÅŸàÿ±Ÿäÿ© ŸÑŸÑŸÖŸàÿßŸÇÿπ (ŸÑŸÑŸàÿßŸÑÿØŸäŸÜ)
        function watchRealtimeLocations() {
            if (userType !== 'parent' || !currentUser) return;
            
            console.log('ÿ®ÿØÿ° ŸÖÿ±ÿßŸÇÿ®ÿ© ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ÿßÿ™ ÿßŸÑŸÅŸàÿ±Ÿäÿ©');
            
            database.ref('locations').on('child_changed', (snapshot) => {
                const childId = snapshot.key;
                const locationData = snapshot.val();
                
                console.log('ÿ™ÿ≠ÿØŸäÿ´ ŸÖŸàŸÇÿπ ŸÅŸàÿ±Ÿä ŸÑŸÑÿ∑ŸÅŸÑ:', childId);
                
                // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ£ŸÜ Ÿáÿ∞ÿß ÿßŸÑÿ∑ŸÅŸÑ ŸäŸÜÿ™ŸÖŸä ŸÑŸàŸÑŸä ÿßŸÑÿ£ŸÖÿ± ÿßŸÑÿ≠ÿßŸÑŸä
                db.collection('children').doc(childId).get().then((doc) => {
                    if (doc.exists && doc.data().parentId === currentUser.uid) {
                        const child = doc.data();
                        child.location = {
                            latitude: locationData.latitude,
                            longitude: locationData.longitude
                        };
                        child.accuracy = locationData.accuracy;
                        child.isOnline = locationData.isOnline;
                        
                        // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿπŸÑÿßŸÖÿ© ÿπŸÑŸâ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©
                        addChildMarker(childId, child);
                    }
                }).catch((error) => {
                    console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ¨ŸÑÿ® ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ∑ŸÅŸÑ:', error);
                });
            });
        }

        // ÿ®ÿØÿ° ŸÖÿ±ÿßŸÇÿ®ÿ© ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ÿßÿ™ ÿßŸÑŸÅŸàÿ±Ÿäÿ© ÿπŸÜÿØ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ ÿßŸÑŸàÿßŸÑÿØ
        auth.onAuthStateChanged((user) => {
            if (user && userType === 'parent') {
                setTimeout(() => {
                    watchRealtimeLocations();
                }, 1000);
            }
        });

        // ÿßŸÑÿ™ÿπÿßŸÖŸÑ ŸÖÿπ ÿ™ÿ∫ŸäŸäÿ± ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ
        window.addEventListener('online', () => {
            console.log('ÿ™ŸÖ ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™');
            if (userType === 'child' && currentUser) {
                db.collection('children').doc(currentUser.uid).update({
                    isOnline: true,
                    lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => {
                    updateLocationStatus('üîÑ ÿ™ŸÖ ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ - ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸàŸÇÿπ...', 'info');
                    // ÿ•ÿπÿßÿØÿ© ÿ®ÿØÿ° ÿ™ÿ™ÿ®ÿπ ÿßŸÑŸÖŸàŸÇÿπ ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸäÿπŸÖŸÑ
                    if (!locationWatchId) {
                        startLocationTracking(currentUser.uid);
                    }
                }).catch((error) => {
                    console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ:', error);
                });
            }
            showNotification('ÿ™ŸÖ ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™');
        });

        window.addEventListener('offline', () => {
            console.log('ŸÅŸÇÿØÿßŸÜ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™');
            if (userType === 'child' && currentUser) {
                updateLocationStatus('‚ö†Ô∏è ŸÑÿß ŸäŸàÿ¨ÿØ ÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™ - ÿ≥Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸàŸÇÿπ ÿπŸÜÿØ ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ', 'warning');
            }
            showNotification('ŸÅŸÇÿØÿßŸÜ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™', true);
        });

        // ÿ™ÿ≠ÿØŸäÿ´ ÿØŸàÿ±Ÿä ŸÑÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ (ŸÉŸÑ 30 ÿ´ÿßŸÜŸäÿ©)
        setInterval(() => {
            if (userType === 'child' && currentUser && navigator.onLine) {
                db.collection('children').doc(currentUser.uid).update({
                    lastUpdate: firebase.firestore.FieldValue.serverTimestamp(),
                    isOnline: true
                }).catch(error => {
                    console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿØŸàÿ±Ÿä:', error);
                });
                
                database.ref('locations/' + currentUser.uid).update({
                    isOnline: true,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                }).catch(error => {
                    console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ Realtime Database:', error);
                });
            }
        }, 30000);

        // ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿπŸÜÿØ ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑÿµŸÅÿ≠ÿ©
        window.addEventListener('beforeunload', async () => {
            if (userType === 'child' && currentUser) {
                try {
                    await db.collection('children').doc(currentUser.uid).update({
                        isOnline: false,
                        lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    await database.ref('locations/' + currentUser.uid).update({
                        isOnline: false,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    });
                } catch (error) {
                    console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿπŸÜÿØ ÿßŸÑÿ•ÿ∫ŸÑÿßŸÇ:', error);
                }
            }
        });

        // ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ£ÿÆÿ∑ÿßÿ° ÿßŸÑÿπÿßŸÖÿ©
        window.addEventListener('error', (e) => {
            console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ:', e.error);
            showNotification('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÇÿπ', true);
        });

        window.addEventListener('unhandledrejection', (e) => {
            console.error('ŸàÿπÿØ ŸÖÿ±ŸÅŸàÿ∂:', e.reason);
            showNotification('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ', true);
        });

        // ÿ∑ŸÑÿ® ÿ•ÿ∞ŸÜ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        console.log('ÿ™ŸÖ ŸÖŸÜÿ≠ ÿ•ÿ∞ŸÜ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™');
                        showNotification('ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™');
                    } else {
                        console.log('ÿ™ŸÖ ÿ±ŸÅÿ∂ ÿ•ÿ∞ŸÜ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™');
                    }
                });
            }
        }

        // ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿπÿßÿ±
        function sendNotification(title, body, icon = null) {
            if ('Notification' in window && Notification.permission === 'granted') {
                const notification = new Notification(title, {
                    body: body,
                    icon: icon || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJDMTMuMSAyIDE0IDIuOSAxNCA0VjVDMTcuMyA1LjcgMjAgOC4xIDIwIDExVjE3TDIyIDE5VjIwSDJWMTlMNDEyIDJaIiBmaWxsPSIjNDI4NUY0Ii8+CjxwYXRoIGQ9Ik0xMCAyMkMxMCAyMy4xIDEwLjkgMjQgMTIgMjRTMTQgMjMuMSAxNCAyMiIgZmlsbD0iIzQyODVGNCIvPgo8L3N2Zz4K',
                    badge: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJDMTMuMSAyIDE0IDIuOSAxNCA0VjVDMTcuMyA1LjcgMjAgOC4xIDIwIDExVjE3TDIyIDE5VjIwSDJWMTlMNDEyIDJaIiBmaWxsPSIjNDI4NUY0Ii8+CjxwYXRoIGQ9Ik0xMCAyMkMxMCAyMy4xIDEwLjkgMjQgMTIgMjRTMTQgMjMuMSAxNCAyMiIgZmlsbD0iIzQyODVGNCIvPgo8L3N2Zz4K',
                    dir: 'rtl',
                    lang: 'ar'
                });

                notification.onclick = function() {
                    window.focus();
                    notification.close();
                };

                // ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑÿ•ÿ¥ÿπÿßÿ± ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ÿ®ÿπÿØ 5 ÿ´ŸàÿßŸÜ
                setTimeout(() => {
                    notification.close();
                }, 5000);
            }
        }

        // ŸÖÿ±ÿßŸÇÿ®ÿ© ÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ£ÿ∑ŸÅÿßŸÑ ŸÑŸÑŸàÿßŸÑÿØŸäŸÜ
        function watchChildrenStatus() {
            if (userType !== 'parent' || !currentUser) return;

            console.log('ÿ®ÿØÿ° ŸÖÿ±ÿßŸÇÿ®ÿ© ÿ≠ÿßŸÑÿ© ÿßŸÑÿ£ÿ∑ŸÅÿßŸÑ');

            db.collection('children')
                .where('parentId', '==', currentUser.uid)
                .onSnapshot((snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'modified') {
                            const child = change.doc.data();
                            const childName = child.name;

                            // ÿ•ÿ¥ÿπÿßÿ± ÿπŸÜÿØ ÿ™ÿ∫ŸäŸäÿ± ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ
                            if (change.doc.metadata.hasPendingWrites === false) {
                                if (child.isOnline) {
                                    sendNotification(
                                        'ÿ∑ŸÅŸÑ ŸÖÿ™ÿµŸÑ',
                                        `${childName} ŸÖÿ™ÿµŸÑ ÿßŸÑÿ¢ŸÜ ŸàŸäÿ™ŸÖ ÿ™ÿ™ÿ®ÿπ ŸÖŸàŸÇÿπŸá`
                                    );
                                } else {
                                    sendNotification(
                                        'ÿ∑ŸÅŸÑ ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ',
                                        `${childName} ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ ÿ≠ÿßŸÑŸäÿßŸã`
                                    );
                                }
                            }
                        }
                    });
                }, (error) => {
                    console.error('ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿ±ÿßŸÇÿ®ÿ© ÿ≠ÿßŸÑÿ© ÿßŸÑÿ£ÿ∑ŸÅÿßŸÑ:', error);
                });
        }

        // ÿ™ÿ≠ÿ≥ŸäŸÜ ÿ£ÿØÿßÿ° ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©
        function optimizeMapPerformance() {
            if (!map) return;

            // ÿ™ŸÇŸÑŸäŸÑ ÿπÿØÿØ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ÿßÿ™
            let updateTimeout;
            const originalAddChildMarker = addChildMarker;
            
            addChildMarker = function(childId, child) {
                clearTimeout(updateTimeout);
                updateTimeout = setTimeout(() => {
                    originalAddChildMarker(childId, child);
                }, 500);
            };
        }

        // ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ≠ŸÑŸäÿßŸã ŸÑŸÑÿπŸÖŸÑ ÿ®ÿØŸàŸÜ ÿ•ŸÜÿ™ÿ±ŸÜÿ™
        function saveDataLocally(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ≠ŸÑŸäÿßŸã:', error);
            }
        }

        function getDataLocally(key) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ©:', error);
                return null;
            }
        }

        // ÿ™ÿ≠ÿ≥ŸäŸÜ ÿ™ÿ¨ÿ±ÿ®ÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿπŸÑŸâ ÿßŸÑŸáŸàÿßÿ™ŸÅ
        function optimizeForMobile() {
            // ŸÖŸÜÿπ ÿßŸÑÿ™ŸÉÿ®Ÿäÿ± ÿπŸÜÿØ ÿßŸÑŸÜŸÇÿ± ÿπŸÑŸâ ÿßŸÑÿ≠ŸÇŸàŸÑ
            document.addEventListener('touchstart', function() {}, true);

            // ÿ™ÿ≠ÿ≥ŸäŸÜ ÿßŸÑÿ£ÿØÿßÿ° ÿπŸÑŸâ ÿßŸÑŸáŸàÿßÿ™ŸÅ
            if (window.DeviceMotionEvent) {
                // ÿ™ŸÇŸÑŸäŸÑ ÿØŸÇÿ© ÿ™ÿ™ÿ®ÿπ ÿßŸÑŸÖŸàŸÇÿπ ÿπŸÑŸâ ÿßŸÑŸáŸàÿßÿ™ŸÅ ŸÑÿ™ŸàŸÅŸäÿ± ÿßŸÑÿ®ÿ∑ÿßÿ±Ÿäÿ©
                const mobileOptions = {
                    enableHighAccuracy: false,
                    timeout: 30000,
                    maximumAge: 60000
                };

                // ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ ÿÆŸäÿßÿ±ÿßÿ™ ÿ™ÿ™ÿ®ÿπ ÿßŸÑŸÖŸàŸÇÿπ ŸÑŸÑŸáŸàÿßÿ™ŸÅ
                if (navigator.userAgent.match(/Android|iPhone|iPad|iPod|BlackBerry|IEMobile/i)) {
                    console.log('ÿ™ŸÖ ÿßŸÉÿ™ÿ¥ÿßŸÅ ÿ¨Ÿáÿßÿ≤ ŸÖÿ≠ŸÖŸàŸÑ - ÿ™ÿ≠ÿ≥ŸäŸÜ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™');
                    
                    const originalStartLocationTracking = startLocationTracking;
                    startLocationTracking = function(childId) {
                        console.log('ÿ®ÿØÿ° ÿ™ÿ™ÿ®ÿπ ÿßŸÑŸÖŸàŸÇÿπ ÿßŸÑŸÖÿ≠ÿ≥ŸÜ ŸÑŸÑŸáŸàÿßÿ™ŸÅ');
                        
                        if (!navigator.geolocation) {
                            updateLocationStatus('ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ ŸÑÿß ŸäÿØÿπŸÖ ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ', 'error');
                            return;
                        }
                        
                        updateLocationStatus('ÿ¨ÿßÿ±Ÿä ÿ∑ŸÑÿ® ÿ•ÿ∞ŸÜ ÿßŸÑŸàÿµŸàŸÑ ŸÑŸÑŸÖŸàŸÇÿπ...', 'info');
                        
                        navigator.geolocation.getCurrentPosition(
                            (position) => {
                                updateLocationStatus('ÿ™ŸÖ ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑÿ•ÿ∞ŸÜ - ÿ®ÿØÿ° ÿßŸÑÿ™ÿ™ÿ®ÿπ...', 'info');
                                
                                locationWatchId = navigator.geolocation.watchPosition(
                                    (position) => {
                                        const lat = position.coords.latitude;
                                        const lng = position.coords.longitude;
                                        const accuracy = position.coords.accuracy;
                                        
                                        console.log('ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸàŸÇÿπ (ŸÖÿ≠ŸÖŸàŸÑ):', lat, lng);
                                        
                                        // ÿ≠ŸÅÿ∏ ŸÖÿ≠ŸÑŸäÿßŸã ÿ£ŸàŸÑÿßŸã
                                        saveDataLocally('lastLocation', {
                                            lat, lng, accuracy,
                                            timestamp: Date.now()
                                        });
                                        
                                        // ÿ´ŸÖ ÿ≠ŸÅÿ∏ ŸÅŸä ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©
                                        const updatePromises = [
                                            db.collection('children').doc(childId).update({
                                                location: new firebase.firestore.GeoPoint(lat, lng),
                                                lastUpdate: firebase.firestore.FieldValue.serverTimestamp(),
                                                isOnline: true,
                                                accuracy: accuracy
                                            }),
                                            database.ref('locations/' + childId).set({
                                                latitude: lat,
                                                longitude: lng,
                                                accuracy: accuracy,
                                                timestamp: firebase.database.ServerValue.TIMESTAMP,
                                                isOnline: true
                                            })
                                        ];
                                        
                                        Promise.all(updatePromises).then(() => {
                                            updateLocationStatus('‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ŸÖŸàŸÇÿπŸÉ ÿ®ŸÜÿ¨ÿßÿ≠', 'success');
                                            
                                            document.getElementById('latitude').textContent = lat.toFixed(6);
                                            document.getElementById('longitude').textContent = lng.toFixed(6);
                                            document.getElementById('lastUpdate').textContent = new Date().toLocaleString('ar-SA');
                                            document.getElementById('accuracy').textContent = Math.round(accuracy);
                                            
                                        }).catch((error) => {
                                            console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸàŸÇÿπ:', error);
                                            updateLocationStatus('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸàŸÇÿπ - ÿ≥Ÿäÿ™ŸÖ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ', 'warning');
                                            
                                            // ŸÖÿ≠ÿßŸàŸÑÿ© ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ ÿ®ÿπÿØ 10 ÿ´ŸàÿßŸÜ
                                            setTimeout(() => {
                                                Promise.all(updatePromises).catch(err => {
                                                    console.error('ŸÅÿ¥ŸÑ ŸÅŸä ÿ•ÿπÿßÿØÿ© ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ©:', err);
                                                });
                                            }, 10000);
                                        });
                                    },
                                    (error) => {
                                        console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ™ÿ®ÿπ ÿßŸÑŸÖŸàŸÇÿπ:', error);
                                        let errorMessage = 'ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ: ';
                                        
                                        switch(error.code) {
                                            case error.PERMISSION_DENIED:
                                                errorMessage += 'ÿ™ŸÖ ÿ±ŸÅÿ∂ ÿßŸÑÿ•ÿ∞ŸÜ ŸÑÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ';
                                                break;
                                            case error.POSITION_UNAVAILABLE:
                                                errorMessage += 'ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖŸàŸÇÿπ ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±ÿ©';
                                                break;
                                            case error.TIMEOUT:
                                                errorMessage += 'ÿßŸÜÿ™Ÿáÿ™ ŸÖŸáŸÑÿ© ÿ∑ŸÑÿ® ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ';
                                                break;
                                            default:
                                                errorMessage += 'ÿÆÿ∑ÿ£ ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ';
                                                break;
                                        }
                                        
                                        updateLocationStatus(errorMessage, 'error');
                                        
                                        // ŸÖÿ≠ÿßŸàŸÑÿ© ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ ÿ®ÿπÿØ 30 ÿ´ÿßŸÜŸäÿ©
                                        setTimeout(() => {
                                            updateLocationStatus('üîÑ ŸÖÿ≠ÿßŸàŸÑÿ© ÿ•ÿπÿßÿØÿ© ÿ™ÿ¥ÿ∫ŸäŸÑ ÿ™ÿ™ÿ®ÿπ ÿßŸÑŸÖŸàŸÇÿπ...', 'info');
                                            startLocationTracking(childId);
                                        }, 30000);
                                    },
                                    mobileOptions
                                );
                            },
                            (error) => {
                                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ∑ŸÑÿ® ÿßŸÑÿ•ÿ∞ŸÜ:', error);
                                updateLocationStatus('Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ≥ŸÖÿßÿ≠ ÿ®ÿßŸÑŸàÿµŸàŸÑ ŸÑŸÑŸÖŸàŸÇÿπ ŸÑÿ™ÿ™ŸÖŸÉŸÜ ŸÖŸÜ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©', 'warning');
                            },
                            mobileOptions
                        );
                    };
                }
            }
        }

        // ÿ™ÿ≠ÿ≥ŸäŸÜ ÿßŸÑÿ£ŸÖÿßŸÜ
        function enhanceSecurity() {
            // ŸÖŸÜÿπ ÿßŸÑŸÜŸÇÿ± ÿ®ÿßŸÑÿ≤ÿ± ÿßŸÑÿ£ŸäŸÖŸÜ ŸÅŸä ÿ®Ÿäÿ¶ÿ© ÿßŸÑÿ•ŸÜÿ™ÿßÿ¨
            if (location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                document.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                });

                // ŸÖŸÜÿπ ŸÅÿ™ÿ≠ ÿ£ÿØŸàÿßÿ™ ÿßŸÑŸÖÿ∑Ÿàÿ±
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'F12' || 
                        (e.ctrlKey && e.shiftKey && e.key === 'I') ||
                        (e.ctrlKey && e.shiftKey && e.key === 'C') ||
                        (e.ctrlKey && e.key === 'U')) {
                        e.preventDefault();
                    }
                });
            }

            // ÿ™ÿ¥ŸÅŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ©
            function encryptData(data) {
                try {
                    return btoa(JSON.stringify(data));
                } catch (error) {
                    console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ¥ŸÅŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:', error);
                    return null;
                }
            }

            function decryptData(encryptedData) {
                try {
                    return JSON.parse(atob(encryptedData));
                } catch (error) {
                    console.error('ÿÆÿ∑ÿ£ ŸÅŸä ŸÅŸÉ ÿ™ÿ¥ŸÅŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:', error);
                    return null;
                }
            }

            // ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ ÿØŸàÿßŸÑ ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ŸÜÿ≥ÿÆ ŸÖÿ¥ŸÅÿ±ÿ©
            const originalSaveDataLocally = saveDataLocally;
            const originalGetDataLocally = getDataLocally;

            saveDataLocally = function(key, data) {
                const encryptedData = encryptData(data);
                if (encryptedData) {
                    originalSaveDataLocally(key, encryptedData);
                }
            };

            getDataLocally = function(key) {
                const encryptedData = originalGetDataLocally(key);
                if (encryptedData && typeof encryptedData === 'string') {
                    return decryptData(encryptedData);
                }
                return encryptedData;
            };
        }

        // ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸäÿ≤ÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ©
        function addExtraFeatures() {
            // ÿ•ÿ∂ÿßŸÅÿ© ÿ≤ÿ± ÿ™ÿ≠ÿØŸäÿ´ ŸäÿØŸàŸä ŸÑŸÑŸÖŸàŸÇÿπ
            if (userType === 'child') {
                const refreshButton = document.createElement('button');
                refreshButton.className = 'btn btn-primary';
                refreshButton.textContent = 'üîÑ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸàŸÇÿπ ŸäÿØŸàŸäÿßŸã';
                refreshButton.style.marginTop = '10px';
                
                refreshButton.addEventListener('click', () => {
                    if (currentUser && navigator.geolocation) {
                        updateLocationStatus('ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸàŸÇÿπ...', 'info');
                        
                        navigator.geolocation.getCurrentPosition(
                            (position) => {
                                const lat = position.coords.latitude;
                                const lng = position.coords.longitude;
                                const accuracy = position.coords.accuracy;
                                
                                Promise.all([
                                    db.collection('children').doc(currentUser.uid).update({
                                        location: new firebase.firestore.GeoPoint(lat, lng),
                                        lastUpdate: firebase.firestore.FieldValue.serverTimestamp(),
                                        isOnline: true,
                                        accuracy: accuracy
                                    }),
                                    database.ref('locations/' + currentUser.uid).set({
                                        latitude: lat,
                                        longitude: lng,
                                        accuracy: accuracy,
                                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                                        isOnline: true
                                    })
                                ]).then(() => {
                                    updateLocationStatus('‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸàŸÇÿπ ŸäÿØŸàŸäÿßŸã ÿ®ŸÜÿ¨ÿßÿ≠', 'success');
                                    showNotification('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸàŸÇÿπ ÿ®ŸÜÿ¨ÿßÿ≠');
                                    
                                    document.getElementById('latitude').textContent = lat.toFixed(6);
                                    document.getElementById('longitude').textContent = lng.toFixed(6);
                                    document.getElementById('lastUpdate').textContent = new Date().toLocaleString('ar-SA');
                                    document.getElementById('accuracy').textContent = Math.round(accuracy);
                                    
                                }).catch((error) => {
                                    console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸäÿØŸàŸä:', error);
                                    updateLocationStatus('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸäÿØŸàŸä', 'error');
                                    showNotification('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸàŸÇÿπ', true);
                                });
                            },
                            (error) => {
                                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑŸÖŸàŸÇÿπ:', error);
                                updateLocationStatus('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑŸÖŸàŸÇÿπ', 'error');
                                showNotification('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ', true);
                            },
                            {
                                enableHighAccuracy: true,
                                timeout: 10000,
                                maximumAge: 0
                            }
                        );
                    }
                });
                
                // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ≤ÿ± ŸÑŸàÿßÿ¨Ÿáÿ© ÿßŸÑÿ∑ŸÅŸÑ
                const childDashboard = document.getElementById('childDashboard');
                if (childDashboard) {
                    const container = childDashboard.querySelector('.container');
                    const locationStatus = container.querySelector('.location-status');
                    locationStatus.appendChild(refreshButton);
                }
            }
        }

        // ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ
        function initializeApp() {
            console.log('ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ...');
            
            // ÿ∑ŸÑÿ® ÿ•ÿ∞ŸÜ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™
            requestNotificationPermission();
            
            // ÿ™ÿ≠ÿ≥ŸäŸÜ ŸÑŸÑŸáŸàÿßÿ™ŸÅ ÿßŸÑŸÖÿ≠ŸÖŸàŸÑÿ©
            optimizeForMobile();
            
            // ÿ™ÿπÿ≤Ÿäÿ≤ ÿßŸÑÿ£ŸÖÿßŸÜ
            enhanceSecurity();
            
            // ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸäÿ≤ÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ©
            setTimeout(() => {
                addExtraFeatures();
            }, 1000);
            
            // ŸÖÿ±ÿßŸÇÿ®ÿ© ÿ≠ÿßŸÑÿ© ÿßŸÑÿ£ÿ∑ŸÅÿßŸÑ ŸÑŸÑŸàÿßŸÑÿØŸäŸÜ
            auth.onAuthStateChanged((user) => {
                if (user && userType === 'parent') {
                    setTimeout(() => {
                        watchChildrenStatus();
                        optimizeMapPerformance();
                    }, 2000);
                }
            });
            
            console.log('ÿ™ŸÖ ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ÿ®ŸÜÿ¨ÿßÿ≠');
        }

        // ÿ®ÿØÿ° ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ÿπŸÜÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                initializeApp();
            }, 500);
        });

        // ŸÖÿπÿßŸÑÿ¨ÿ© ÿ£ÿÆÿ∑ÿßÿ° Firebase
        firebase.firestore().enableNetwork().catch((error) => {
            console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ŸÅÿπŸäŸÑ ÿ¥ÿ®ŸÉÿ© Firestore:', error);
            showNotification('ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™', true);
        });

        // ÿ•ÿπÿØÿßÿØ Firestore ŸÑŸÑÿπŸÖŸÑ ÿ®ÿØŸàŸÜ ÿßÿ™ÿµÿßŸÑ
        firebase.firestore().enablePersistence({
            synchronizeTabs: true
        }).catch((error) => {
            if (error.code === 'failed-precondition') {
                console.warn('ÿπÿØÿ© ÿπŸÑÿßŸÖÿßÿ™ ÿ™ÿ®ŸàŸäÿ® ŸÖŸÅÿ™Ÿàÿ≠ÿ©ÿå ÿ™ŸÖ ÿ™ÿπÿ∑ŸäŸÑ ÿßŸÑÿßÿ≥ÿ™ŸÖÿ±ÿßÿ±Ÿäÿ©');
            } else if (error.code === 'unimplemented') {
                console.warn('ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ ŸÑÿß ŸäÿØÿπŸÖ ÿßŸÑÿßÿ≥ÿ™ŸÖÿ±ÿßÿ±Ÿäÿ©');
            }
        });

        console.log('ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿ¨ŸÖŸäÿπ Ÿàÿ∏ÿßÿ¶ŸÅ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ÿ®ŸÜÿ¨ÿßÿ≠');
    </script>
</body>
</html>
