<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ØªØªØ¨Ø¹ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

  <!-- Leaflet + OpenTopoMap -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Ø®Ø·ÙˆØ· Ùˆ Ø³ØªØ§ÙŠÙ„ -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(135deg, #56ccf2, #2f80ed);
      color: white;
      text-align: center;
    }

    h1 {
      margin: 20px 0;
      font-size: 24px;
    }

    .container {
      padding: 20px;
    }

    button {
      padding: 12px 24px;
      font-size: 16px;
      margin: 10px;
      border: none;
      border-radius: 30px;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      backdrop-filter: blur(10px);
      cursor: pointer;
      transition: 0.3s;
    }

    button:hover {
      background: rgba(255, 255, 255, 0.4);
    }

    select {
      padding: 10px;
      margin: 10px;
      border-radius: 10px;
      border: none;
    }

    #map {
      height: 400px;
      width: 100%;
      border-radius: 20px;
      margin-top: 20px;
    }

    @media (max-width: 600px) {
      h1 { font-size: 20px; }
      button { width: 90%; }
      #map { height: 300px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“ ØªØªØ¨Ø¹ Ø£ÙØ±Ø§Ø¯ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</h1>
    <p>Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Google</p>
    <button onclick="signIn()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Google</button>

    <div id="roleSelect" style="display:none;">
      <h3>Ø§Ø®ØªØ± Ø¯ÙˆØ±Ùƒ:</h3>
      <button onclick="setRole('parent')">ÙˆÙ„ÙŠ Ø£Ù…Ø± ğŸ‘¨â€ğŸ‘§</button>
      <button onclick="setRole('child')">Ø·ÙÙ„ ğŸ§’</button>
    </div>

    <div id="mapSection" style="display:none;">
      <h3 id="mapTitle"></h3>
      <select id="childList" onchange="focusOnChild()" style="display:none;"></select>
      <div id="map"></div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCwuWnFl3cGetmrNlWxcU5NT_mHQQzkEqo",
      authDomain: "familytracker-77ec8.firebaseapp.com",
      databaseURL: "https://familytracker-77ec8-default-rtdb.firebaseio.com",
      projectId: "familytracker-77ec8",
      storageBucket: "familytracker-77ec8.appspot.com",
      messagingSenderId: "527698679661",
      appId: "1:527698679661:web:af62a9327797646c3c2c64"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let currentUser;
    let map;
    let markers = {};
    let role = "";

    function signIn() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider)
        .then((result) => {
          currentUser = result.user;
          document.querySelector("#roleSelect").style.display = "block";
        })
        .catch((error) => {
          alert("ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: " + error.message);
        });
    }

    function setRole(selectedRole) {
      role = selectedRole;
      document.querySelector("#roleSelect").style.display = "none";

      if (role === 'child') {
        startChildTracking();
      } else if (role === 'parent') {
        showParentMap();
      }
    }

    function startChildTracking() {
      if (navigator.geolocation) {
        navigator.geolocation.watchPosition((position) => {
          const { latitude, longitude } = position.coords;
          db.ref("children/" + currentUser.uid).set({
            name: currentUser.displayName,
            lat: latitude,
            lng: longitude
          });
        });
      } else {
        alert("Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­");
      }

      document.querySelector("#mapTitle").innerText = "Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ";
      document.querySelector("#mapSection").style.display = "block";
      initMap();
    }

    function showParentMap() {
      document.querySelector("#mapTitle").innerText = "Ø£Ù…Ø§ÙƒÙ† Ø£Ø¨Ù†Ø§Ø¦Ùƒ";
      document.querySelector("#mapSection").style.display = "block";
      document.querySelector("#childList").style.display = "inline";

      initMap();

      db.ref("children").on("value", (snapshot) => {
        const children = snapshot.val();
        const childList = document.getElementById("childList");
        childList.innerHTML = "";

        for (let uid in children) {
          const child = children[uid];
          if (!markers[uid]) {
            const marker = L.marker([child.lat, child.lng]).addTo(map).bindPopup(child.name);
            markers[uid] = marker;
          } else {
            markers[uid].setLatLng([child.lat, child.lng]);
          }

          const option = document.createElement("option");
          option.value = uid;
          option.text = child.name;
          childList.appendChild(option);
        }
      });
    }

    function initMap() {
      if (map) return;
      map = L.map('map').setView([36.75, 3.06], 6); // Ø§Ù„Ø¬Ø²Ø§Ø¦Ø± Ø§Ù„Ø¹Ø§ØµÙ…Ø© ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹

      // OpenTopoMap tiles
      L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
        maxZoom: 17,
        attribution: 'Map data: &copy; OpenStreetMap contributors | Style: OpenTopoMap'
      }).addTo(map);
    }

    function focusOnChild() {
      const uid = document.getElementById("childList").value;
      const marker = markers[uid];
      if (marker) {
        map.setView(marker.getLatLng(), 15);
        marker.openPopup();
      }
    }
  </script>
</body>
</html>

